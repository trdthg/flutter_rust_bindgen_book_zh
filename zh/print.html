<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>flutter_rust_bridge</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">ä»‹ç»</a></li><li class="chapter-item expanded affix "><li class="part-title">Part I: æ ¸å¿ƒ</li><li class="chapter-item expanded "><a href="quickstart.html"><strong aria-hidden="true">1.</strong> ğŸ§­ å¿«é€Ÿå¼€å§‹</a></li><li class="chapter-item expanded "><a href="tutorial_with_flutter.html"><strong aria-hidden="true">2.</strong> ğŸ“š æ•™ç¨‹ï¼šä¸€ä¸ª Flutter å’Œ Rust æ„å»ºçš„ app</a></li><li class="chapter-item expanded "><a href="feature.html"><strong aria-hidden="true">3.</strong> ğŸ¼ ç‰¹æ€§</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="feature/lang.html"><strong aria-hidden="true">3.1.</strong> è¯­è¨€è½¬æ¢</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="feature/lang_simple.html"><strong aria-hidden="true">3.1.1.</strong> å¯¹åº”å…³ç³»æ€»è§ˆ</a></li><li class="chapter-item expanded "><a href="feature/lang_vec.html"><strong aria-hidden="true">3.1.2.</strong> Vec å’Œ æ•°ç»„</a></li><li class="chapter-item expanded "><a href="feature/lang_struct.html"><strong aria-hidden="true">3.1.3.</strong> ç»“æ„ä½“</a></li><li class="chapter-item expanded "><a href="feature/lang_enum.html"><strong aria-hidden="true">3.1.4.</strong> æšä¸¾</a></li><li class="chapter-item expanded "><a href="feature/lang_external.html"><strong aria-hidden="true">3.1.5.</strong> å¤–éƒ¨ç±»å‹</a></li><li class="chapter-item expanded "><a href="feature/lang_option.html"><strong aria-hidden="true">3.1.6.</strong> Option</a></li><li class="chapter-item expanded "><a href="feature/lang_methods.html"><strong aria-hidden="true">3.1.7.</strong> æ–¹æ³•</a></li><li class="chapter-item expanded "><a href="feature/lang_return_types.html"><strong aria-hidden="true">3.1.8.</strong> è¿”å›å€¼ç±»å‹</a></li></ol></li><li class="chapter-item expanded "><a href="feature/zero_copy.html"><strong aria-hidden="true">3.2.</strong> é›¶æ‹·è´</a></li><li class="chapter-item expanded "><a href="feature/stream.html"><strong aria-hidden="true">3.3.</strong> æµ / è¿­ä»£å™¨</a></li><li class="chapter-item expanded "><a href="feature/async_dart.html"><strong aria-hidden="true">3.4.</strong> Dart å¼‚æ­¥</a></li><li class="chapter-item expanded "><a href="feature/sync_dart.html"><strong aria-hidden="true">3.5.</strong> Dart åŒæ­¥</a></li><li class="chapter-item expanded "><a href="feature/concurrency.html"><strong aria-hidden="true">3.6.</strong> å¹¶å‘</a></li><li class="chapter-item expanded "><a href="feature/handler.html"><strong aria-hidden="true">3.7.</strong> Handler</a></li><li class="chapter-item expanded "><a href="feature/init.html"><strong aria-hidden="true">3.8.</strong> åˆå§‹åŒ–</a></li><li class="chapter-item expanded "><a href="feature/async_rust.html"><strong aria-hidden="true">3.9.</strong> Rust å¼‚æ­¥</a></li><li class="chapter-item expanded "><a href="feature/multiple_files.html"><strong aria-hidden="true">3.10.</strong> å¤šæ–‡ä»¶</a></li><li class="chapter-item expanded "><a href="feature/build_rs.html"><strong aria-hidden="true">3.11.</strong> åœ¨ build.rs ä¸­è¿è¡Œ</a></li><li class="chapter-item expanded "><a href="feature/cancelable_task.html"><strong aria-hidden="true">3.12.</strong> å¯å–æ¶ˆçš„ä»»åŠ¡</a></li><li class="chapter-item expanded "><a href="feature/object_pool.html"><strong aria-hidden="true">3.13.</strong> å¯¹è±¡æ± </a></li><li class="chapter-item expanded "><a href="feature/misc.html"><strong aria-hidden="true">3.14.</strong> æ‚é¡¹</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Part II: ç”¨æˆ·æŒ‡å—</li><li class="chapter-item expanded "><a href="template.html"><strong aria-hidden="true">4.</strong> ä»æ¨¡æ¿åˆ›å»º</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="template/setup.html"><strong aria-hidden="true">4.1.</strong> åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="template/setup_android.html"><strong aria-hidden="true">4.1.1.</strong> å®‰å“è®¾ç½®</a></li><li class="chapter-item expanded "><a href="template/setup_ios.html"><strong aria-hidden="true">4.1.2.</strong> IOS è®¾ç½®</a></li><li class="chapter-item expanded "><a href="template/setup_web.html"><strong aria-hidden="true">4.1.3.</strong> Web è®¾ç½®</a></li><li class="chapter-item expanded "><a href="template/setup_desktop.html"><strong aria-hidden="true">4.1.4.</strong> Windows å’Œ Linux</a></li><li class="chapter-item expanded "><a href="template/setup_others.html"><strong aria-hidden="true">4.1.5.</strong> å…¶ä»–å¹³å°</a></li></ol></li><li class="chapter-item expanded "><a href="template/tour.html"><strong aria-hidden="true">4.2.</strong> æ¨¡æ¿ä¹‹æ—…</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="template/tour_api.html"><strong aria-hidden="true">4.2.1.</strong> native/src/api.rs</a></li><li class="chapter-item expanded "><a href="template/tour_gradle.html"><strong aria-hidden="true">4.2.2.</strong> android/app/build.gradle</a></li><li class="chapter-item expanded "><a href="template/tour_native_proj.html"><strong aria-hidden="true">4.2.3.</strong> native/native.xcodeproj</a></li><li class="chapter-item expanded "><a href="template/tour_justfile.html"><strong aria-hidden="true">4.2.4.</strong> justfile</a></li><li class="chapter-item expanded "><a href="template/tour_cmake.html"><strong aria-hidden="true">4.2.5.</strong> rust.cmake</a></li></ol></li><li class="chapter-item expanded "><a href="template/generate.html"><strong aria-hidden="true">4.3.</strong> ä»£ç ç”Ÿæˆ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="template/generate_install.html"><strong aria-hidden="true">4.3.1.</strong> å®‰è£… codegen</a></li><li class="chapter-item expanded "><a href="template/generate_adding_code.html"><strong aria-hidden="true">4.3.2.</strong> æ·»åŠ ä»£ç </a></li><li class="chapter-item expanded "><a href="template/generate_build_runner.html"><strong aria-hidden="true">4.3.3.</strong> ä½¿ç”¨ build_runner</a></li><li class="chapter-item expanded "><a href="template/generate_finish.html"><strong aria-hidden="true">4.3.4.</strong> æ”¶å°¾å·¥ä½œ</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="integrate.html"><strong aria-hidden="true">5.</strong> é›†æˆåˆ°ç°æœ‰é¡¹ç›®</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="integrate/new_crate.html"><strong aria-hidden="true">5.1.</strong> åˆ›å»ºä¸€ä¸ªæ–° crate</a></li><li class="chapter-item expanded "><a href="integrate/deps.html"><strong aria-hidden="true">5.2.</strong> å®‰è£…ä¾èµ–</a></li><li class="chapter-item expanded "><a href="integrate/android.html"><strong aria-hidden="true">5.3.</strong> ä¸ Android é›†æˆ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="integrate/android_tasks.html"><strong aria-hidden="true">5.3.1.</strong> Hooking onto tasks</a></li><li class="chapter-item expanded "><a href="integrate/android_cmake.html"><strong aria-hidden="true">5.3.2.</strong> åœ¨ Gradle ä¸­ä½¿ç”¨ CMake</a></li></ol></li><li class="chapter-item expanded "><a href="integrate/ios.html"><strong aria-hidden="true">5.4.</strong> ä¸ iOS/MacOS é›†æˆ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="integrate/ios_proj.html"><strong aria-hidden="true">5.4.1.</strong> åˆ›å»º Rust é¡¹ç›®</a></li><li class="chapter-item expanded "><a href="integrate/ios_linking.html"><strong aria-hidden="true">5.4.2.</strong> é“¾æ¥è¯¥é¡¹ç›®</a></li><li class="chapter-item expanded "><a href="integrate/ios_gen.html"><strong aria-hidden="true">5.4.3.</strong> ç”Ÿæˆä»£ç ç»‘å®š</a></li><li class="chapter-item expanded "><a href="integrate/ios_headers.html"><strong aria-hidden="true">5.4.4.</strong> ä½¿ç”¨å‡å¤´æ–‡ä»¶</a></li></ol></li><li class="chapter-item expanded "><a href="integrate/desktop.html"><strong aria-hidden="true">5.5.</strong> ä¸ Windows and Linux é›†æˆ</a></li><li class="chapter-item expanded "><a href="integrate/web.html"><strong aria-hidden="true">5.6.</strong> ä¸ Web é›†æˆ</a></li><li class="chapter-item expanded "><a href="integrate/usage.html"><strong aria-hidden="true">5.7.</strong> ä½¿ç”¨åŠ¨æ€è¿æ¥åº“</a></li><li class="chapter-item expanded "><a href="integrate/finish.html"><strong aria-hidden="true">5.8.</strong> æ”¶å°¾å·¥ä½œ</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Part III: è´¡çŒ®æŒ‡å—</li><li class="chapter-item expanded "><a href="contributing/overview.html"><strong aria-hidden="true">6.</strong> æ€»è§ˆ</a></li><li class="chapter-item expanded "><a href="contributing/design.html"><strong aria-hidden="true">7.</strong> æ•´ä½“è®¾è®¡</a></li><li class="chapter-item expanded "><a href="contributing/appendix.html"><strong aria-hidden="true">8.</strong> é™„å½•</a></li><li class="chapter-item expanded affix "><li class="part-title">Part IV: æ›´å¤šæ–‡æ¡£</li><li class="chapter-item expanded "><a href="tutorial_pure_dart.html"><strong aria-hidden="true">9.</strong> æ•™ç¨‹ï¼šPure Dart</a></li><li class="chapter-item expanded "><a href="safety.html"><strong aria-hidden="true">10.</strong> å®‰å…¨é—®é¢˜</a></li><li class="chapter-item expanded "><a href="troubleshooting.html"><strong aria-hidden="true">11.</strong> ç–‘éš¾è§£ç­”</a></li><li class="chapter-item expanded "><a href="command_line.html"><strong aria-hidden="true">12.</strong> å‘½ä»¤è¡Œå‚æ•°</a></li><li class="chapter-item expanded "><a href="set_up_from_scratch.html"><strong aria-hidden="true">13.</strong> ä»é›¶å¼€å§‹è®¾ç½® Fluuter/Rust ç¯å¢ƒ</a></li><li class="chapter-item expanded "><a href="article.html"><strong aria-hidden="true">14.</strong> æ–‡ç« </a></li><li><ol class="section"><li class="chapter-item expanded "><a href="article/async_in_rust.html"><strong aria-hidden="true">14.1.</strong> Rust å¼‚æ­¥</a></li><li class="chapter-item expanded "><a href="article/generate_multiple_files.html"><strong aria-hidden="true">14.2.</strong> ç”Ÿæˆå¤šæ–‡ä»¶</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">flutter_rust_bridge</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="flutter_rust_bridge-ç”¨äº-flutter-å’Œ-rust-çš„é«˜çº§å†…å­˜å®‰å…¨ç»‘å®šç”Ÿæˆå™¨"><a class="header" href="#flutter_rust_bridge-ç”¨äº-flutter-å’Œ-rust-çš„é«˜çº§å†…å­˜å®‰å…¨ç»‘å®šç”Ÿæˆå™¨"><a href="https://github.com/fzyzcjy/flutter_rust_bridge">flutter_rust_bridge</a>: ç”¨äº Flutter å’Œ Rust çš„é«˜çº§å†…å­˜å®‰å…¨ç»‘å®šç”Ÿæˆå™¨</a></h1>
<p><em>High-level memory-safe binding generator for Flutter/Dart &lt;-&gt; Rust</em></p>
<p><a href="https://crates.io/crates/flutter_rust_bridge"><img src="https://img.shields.io/crates/v/flutter_rust_bridge.svg" alt="Rust Package" /></a>
<a href="https://pub.dev/packages/flutter_rust_bridge"><img src="https://img.shields.io/pub/v/flutter_rust_bridge.svg" alt="Flutter Package" /></a>
<a href="https://github.com/fzyzcjy/flutter_rust_bridge"><img src="https://img.shields.io/github/stars/fzyzcjy/flutter_rust_bridge" alt="Stars" /></a>
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/actions/workflows/ci.yaml"><img src="https://github.com/fzyzcjy/flutter_rust_bridge/actions/workflows/ci.yaml/badge.svg" alt="CI" /></a>
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/actions/workflows/post_release.yaml"><img src="https://github.com/fzyzcjy/flutter_rust_bridge/actions/workflows/post_release.yaml/badge.svg" alt="Example" /></a>
<a href="https://app.codacy.com/gh/fzyzcjy/flutter_rust_bridge?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=fzyzcjy/flutter_rust_bridge&amp;utm_campaign=Badge_Grade_Settings"><img src="https://api.codacy.com/project/badge/Grade/6afbdad19e7245adbf9e9771777be3d7" alt="Codacy Badge" /></a></p>
<p><img src="https://github.com/fzyzcjy/flutter_rust_bridge/raw/master/book/logo.png" alt="Logo" /></p>
<p>æƒ³æŠŠ <a href="https://flutter.dev/">Flutter</a>ï¼ˆä¸€ä¸ªè·¨å¹³å°çš„çƒ­é‡è½½å¿«é€Ÿå¼€å‘ UI å·¥å…·åŒ…ï¼‰å’Œ
<a href="https://www.rust-lang.org/">Rust</a>ï¼ˆä¸€ç§ä½¿æ¯ä¸ªäººéƒ½èƒ½æ„å»ºå¯é å’Œé«˜æ•ˆè½¯ä»¶çš„è¯­è¨€ï¼‰çš„ä¼˜ç‚¹ç»“åˆèµ·æ¥ï¼Ÿå®ƒæ¥äº†ï¼</p>
<h2 id="-ä¼˜åŠ¿"><a class="header" href="#-ä¼˜åŠ¿">ğŸš€ ä¼˜åŠ¿</a></h2>
<ul>
<li><strong>å†…å­˜å®‰å…¨</strong>: å®Œå…¨ä¸ç”¨è€ƒè™‘ malloc å’Œ free.</li>
<li><strong>ç‰¹æ€§ä¸°å¯Œ</strong>:æ”¯æŒç±»ä¼¼ Rust çš„æšä¸¾ï¼Œæ ¹æ®å¹³å°è‡ªåŠ¨ä¼˜åŒ–çš„ <code>Vec</code>, å¯ä»¥é€’å½’çš„ <code>struct</code>, å¤§æ•°ç»„é›¶æ‹·è´ï¼Œ<code>æµæ•°æ®</code> (è¿­ä»£å™¨)
æŠ½è±¡ï¼Œé”™è¯¯å¤„ç† (<code>Result</code>), å¯å–æ¶ˆçš„ä»»åŠ¡ï¼Œå¹¶å‘æ§åˆ¶ï¼Œç­‰ã€‚åœ¨
<a href="https://fzyzcjy.github.io/flutter_rust_bridge/feature.html">è¿™é‡Œ</a> æŸ¥çœ‹æ‰€æœ‰ç‰¹æ€§ã€‚</li>
<li><strong>å¼‚æ­¥æ”¯æŒ</strong>: Rust ä»£ç æ°¸è¿œä¸ä¼šé˜»å¡ Flutter. åœ¨ Flutter çš„ä¸»éš”ç¦»åŒº <code>main isolate (æˆ–è€…è¯´ thread)</code>
ä¸­è‡ªç„¶çš„è°ƒç”¨ Rust ä»£ç ã€‚</li>
<li><strong>è½»é‡çº§</strong>: è¿™ä¸æ˜¯ä¸€ä¸ªå…¨é¢çš„æ¡†æ¶ï¼Œä½ å¯ä»¥è‡ªç”±çš„ä½¿ç”¨ä½ å–œæ¬¢çš„ Flutter å’Œ Rust ç¬¬ä¸‰æ–¹åº“ã€‚<sub>ä¾‹å¦‚ï¼Œä½¿ç”¨ Flutter åº“ï¼ˆæ¯”å¦‚
MobXï¼‰è¿›è¡ŒçŠ¶æ€ç®¡ç†æ›´åŠ ä¼˜é›…ç®€å•ï¼ˆç›¸æ¯”äºåœ¨ Rust ä¸­å®ç°ï¼‰; ä½¿ç”¨ Rust å®ç°ä¸€ä¸ªç…§ç‰‡å¤„ç†çš„ç®—æ³•æ›´åŠ å¿«é€Ÿå’Œå®‰å…¨ (ç›¸æ¯”äºåœ¨ Flutter
ä¸­å®ç°).</sub></li>
<li><strong>è·¨å¹³å°</strong>: æ”¯æŒ Android, iOS, Windows, Linux, MacOS
(<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/315">Web</a> coming soon)</li>
<li><strong>æ–¹ä¾¿ &amp; æ˜“äºä»£ç å®¡æŸ¥</strong>: è¿™ä¸ªåº“åªæ˜¯ç®€å•åœ°æ¨¡æ‹Ÿäº†äººç±»ç¼–å†™çš„æ¨¡æ¿ä»£ç ï¼Œä¸€ç‚¹ä¹Ÿä¸ç¥å¥‡ï¼å¦‚æœä½ æƒ³è®©è¯´æœä½ è‡ªå·±ï¼ˆæˆ–ä½ çš„å›¢é˜Ÿï¼‰ç›¸ä¿¡å®ƒæ˜¯å®‰å…¨çš„ï¼Œ
æ²¡æœ‰å¤šå°‘ä»£ç å¯çœ‹ã€‚ (<a href="https://fzyzcjy.github.io/flutter_rust_bridge/safety.html">æ›´å¤š</a>
safety concerns.)</li>
<li><strong>å¿«é€Ÿ</strong>: è¿™ä¸ªåº“åªåšäº†ä¸€ä¸ªæµ…å±‚æ¬¡çš„åŒ…è£…ï¼ˆå°½ç®¡åŠŸèƒ½ä¸°å¯Œï¼‰ï¼Œæ²¡æœ‰ pritobuf åºåˆ—åŒ–çš„å¼€é”€ï¼Œå› æ­¤é«˜æ€§èƒ½ã€‚(æ›´å¤šçš„
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/318#issuecomment-1034536815">benchmarks</a>
å³å°†åˆ°æ¥) <small>(æ‰”æ‰äº†åƒçº¿ç¨‹æ± è¿™æ ·çš„ç»„ä»¶ï¼Œä½¿å®ƒæ›´å¿«)</small></li>
<li><strong>ä¸çº¯ Dart å…¼å®¹:</strong> å°½ç®¡åå­—é‡ŒåŒ…å«äº† Rustï¼Œè¿™ä¸ªåº“ 100% å…¼å®¹
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/frb_example/pure_dart/README.md">Pure Dart</a></li>
</ul>
<h2 id="-ç”¨æˆ·æŒ‡å—"><a class="header" href="#-ç”¨æˆ·æŒ‡å—">ğŸ’¡ ç”¨æˆ·æŒ‡å—</a></h2>
<p>è¯·çœ‹ <a href="https://fzyzcjy.github.io/flutter_rust_bridge/">ç”¨æˆ·æŒ‡å—</a> for
<a href="https://fzyzcjy.github.io/flutter_rust_bridge/quickstart.html">show-me-the-code</a>,
<a href="https://fzyzcjy.github.io/flutter_rust_bridge/tutorial_with_flutter.html">æ•™ç¨‹</a>,
<a href="https://fzyzcjy.github.io/flutter_rust_bridge/feature.html">ç‰¹æ€§</a> and much more.</p>
<h2 id="-ps-æ–¹ä¾¿çš„-flutter-æµ‹è¯•"><a class="header" href="#-ps-æ–¹ä¾¿çš„-flutter-æµ‹è¯•">ğŸ“ P.S. æ–¹ä¾¿çš„ Flutter æµ‹è¯•</a></h2>
<p>å¦‚æœæ‚¨æƒ³åœ¨ Flutter
ä¸­æ–¹ä¾¿åœ°ç¼–å†™å’Œè°ƒè¯•æµ‹è¯•ï¼Œè¡Œä¸ºå†å²ã€æ—¶é—´å›æº¯ã€å±å¹•æˆªå›¾ã€å¿«é€Ÿé‡æ–°æ‰§è¡Œã€è§†é¢‘å½•åˆ¶ã€äº’åŠ¨æ¨¡å¼ç­‰åŠŸèƒ½ï¼Œè¿™é‡Œæœ‰æˆ‘çš„å¦ä¸€ä¸ªå¼€æºåº“ï¼š<a href="https://github.com/fzyzcjy/flutter_convenient_test">flutter_convenient_test</a>.</p>
<h2 id="-è´¡çŒ®è€…"><a class="header" href="#-è´¡çŒ®è€…">âœ¨ è´¡çŒ®è€…</a></h2>
<!-- ALL-CONTRIBUTORS-BADGE:START - Do not remove or modify this section -->
<p><a href="index.html#contributors-"><img src="https://img.shields.io/badge/all_contributors-29-orange.svg?style=flat-square" alt="All Contributors" /></a></p>
<!-- ALL-CONTRIBUTORS-BADGE:END -->
<p>Thanks goes to these wonderful people
(<a href="https://allcontributors.org/docs/en/emoji-key">emoji key</a> following
<a href="https://github.com/all-contributors/all-contributors">all-contributors</a>
specification):</p>
<!-- ALL-CONTRIBUTORS-LIST:START - Do not remove or modify this section -->
<!-- prettier-ignore-start -->
<!-- markdownlint-disable -->
<table>
  <tr>
    <td align="center"><a href="https://github.com/fzyzcjy"><img src="https://avatars.githubusercontent.com/u/5236035?v=4?s=100" width="100px;" alt=""/><br /><sub><b>fzyzcjy</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=fzyzcjy" title="Code">ğŸ’»</a> <a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=fzyzcjy" title="Documentation">ğŸ“–</a> <a href="index.html#example-fzyzcjy" title="Examples">ğŸ’¡</a> <a href="index.html#ideas-fzyzcjy" title="Ideas, Planning, & Feedback">ğŸ¤”</a> <a href="index.html#maintenance-fzyzcjy" title="Maintenance">ğŸš§</a></td>
    <td align="center"><a href="https://github.com/Desdaemon"><img src="https://avatars.githubusercontent.com/u/36768030?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Viet Dinh</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=Desdaemon" title="Code">ğŸ’»</a> <a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=Desdaemon" title="Tests">âš ï¸</a> <a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=Desdaemon" title="Documentation">ğŸ“–</a></td>
    <td align="center"><a href="https://github.com/SecondFlight"><img src="https://avatars.githubusercontent.com/u/6700184?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Joshua Wade</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=SecondFlight" title="Code">ğŸ’»</a></td>
    <td align="center"><a href="https://github.com/smw-wagnerma"><img src="https://avatars.githubusercontent.com/u/66412697?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Marcel</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=smw-wagnerma" title="Code">ğŸ’»</a></td>
    <td align="center"><a href="https://github.com/rustui"><img src="https://avatars.githubusercontent.com/u/90625190?v=4?s=100" width="100px;" alt=""/><br /><sub><b>rustui</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=rustui" title="Documentation">ğŸ“–</a></td>
    <td align="center"><a href="https://adventures.michaelfbryan.com/"><img src="https://avatars.githubusercontent.com/u/17380079?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Michael Bryan</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=Michael-F-Bryan" title="Code">ğŸ’»</a></td>
    <td align="center"><a href="https://bus710.net"><img src="https://avatars.githubusercontent.com/u/8920680?v=4?s=100" width="100px;" alt=""/><br /><sub><b>bus710</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=bus710" title="Documentation">ğŸ“–</a></td>
  </tr>
  <tr>
    <td align="center"><a href="https://scholar.google.com/citations?user=RbAto7EAAAAJ"><img src="https://avatars.githubusercontent.com/u/1213857?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Sebastian Urban</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=surban" title="Code">ğŸ’»</a></td>
    <td align="center"><a href="https://github.com/trobanga"><img src="https://avatars.githubusercontent.com/u/8888869?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Daniel</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=trobanga" title="Code">ğŸ’»</a></td>
    <td align="center"><a href="https://github.com/AlienKevin"><img src="https://avatars.githubusercontent.com/u/22850071?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Kevin Li</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=AlienKevin" title="Code">ğŸ’»</a> <a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=AlienKevin" title="Documentation">ğŸ“–</a></td>
    <td align="center"><a href="https://valeth.me"><img src="https://avatars.githubusercontent.com/u/3198362?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Patrick Auernig</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=valeth" title="Code">ğŸ’»</a></td>
    <td align="center"><a href="https://antonok.com"><img src="https://avatars.githubusercontent.com/u/22821309?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Anton Lazarev</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=antonok-edm" title="Code">ğŸ’»</a></td>
    <td align="center"><a href="https://github.com/Unoqwy"><img src="https://avatars.githubusercontent.com/u/65187632?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Unoqwy</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=Unoqwy" title="Code">ğŸ’»</a></td>
    <td align="center"><a href="https://feber.dev"><img src="https://avatars.githubusercontent.com/u/1727318?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Febrian Setianto</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=feber" title="Documentation">ğŸ“–</a></td>
  </tr>
  <tr>
    <td align="center"><a href="https://github.com/Syndim"><img src="https://avatars.githubusercontent.com/u/835035?v=4?s=100" width="100px;" alt=""/><br /><sub><b>syndim</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=syndim" title="Code">ğŸ’»</a></td>
    <td align="center"><a href="https://github.com/sagudev"><img src="https://avatars.githubusercontent.com/u/16504129?v=4?s=100" width="100px;" alt=""/><br /><sub><b>sagu</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=sagudev" title="Code">ğŸ’»</a> <a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=sagudev" title="Documentation">ğŸ“–</a></td>
    <td align="center"><a href="https://bandism.net/"><img src="https://avatars.githubusercontent.com/u/22633385?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Ikko Ashimine</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=eltociear" title="Documentation">ğŸ“–</a></td>
    <td align="center"><a href="https://github.com/alanlzhang"><img src="https://avatars.githubusercontent.com/u/59032810?v=4?s=100" width="100px;" alt=""/><br /><sub><b>alanlzhang</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=alanlzhang" title="Code">ğŸ’»</a> <a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=alanlzhang" title="Documentation">ğŸ“–</a></td>
    <td align="center"><a href="https://github.com/sccheruku"><img src="https://avatars.githubusercontent.com/u/5800058?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Sai Chaitanya</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=sccheruku" title="Code">ğŸ’»</a></td>
    <td align="center"><a href="https://ares.zone (å›½å†…)"><img src="https://avatars.githubusercontent.com/u/40336192?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Ares Andrew</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=TENX-S" title="Documentation">ğŸ“–</a></td>
    <td align="center"><a href="https://github.com/raphaelrobert"><img src="https://avatars.githubusercontent.com/u/9882746?v=4?s=100" width="100px;" alt=""/><br /><sub><b>raphaelrobert</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=raphaelrobert" title="Documentation">ğŸ“–</a></td>
  </tr>
  <tr>
    <td align="center"><a href="https://github.com/thomas725"><img src="https://avatars.githubusercontent.com/u/68635351?v=4?s=100" width="100px;" alt=""/><br /><sub><b>thomas725</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=thomas725" title="Documentation">ğŸ“–</a></td>
    <td align="center"><a href="https://dport.me"><img src="https://avatars.githubusercontent.com/u/7816187?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Daniel Porteous (dport)</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=banool" title="Documentation">ğŸ“–</a></td>
    <td align="center"><a href="https://github.com/w-ensink"><img src="https://avatars.githubusercontent.com/u/46427708?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Wouter Ensink</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=w-ensink" title="Documentation">ğŸ“–</a></td>
    <td align="center"><a href="https://github.com/dbsxdbsx"><img src="https://avatars.githubusercontent.com/u/17372655?v=4?s=100" width="100px;" alt=""/><br /><sub><b>è€è‘£</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=dbsxdbsx" title="Code">ğŸ’»</a> <a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=dbsxdbsx" title="Documentation">ğŸ“–</a></td>
    <td align="center"><a href="https://github.com/lattice0"><img src="https://avatars.githubusercontent.com/u/6632321?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Lattice 0</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=lattice0" title="Code">ğŸ’»</a> <a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=lattice0" title="Documentation">ğŸ“–</a></td>
    <td align="center"><a href="https://soeur.dev"><img src="https://avatars.githubusercontent.com/u/26034975?v=4?s=100" width="100px;" alt=""/><br /><sub><b>orange soeur</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=juzi5201314" title="Documentation">ğŸ“–</a></td>
    <td align="center"><a href="https://github.com/Roms1383"><img src="https://avatars.githubusercontent.com/u/21016014?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Rom's</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=Roms1383" title="Code">ğŸ’»</a> <a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=Roms1383" title="Documentation">ğŸ“–</a></td>
  </tr>
  <tr>
    <td align="center"><a href="https://github.com/Cupnfish"><img src="https://avatars.githubusercontent.com/u/40173605?v=4?s=100" width="100px;" alt=""/><br /><sub><b>Cupnfish</b></sub></a><br /><a href="https://github.com/fzyzcjy/flutter_rust_bridge/commits?author=Cupnfish" title="Code">ğŸ’»</a></td>
  </tr>
</table>
<!-- markdownlint-restore -->
<!-- prettier-ignore-end -->
<!-- ALL-CONTRIBUTORS-LIST:END -->
<p>More specifically, thanks for all these contributions:</p>
<ul>
<li><a href="https://github.com/Desdaemon">Desdaemon</a>: Support not only simple enums but
also enums with fields which gets translated to native enum or freezed class
in Dart. Support the Option type as nullable types in Dart. Support Vec of
Strings type. Support comments in code. Add marker attributes for future
usage. Add Linux and Windows support for with-flutter example, and make CI
works for that. Avoid parameter collision. Overhaul the documentation and add
several chapters to demonstrate configuring a Flutter+Rust project in all five
platforms. Refactor command module. Precompiled binary CI workflow. Fix bugs.</li>
<li><a href="https://github.com/SecondFlight">SecondFlight</a>: Allow structs and enums to be
imported from other files within the crate by creating source graph.
Auto-create relavent dir. Fix <code>store_dart_post_cobject</code> error with ffigen 6.0.</li>
<li><a href="https://github.com/Unoqwy">Unoqwy</a>: Add struct mirrors, such that types in
the external crates can be imported and used without redefining and copying.</li>
<li><a href="https://github.com/antonok-edm">antonok-edm</a>: Avoid converting syn types to
strings before parsing to improve code and be more robust.</li>
<li><a href="https://github.com/lattice0">lattice0</a>: Support methods, such that Rust
struct impls can be converted to Dart class methods. StreamSink at any
argument.</li>
<li><a href="https://github.com/sagudev">sagudev</a>: Make code generator a <code>lib</code>. Add error
types. Depend on <code>cbindgen</code>. Fix LLVM paths. Update deps. Fix CI errors.</li>
<li><a href="https://github.com/surban">surban</a>: Support unit return type. Skip
unresolvable modules. Ignore prefer_const_constructors. Non-final Dart fields.</li>
<li><a href="https://github.com/trobanga">trobanga</a>: Add support for <code>[T;N]</code> structs. Add
<code>usize</code> support. Add a cmd argument. Separate dart tests.</li>
<li><a href="https://github.com/Roms1383">Roms1383</a>: Fix build_runner calling bug. Remove
global <code>ffigen</code> dependency. Improve version check. Fix enum name-variant
conflicts. Update CI. Code cleanup.</li>
<li><a href="https://github.com/dbsxdbsx">dbsxdbsx</a>: Allow generating multiple Rust and
Dart files.</li>
<li><a href="https://github.com/AlienKevin">AlienKevin</a>: Add flutter example for macOS.
Add doc for Android NDK bug.</li>
<li><a href="https://github.com/alanlzhang">alanlzhang</a>: Add generation for Dart metadata.</li>
<li><a href="https://github.com/efc-mw">efc-mw</a>: Improve Windows encoding handling.</li>
<li><a href="https://github.com/valeth">valeth</a>: Rename callFfi's port.</li>
<li><a href="https://github.com/Cupnfish">Cupnfish</a>: Allow multi mirror.</li>
<li><a href="https://github.com/sccheruku">sccheruku</a>: Prevent double-generating utility.</li>
<li><a href="https://github.com/w-ensink">w-ensink</a>: Improve doc. Fix CI. Refactor. Add
tests.</li>
<li><a href="https://github.com/Michael-F-Bryan">Michael-F-Bryan</a>: Detect broken bindings.</li>
<li><a href="https://github.com/bus710">bus710</a>: Add a case in troubleshooting.</li>
<li><a href="https://github.com/Syndim">Syndim</a>: Add a bracket to box.</li>
<li><a href="https://github.com/banool">banool</a>: Fix symbol-stripping doc.</li>
<li><a href="https://github.com/TENX-S">TENX-S</a>: Improve doc. Reproduce a bug.</li>
<li><a href="https://github.com/raphaelrobert">raphaelrobert</a>: Remove oudated doc.</li>
<li><a href="https://github.com/thomas725">thomas725</a>: Improve doc.</li>
<li><a href="https://github.com/juzi5201314">juzi5201314</a>: Improve doc.</li>
<li><a href="https://github.com/feber">feber</a>: Fix doc link.</li>
<li><a href="https://github.com/rustui">rustui</a>: Fix a typo.</li>
<li><a href="https://github.com/eltociear">eltociear</a>: Fix a typo.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¿«é€Ÿå¼€å§‹"><a class="header" href="#å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹</a></h1>
<p>åƒå¹³å¸¸ä¸€æ ·ç¼–å†™ä½ çš„ Rust å‡½æ•°å’Œç±»å‹å®šä¹‰ã€‚</p>
<pre><code class="language-rust ignore">// ä¸€ä¸ªæ™®é€šçš„ Rust å‡½æ•° ...
pub fn draw_tree(root: TreeNode, mode: DrawMode) -&gt; Result&lt;Vec&lt;u8&gt;&gt; { /* ... */ }

// ... å’Œä¸€äº›ä¸°å¯Œçš„ç±»å‹
pub struct TreeNode { pub value: String, pub children: Vec&lt;MyTreeNode&gt; }
pub enum DrawMode { Colorful {palette: String}, Grayscale }
</code></pre>
<p>å®‰è£…ä»£ç ç”Ÿæˆå™¨ <code>flutter_rust_bridge_codegen</code>:</p>
<pre><code class="language-bash">cargo install flutter_rust_bridge_codegen
# æˆ–è€…ä½¿ç”¨ cargo-binstall
cargo binstall flutter_rust_bridge_codegen
# æˆ–è€…ä½¿ç”¨ scoop (Windows)
scoop bucket add frb https://github.com/Desdaemon/scoop-repo
scoop install flutter_rust_bridge_codegen
# æˆ–è€…ä½¿ç”¨ Homebrew
brew install desdaemon/repo/flutter_rust_bridge_codegen
</code></pre>
<p><small>(æ„Ÿè°¢ @Desdaemon å°†è„šæœ¬å‘å¸ƒåˆ° brew/scoop)</small></p>
<p>æ¥ç€è¿è¡Œä»£ç ç”Ÿæˆã€‚</p>
<p><small>æ³¨æ„ï¼šå®‰è£…éœ€è¦ä¸€äº›æ­¥éª¤ã€‚ä½ å¯ä»¥æŸ¥çœ‹ <a href="tutorial_with_flutter.html">æ•™ç¨‹</a>, <a href="template.html">ä»æ¨¡æ¿åˆ›å»ºé¡¹ç›®</a>
æˆ–è€… <a href="integrate.html">ä¸ç°æœ‰é¡¹ç›®é›†æˆ</a> ç­‰ç« èŠ‚è·å–æ›´å¤šä¿¡æ¯.</small></p>
<pre><code class="language-bash">flutter_rust_bridge_codegen --rust-input path/to/api.rs \
                            --dart-output path/to/bridge_generated.dart
</code></pre>
<p>ç»‘å®šä»£ç ç”Ÿæˆä¹‹åï¼Œä½ å¯ä»¥åœ¨ Flutter/Dart ä¸­æ— ç¼ä½¿ç”¨ï¼š</p>
<pre><code class="language-dart">api.drawTree(TreeNode(value: &quot;root&quot;, ...), Colorful(palette: &quot;viridis&quot;));
</code></pre>
<blockquote>
<p>è¯‘è€…æ³¨ï¼šå¦‚æœä½ åœ¨ä»£ç ç”Ÿæˆæ—¶é‡åˆ°äº†è¿™ä¸ªé”™è¯¯ <code>fatal error: 'stdbool.h' file not found</code>
å¯ä»¥å°è¯•é˜…è¯»ï¼š<a href="https://github.com/dart-lang/ffigen/issues/257#issuecomment-1061788936">dart-lang/ffigen/issues/257</a></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ•™ç¨‹ä¸€ä¸ª-flutter-å’Œ-rust-æ„å»ºçš„-app"><a class="header" href="#æ•™ç¨‹ä¸€ä¸ª-flutter-å’Œ-rust-æ„å»ºçš„-app">æ•™ç¨‹ï¼šä¸€ä¸ª Flutter å’Œ Rust æ„å»ºçš„ app</a></h1>
<p>åœ¨è¿™ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ç»˜åˆ¶ä¸€ä¸ª
<a href="https://en.wikipedia.org/wiki/Mandelbrot_set">æ›¼å¾·åšé›†åˆï¼ˆè‹±è¯­ï¼šMandelbrot setï¼Œæˆ–è¯‘ä¸ºæ›¼å¾·å¸ƒæ´›ç‰¹å¤æ•°é›†åˆï¼‰</a>ï¼ˆä¸€ä¸ªè‘—åçš„åˆ†å½¢ï¼‰ã€‚è¿™ä¸ªå›¾ç‰‡ä¼šç”±
Rust ç®—æ³•ç”Ÿæˆï¼Œå¹¶åœ¨ Flutter ä¸­ç»˜åˆ¶ï¼ŒRust å’Œ Flutter ä¼šé€šè¿‡è¿™ä¸ªåº“é€šä¿¡ã€‚</p>
<!-- markdownlint-disable MD033 -->
<details>
<summary>(ç‚¹å‡»æŸ¥çœ‹ï¼šMandelbrot set æ˜¯ä»€ä¹ˆï¼š)</summary>
<p>æ›¼å¾·åšé›†åˆæ˜¯ç”±å¤æ•° <code>c</code> ç»„æˆçš„ç‚¹çš„é›†åˆï¼Œå¯¹äºè¿™äº›ç‚¹ï¼Œå‡æ»¡è¶³å‡½æ•°ï¼š
<code>f_c(z) = z^{2} + c</code>ï¼Œä¸åŒçš„å‚æ•°å¯èƒ½ä½¿åºåˆ—çš„ç»å¯¹å€¼é€æ¸å‘æ•£åˆ°æ— é™å¤§ï¼Œä¹Ÿå¯èƒ½æ”¶æ•›åœ¨æœ‰é™çš„åŒºåŸŸå†…ã€‚æ›¼å¾·åšé›†åˆ M
å°±æ˜¯ä½¿åºåˆ—ä¸å»¶ä¼¸è‡³æ— é™å¤§çš„æ‰€æœ‰å¤æ•° c çš„é›†åˆã€‚æ›¼å¾·å‹ƒç½—é›†çš„å›¾åƒæ˜¾ç¤ºäº†ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„ã€æ— é™å¤æ‚çš„è¾¹ç•Œ
éšç€æ”¾å¤§å€æ•°çš„å¢åŠ ï¼Œé€æ¸æ˜¾ç¤ºå‡ºè¶Šæ¥è¶Šç»†çš„é€’å½’ç»†èŠ‚ã€‚æ”¾å¤§å€æ•°æ—¶ï¼Œæ˜¾ç¤ºå‡ºè¶Šæ¥è¶Šç»†çš„é€’å½’ç»†èŠ‚ã€‚</p>
<p align="center">
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Mandelbrot_sequence_new.gif/220px-Mandelbrot_sequence_new.gif">
</p>
<p>å›¾ç‰‡æ¥æºï¼šç»´åŸºç™¾ç§‘</p>
</details>
<h2 id="è·å–æºä»£ç "><a class="header" href="#è·å–æºä»£ç ">è·å–æºä»£ç </a></h2>
<p><a href="https://flutter.dev/docs/get-started/install">å®‰è£… Flutter</a> (å¦‚æœä½ æƒ³æŠŠç¨‹åºè¿è¡Œåœ¨æ¡Œé¢ä¸Šï¼Œå¯ä»¥é€‰æ‹©æ·»åŠ 
<a href="https://flutter.dev/desktop">æ¡Œé¢æ”¯æŒ</a>),
<a href="https://www.rust-lang.org/learn/get-started">å®‰è£… Rust</a>, æ¥ç€å…‹éš†æ ·ä¾‹ä»£ç ï¼š</p>
<pre><code class="language-shell">git clone https://github.com/fzyzcjy/flutter_rust_bridge &amp;&amp; cd flutter_rust_bridge/frb_example/with_flutter
</code></pre>
<h2 id="å¯é€‰è¿è¡Œä»£ç ç”Ÿæˆå™¨"><a class="header" href="#å¯é€‰è¿è¡Œä»£ç ç”Ÿæˆå™¨">å¯é€‰ï¼šè¿è¡Œä»£ç ç”Ÿæˆå™¨</a></h2>
<p>è¿™ä¸€æ­¥æ˜¯å¯é€‰çš„ï¼Œå› ä¸ºæˆ‘å·²ç»åœ¨ <a href="./quickstart.html">å¿«é€Ÿå…¥é—¨</a> æ—¶ç”Ÿæˆäº†ç»‘å®šä»£ç ï¼Œå†æ¬¡è¿è¡Œä¹Ÿä¸ä¼šäº§ç”Ÿä»»ä½•æ”¹å˜ã€‚</p>
<p>ä¸€æ—¦ä½ ä¿®æ”¹äº† <code>api.rs</code>ï¼Œå°±éœ€è¦å†æ¬¡è¿è¡Œä»£ç ç”Ÿæˆã€‚ä»£ç ç”Ÿæˆå™¨éœ€è¦çš„ä¾èµ–å¯ä»¥åœ¨
<a href="integrate/deps.html">Installing dependencies</a> ç« èŠ‚æŸ¥çœ‹</p>
<h2 id="è¿è¡Œ-app"><a class="header" href="#è¿è¡Œ-app">è¿è¡Œ app</a></h2>
<h3 id="å‰è¨€å‘½ä»¤ç»†èŠ‚"><a class="header" href="#å‰è¨€å‘½ä»¤ç»†èŠ‚">å‰è¨€ï¼šå‘½ä»¤ç»†èŠ‚</a></h3>
<p>å¦‚æœä½ éœ€è¦äº†è§£å‘½ä»¤çš„å…·ä½“ç»†èŠ‚ï¼Œå¯ä»¥æŸ¥çœ‹
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/.github/workflows/ci.yaml">CI å·¥ä½œæµ</a>ã€‚<code>flutter_android_test</code>,
<code>flutter_ios_test</code>, <code>flutter_windows_test</code>, <code>flutter_macos_test</code> å’Œ
<code>flutter_linux_test</code> æ¼”ç¤ºäº†ä»ä¸€å°æ–°æœºå™¨ä¸Šè¿è¡Œè¯¥é¡¹ç›®æ‰€éœ€è¦çš„æ‰€æœ‰å‘½ä»¤</p>
<blockquote>
<p>è¯‘è€…æ³¨ï¼šå¦‚æœæ‚¨é‡åˆ°è¿è¡Œå¤±è´¥ï¼Œç¼ºå°‘ç¯å¢ƒç­‰é—®é¢˜ï¼Œè¯·å‚è€ƒä¸Šè¿° CI å·¥ä½œæµã€‚ä¸‹é¢çš„ cargo ndk ç­‰éƒ¨åˆ†å·¥å…·ï¼Œå’Œå¯¹åº”çš„äº¤å‰ç¼–è¯‘ç¯å¢ƒéƒ½éœ€è¦å•ç‹¬å®‰è£…ï¼Œä¹Ÿå¯ä»¥å‚ç…§
PART II çš„é¡¹ç›®è®¾ç½®éƒ¨åˆ†ã€‚</p>
</blockquote>
<h3 id="android-app"><a class="header" href="#android-app">Android app</a></h3>
<ul>
<li>æŠŠ <code>ANDROID_NDK=(path to NDK)</code> æ·»åŠ åˆ° <code>android/gradle.properties</code></li>
<li>æ¥ç€è¿è¡Œ <code>cargo ndk -o ../android/app/src/main/jniLibs build</code>.</li>
<li>æœ€åè¿è¡Œ <code>flutter run</code>.</li>
</ul>
<p><strong>æ³¨æ„</strong>: <a href="https://stackoverflow.com/q/69515032/4619958">è¿™ä¸ªæ•™ç¨‹</a> èƒ½å¤Ÿå¸®ä½ åœ¨æ„å»º Flutter
ç¨‹åºæ—¶è‡ªåŠ¨è¿è¡Œ cargo build.</p>
<h3 id="ios-app"><a class="header" href="#ios-app">iOS app</a></h3>
<ul>
<li>æ‰“å¼€ <code>Cargo.toml</code> å¹¶æŠŠ <code>cdylib</code> ä¿®æ”¹ä¸º <code>staticlib</code></li>
<li>æ¥ç€è¿è¡Œ
<code>cargo lipo &amp;&amp; cp target/universal/debug/libflutter_rust_bridge_example.a ../ios/Runner</code>
ç¼–è¯‘ Rust ä»£ç ï¼Œå¹¶å¤åˆ¶é™æ€è¿æ¥åº“ã€‚</li>
<li>æœ€ååƒå¹³æ—¶ä¸€æ ·è¿è¡Œ <code>flutter run</code>.</li>
</ul>
<p><strong>æ³¨æ„</strong>: <a href="https://stackoverflow.com/q/69515032/4619958">è¿™ä¸ªæ•™ç¨‹</a> èƒ½å¤Ÿå¸®ä½ åœ¨æ„å»º Flutter
ç¨‹åºæ—¶è‡ªåŠ¨è¿è¡Œ cargo build.</p>
<h3 id="windows-app"><a class="header" href="#windows-app">Windows app</a></h3>
<p>å‡è®¾ <a href="https://flutter.dev/desktop#set-up">Flutter æ¡Œé¢æ”¯æŒ</a> å·²ç»é…ç½®å®Œæˆï¼Œä½ å¯ä»¥ç›´æ¥è¿è¡Œ
<code>flutter run</code>ã€‚æ›´å¤šç»†èŠ‚å¯ä»¥åœ¨
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/66">#66</a>.</p>
<h3 id="linux-app"><a class="header" href="#linux-app">Linux app</a></h3>
<p>å’Œ Windows ä¸€æ ·ã€‚å¦‚æœä½ æ˜¯é€šè¿‡ <code>snap</code> å®‰è£…çš„ Flutter, è¯·é˜…è¯»ä¸€ä¸‹
<a href="https://github.com/canonical/flutter-snap/issues/53">#53</a>.</p>
<h3 id="macos-app"><a class="header" href="#macos-app">MacOS app</a></h3>
<p>å’Œ Windows ä¸€æ ·ã€‚(P.S. æœ¬è´¨ä¸Šè¯´ï¼Œ<code>cargo-xcode</code> è¢«ç”¨äºè‡ªåŠ¨åŒ–)</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç‰¹æ€§"><a class="header" href="#ç‰¹æ€§">ç‰¹æ€§</a></h1>
<p>è¿™ä¸€ç« ï¼Œæˆ‘ä»¬å°†å±•ç¤ºè¯¥åº“çš„å„ä¸ªç‰¹æ€§ã€‚è¯·ä½¿ç”¨å·¦ä¾§/å·¦ä¸Šçš„èœå•æ åˆ‡æ¢é¡µé¢ã€‚</p>
<h2 id="åºè¨€"><a class="header" href="#åºè¨€">åºè¨€</a></h2>
<h3 id="è¿™ä¸ªåº“æ˜¯ä»€ä¹ˆ"><a class="header" href="#è¿™ä¸ªåº“æ˜¯ä»€ä¹ˆ">è¿™ä¸ªåº“æ˜¯ä»€ä¹ˆï¼Ÿ</a></h3>
<p>è¿™ä¸ªåº“åªæ˜¯ä¸€ä¸ªä»£ç ç”Ÿæˆå™¨ï¼Œå¸®åŠ©ä½ çš„ Flutter / Dart è°ƒç”¨ Rust
å‡½æ•°ã€‚å®ƒåªæ˜¯ç”Ÿæˆäº†ä¸€äº›æ¨¡æ¿ä»£ç ï¼Œä»£æ›¿äº†æ‰‹å·¥ç¼–å†™ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜ä¸ºæ‚¨æä¾›äº†è¯¦ç»†çš„æ•™ç¨‹ï¼Œè®©æ‚¨å¯ä»¥å°è¯•å®ä¾‹ï¼Œåˆ›å»ºæ–°çš„åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸ç°æœ‰çš„åº”ç”¨ç¨‹åºé›†æˆã€‚</p>
<p>å½“ç„¶äº†ï¼Œä½ ä»ç„¶éœ€è¦å¯¹ Flutter/Dartï¼ŒRust ä»¥åŠ
<a href="https://flutter.dev/docs/development/platform-integration/c-interop">ffi</a>.
æœ‰ä¸€äº›åŸºæœ¬çš„äº†è§£ã€‚</p>
<h3 id="å®Œæ•´å®ä¾‹"><a class="header" href="#å®Œæ•´å®ä¾‹">å®Œæ•´å®ä¾‹</a></h3>
<p>å¦‚æœä½ æƒ³çœ‹ä¸€äº›ä¾‹å­ <small>æˆ‘è¦æå‰è­¦å‘Šä½ ï¼Œç¤ºä¾‹ä»£ç çœŸçš„éå¸¸å¤š</small>ã€‚
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/frb_example/pure_dart/rust/src/api.rs">pure_dart's api.rs</a>
æ–‡ä»¶é‡ŒåŒ…å«äº†å¯¹è¯¥åº“çš„æ‰€æœ‰æµ‹è¯•ã€‚</p>
<p>æ­¤å¤–ï¼Œå½“ä½ å¯¹åŸºæœ¬çš„ä¾‹å­å·²ç»ç†Ÿæ‚‰åï¼Œå¯ä»¥çœ‹ä¸€ä¸‹
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/tree/master/frb_example/pure_dart_multi/rust/src">pure_dart_multi</a>
é¡¹ç›®ï¼Œè¿™ä¸ªä¾‹å­åŒ…å«å¤šä¸ª API æ¨¡å—ã€‚å¯¹äºå¤æ‚çš„é¡¹ç›®æ¥è¯´æ˜¯ç›¸å½“æœ‰ç”¨çš„ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è¯­è¨€é—´è½¬æ¢"><a class="header" href="#è¯­è¨€é—´è½¬æ¢">è¯­è¨€é—´è½¬æ¢</a></h1>
<p>è¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬å°†å±•ç¤º Rust å’Œ Dart è¯­è¨€é—´çš„ç‰¹æ€§æ˜¯å¦‚ä½•è½¬æ¢ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç®€å•çš„å¯¹åº”å…³ç³»"><a class="header" href="#ç®€å•çš„å¯¹åº”å…³ç³»">ç®€å•çš„å¯¹åº”å…³ç³»</a></h1>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€çŸ­çš„æ¦‚è§ˆï¼Œæ˜¾ç¤ºäº†ä»£ç ç”Ÿæˆå™¨å¯ä»¥ç”Ÿæˆçš„å†…å®¹ï¼ˆå¹¶éå®Œå¤‡ï¼‰ã€‚æœ‰äº›è¡Œé™„å¸¦è¶…é“¾æ¥ï¼Œé‡Œé¢æœ‰æ›´è¯¦ç»†çš„è§£é‡Šã€‚</p>
<div class="table-wrapper"><table><thead><tr><th>Rust</th><th>Dart</th></tr></thead><tbody>
<tr><td><a href="feature/lang_vec.html"><code>Vec&lt;u8&gt;</code>, <code>Vec&lt;i8&gt;</code>..</a></td><td><code>Uint8List</code>, <code>Int8List</code>, ..</td></tr>
<tr><td><a href="feature/lang_vec.html"><code>Vec&lt;T&gt;</code></a></td><td><code>List&lt;T&gt;</code></td></tr>
<tr><td><a href="feature/lang_vec.html"><code>[T; N]</code></a></td><td><code>List&lt;T&gt;</code></td></tr>
<tr><td><a href="feature/lang_struct.html"><code>struct { .. }</code>, <code>struct( .. )</code></a></td><td><code>class</code></td></tr>
<tr><td><a href="feature/lang_enum.html"><code>enum { A, B }</code></a></td><td><code>enum</code></td></tr>
<tr><td><a href="feature/lang_enum.html"><code>enum { A(..) }</code></a></td><td><code>@freezed class</code></td></tr>
<tr><td><a href="feature/lang_external.html"><code>use ...</code></a></td><td>act normally</td></tr>
<tr><td><a href="feature/lang_option.html"><code>Option&lt;T&gt;</code></a></td><td><code>T?</code></td></tr>
<tr><td><code>Box&lt;T&gt;</code></td><td><code>T</code></td></tr>
<tr><td>comments</td><td>same</td></tr>
<tr><td><code>Result::Err</code>, panic</td><td><code>throw Exception</code></td></tr>
<tr><td><code>i8</code>, <code>u8</code>, .., <code>usize</code></td><td><code>int</code></td></tr>
<tr><td><code>f32</code>, <code>f64</code></td><td><code>double</code></td></tr>
<tr><td><code>bool</code></td><td><code>bool</code></td></tr>
<tr><td><code>String</code></td><td><code>String</code></td></tr>
<tr><td><code>()</code></td><td><code>void</code></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="vec-and-æ•°ç»„"><a class="header" href="#vec-and-æ•°ç»„">Vec and æ•°ç»„</a></h1>
<h2 id="vecu8-veci8-"><a class="header" href="#vecu8-veci8-"><code>Vec&lt;u8&gt;</code>, <code>Vec&lt;i8&gt;</code>, ...</a></h2>
<p>åœ¨ Dart ä¸­ï¼Œå½“ä½ æƒ³è¡¨è¾¾ä¸€ä¸ªé•¿å­—èŠ‚æ•°ç»„ï¼Œä¾‹å¦‚å¤§å›¾ç‰‡æˆ–ä¸€äº›äºŒè¿›åˆ¶ blobï¼Œé€šå¸¸ä¼šä½¿ç”¨ <code>Uint8List</code> è€Œä¸æ˜¯
<code>List&lt;int&gt;</code>ï¼Œå› ä¸ºå‰è€…çš„æ€§èƒ½æ›´å¥½ã€‚</p>
<p><code>flutter_rust_bridge</code> ä¹Ÿä¸ºä½ è€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ã€‚å½“ä½ ä½¿ç”¨åˆ° <code>Vec&lt;u8&gt;</code>ï¼ˆæˆ–
<code>Vec&lt;i8&gt;</code>ï¼Œ<code>Vec&lt;i32&gt;</code>ï¼Œç­‰ï¼‰æ—¶ï¼Œå®ƒä»¬ä¼šè¢«ç¿»è¯‘æˆ <code>Uint8List</code> æˆ–å…¶å®ƒç±»ä¼¼çš„ç»“æ„ã€‚</p>
<h2 id="vect"><a class="header" href="#vect"><code>Vec&lt;T&gt;</code></a></h2>
<p>å½“ä½ ä½¿ç”¨ <code>Vec&lt;T&gt;</code>ï¼Œå¹¶ä¸” T æ˜¯ <code>u8</code>ã€<code>i8</code> ç­‰ä»¥å¤–çš„ç±»å‹æ—¶ï¼Œå®ƒä¼šè¢«è½¬æ¢æˆæ­£å¸¸çš„ <code>List&lt;T&gt;</code>ã€‚</p>
<h2 id="t-n"><a class="header" href="#t-n"><code>[T; N]</code></a></h2>
<p>ç”±äº Dart æ²¡æœ‰å¯¹é™æ€å¤§å°çš„æ•°ç»„è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œæ‰€ä»¥å®ƒä¹Ÿä¼šè¢«è½¬æ¢ä¸º <code>List&lt;T&gt;</code>ã€‚</p>
<h2 id="ä¾‹å­"><a class="header" href="#ä¾‹å­">ä¾‹å­</a></h2>
<pre><code class="language-rust noplayground">pub fn draw_tree(tree: Vec&lt;TreeNode&gt;) -&gt; Vec&lt;u8&gt; { ... }
</code></pre>
<p>è½¬æ¢ä¸ºï¼š</p>
<pre><code class="language-Dart">Future&lt;Uint8List&gt; drawTree({required List&lt;TreeNode&gt; tree});
</code></pre>
<p>æ³¨æ„ï¼šå¦‚æœä½ å¯¹ <code>Future</code> æ„Ÿå…´è¶£ï¼Œè¯·çœ‹ <a href="feature/async_dart.html">è¿™é‡Œ</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç»“æ„ä½“"><a class="header" href="#ç»“æ„ä½“">ç»“æ„ä½“</a></h1>
<p>ä¸€èˆ¬çš„ Rust ç»“æ„ä½“éƒ½æ˜¯æ”¯æŒçš„ï¼Œä½ ç”šè‡³èƒ½å¤Ÿä½¿ç”¨é€’å½’å­—æ®µï¼Œæ¯”å¦‚ï¼š</p>
<pre><code class="language-rust noplayground">pub struct TreeNode {
    pub value: String,
    pub children: Vec&lt;MyTreeNode&gt;,
    pub parent: Box&lt;MyTreeNode&gt;
}
</code></pre>
<p>å¦‚æœä¸€ä¸ªç»“æ„ä½“çš„å­—æ®µæ˜¯ä¸€ä¸ªç»“æ„ä½“æˆ–è€…æšä¸¾ï¼Œè¯·ä¸ºå®ƒåŠ ä¸Šä¸€å±‚ <code>Box</code>, å¦åˆ™ä¼šå¯¼è‡´ç¼–è¯‘æ—¶é”™è¯¯ã€‚ä¾‹å¦‚ <code>struct A {b: B}</code> åº”è¯¥ä½¿ç”¨
<code>struct A {b: Box&lt;B&gt;}</code> ä»£æ›¿ã€‚</p>
<h2 id="å…ƒç»„ç»“æ„ä½“"><a class="header" href="#å…ƒç»„ç»“æ„ä½“">å…ƒç»„ç»“æ„ä½“</a></h2>
<p>å…ƒç»„ç»“æ„ä½“ <code>struct Foo(A, B)</code> ä¼šè¢«ç¿»è¯‘ä¸º <code>class Foo { A field0; B field1; }</code>, å› ä¸º Dart
æ²¡æœ‰åŒ¿åå­—æ®µã€‚</p>
<h2 id="non-final-å­—æ®µ"><a class="header" href="#non-final-å­—æ®µ">Non-final å­—æ®µ</a></h2>
<p>åœ¨ç»“æ„ä½“å­—æ®µä¸Šæ·»åŠ  <code>#[(non_final)]</code>, Dart ä¸­å¯¹åº”çš„å­—æ®µå°±ä¼šæ˜¯ non-final çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ç”Ÿæˆçš„å­—æ®µéƒ½è¢«è®¾ä¸º
finalï¼Œå› ä¸º Rust é»˜è®¤æ˜¯ä¸å¯å˜çš„ã€‚</p>
<h2 id="dart-å…ƒæ•°æ®æ³¨é‡Š"><a class="header" href="#dart-å…ƒæ•°æ®æ³¨é‡Š">Dart å…ƒæ•°æ®æ³¨é‡Š</a></h2>
<p>ä½ å¯ä»¥ä½¿ç”¨ <code>frb</code> å®ä¸­çš„ <code>dart_metadata</code> å‚æ•°ä¸º dart æ·»åŠ å…ƒæ•°æ®æ³¨è§£ã€‚</p>
<ul>
<li>
<p>å¯¹äºé‚£äº›ç”± dart æå‰å¼•å…¥çš„æ³¨è§£ï¼ˆä¾‹å¦‚ <code>@deprecated</code>ï¼‰,åªéœ€å°†æ³¨è§£ä½œä¸ºä¸€ä¸ª Rust å­—é¢é‡ã€‚</p>
<blockquote>
<p>TODO! For annotations that are prelude by dart (e.g. <code>@deprecated</code>), just
put annotation as a Rust literal.</p>
</blockquote>
</li>
<li>
<p>å¦‚æœä½ éœ€è¦ä½¿ç”¨ import, è¯·æŠŠ import éƒ¨åˆ†çš„ä»£ç è¿½åŠ åˆ°æ³¨è§£å­—é¢é‡ä¹‹åã€‚ç›®å‰æ”¯æŒä¸¤ç§ import æ ¼å¼ï¼š</p>
<ul>
<li><code>import 'somepackage'</code></li>
<li><code>import 'somepackage' as somename</code>, <code>somename</code> éƒ¨åˆ†ä¼šæˆä¸ºæ³¨è§£çš„å‰ç¼€</li>
</ul>
</li>
<li>
<p>å¤šä¸ªæ³¨è§£é—´ä½¿ç”¨ <code>,</code> åˆ†å‰²</p>
</li>
</ul>
<p>å…·ä½“çš„ä¾‹å­å¦‚ä¸‹ã€‚</p>
<h2 id="freezed-dart-classes"><a class="header" href="#freezed-dart-classes"><code>freezed</code> Dart classes</a></h2>
<p>å¦‚æœä½ æƒ³è®©ç”Ÿæˆçš„ Dart ç±»æ˜¯ <a href="https://pub.dev/packages/freezed"><code>freezed</code></a>çš„ï¼ˆç±»ä¼¼äº Kotlin ä¸­çš„
data-classesï¼‰ï¼Œåªéœ€è¦åœ¨ç»“æ„ä½“å‰æ·»åŠ  <code>#[frb(dart_metadata=(&quot;freezed&quot;))]</code>ï¼Œå®ƒä¼šä¸ºä½ ç”Ÿæˆéœ€è¦çš„ä¸œè¥¿ã€‚</p>
<h2 id="ç¤ºä¾‹"><a class="header" href="#ç¤ºä¾‹">ç¤ºä¾‹</a></h2>
<h3 id="ä¾‹-1--é€’å½’å­—æ®µ"><a class="header" href="#ä¾‹-1--é€’å½’å­—æ®µ">ä¾‹ 1 : é€’å½’å­—æ®µ</a></h3>
<pre><code class="language-rust noplayground">pub struct MyTreeNode {
    pub value: Vec&lt;u8&gt;,
    pub children: Vec&lt;MyTreeNode&gt;,
}
</code></pre>
<p>è½¬æ¢ä¸ºï¼š</p>
<pre><code class="language-Dart">class MyTreeNode {
  final Uint8List value;
  final List&lt;MyTreeNode&gt; children;
  MyTreeNode({required this.value, required this.children});
}
</code></pre>
<p>æ³¨æ„ï¼šå¦‚æœä½ æƒ³äº†è§£ <code>Future</code> , è¯·çœ‹è¿™é‡Œ <a href="feature/async_dart.html">async_dart</a>.</p>
<h3 id="ä¾‹-2--metadata"><a class="header" href="#ä¾‹-2--metadata">ä¾‹ 2 : Metadata</a></h3>
<pre><code class="language-rust noplayground">#[frb(dart_metadata=(&quot;freezed&quot;, &quot;immutable&quot; import &quot;package:meta/meta.dart&quot; as meta))]
pub struct UserId {
    pub value: u32,
}
</code></pre>
<p>è½¬æ¢ä¸ºï¼š</p>
<pre><code class="language-dart">import 'package:meta/meta.dart' as meta;

@freezed
@meta.immutable
class UserId with _$UserId {
  const factory UserId({
    required int value,
  }) = _UserId;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æšä¸¾"><a class="header" href="#æšä¸¾">æšä¸¾</a></h1>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒRust çš„ <code>enum</code> åŠŸèƒ½å¼ºå¤§ï¼Œè€Œä¸”è¡¨è¾¾åŠ›å¼º - å®ƒå…è®¸æ¯ä¸€ä¸ªæšä¸¾çš„å˜ä½“å…³è”ä¸åŒçš„æ•°æ®ã€‚Dart æ²¡æœ‰å†…ç½®è¿™ç§æšä¸¾ï¼Œä½†æ˜¯ä¸ç”¨æ‹…å¿ƒ - æˆ‘ä»¬ä¼šä½¿ç”¨
Dart ä¸­çš„ <code>freezed</code> åº“è‡ªåŠ¨ç¿»è¯‘ä¸ºç­‰ä»·çš„ç»“æ„ã€‚ç¬¬ä¸€çœ¼çœ‹ä¸Šå»ï¼Œ<code>freezed</code> çš„è¯­æ³•å¯èƒ½çœ‹ä¸Šå»å¾ˆå¥‡æ€ªï¼Œä½†æ˜¯è¯·é˜…è¯»ä¸€ä¸‹
<a href="https://pub.dev/packages/freezed">å®ƒçš„æ–‡æ¡£</a>, çœ‹çœ‹å®ƒçš„å¼ºå¤§ä¹‹å¤„ã€‚</p>
<h2 id="ç¤ºä¾‹-1"><a class="header" href="#ç¤ºä¾‹-1">ç¤ºä¾‹</a></h2>
<pre><code class="language-rust noplayground">pub enum KitchenSink {
    Empty,
    Primitives {
        /// Dart field comment
        int32: i32,
        float64: f64,
        boolean: bool,
    },
    Nested(Box&lt;KitchenSink&gt;),
    Optional(
        /// Comment on anonymous field
        Option&lt;i32&gt;,
        Option&lt;i32&gt;,
    ),
    Buffer(ZeroCopyBuffer&lt;Vec&lt;u8&gt;&gt;),
    Enums(Weekdays),
}
</code></pre>
<p>è½¬æ¢ä¸ºï¼š</p>
<pre><code class="language-Dart">@freezed
class KitchenSink with _$KitchenSink {
  /// Comment on variant
  const factory KitchenSink.empty() = Empty;
  const factory KitchenSink.primitives({
    /// Dart field comment
    required int int32,
    required double float64,
    required bool boolean,
  }) = Primitives;
  const factory KitchenSink.nested(
    KitchenSink field0,
  ) = Nested;
  const factory KitchenSink.optional([
    /// Comment on anonymous field
    int? field0,
    int? field1,
  ]) = Optional;
  const factory KitchenSink.buffer(
    Uint8List field0,
  ) = Buffer;
  const factory KitchenSink.enums(
    Weekdays field0,
  ) = Enums;
}
</code></pre>
<p>å®ƒä»¬ç”± freezed ä¸­çš„ <a href="https://pub.dev/packages/freezed">all functionalities</a> é©±åŠ¨ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¤–éƒ¨ç±»å‹"><a class="header" href="#å¤–éƒ¨ç±»å‹">å¤–éƒ¨ç±»å‹</a></h1>
<h2 id="å®šä¹‰åœ¨ç›¸åŒ-crate-ä¸­ä¸åŒæ–‡ä»¶é‡Œçš„ç±»å‹"><a class="header" href="#å®šä¹‰åœ¨ç›¸åŒ-crate-ä¸­ä¸åŒæ–‡ä»¶é‡Œçš„ç±»å‹">å®šä¹‰åœ¨ç›¸åŒ crate ä¸­ä¸åŒæ–‡ä»¶é‡Œçš„ç±»å‹</a></h2>
<p><code>use</code> è¯­å¥å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼šæ·»åŠ  <code>use crate::data::{MyEnum, MyStruct};</code>åï¼Œä½ å¯ä»¥æ­£å¸¸çš„ä½¿ç”¨ <code>MyEnum</code> å’Œ
<code>MyStruct</code>ã€‚</p>
<h3 id="ç¤ºä¾‹-2"><a class="header" href="#ç¤ºä¾‹-2">ç¤ºä¾‹</a></h3>
<pre><code class="language-rust noplayground">use crate::data::{MyEnum, MyStruct};

pub fn use_imported_things(my_struct: MyStruct, my_enum: MyEnum) { ... }
</code></pre>
<p>è½¬æ¢ä¸ºï¼š</p>
<pre><code class="language-Dart">// Well it just behaves normally as you expect
Future&lt;void&gt; useImportedThings({required MyStruct myStruct, required MyEnum myEnum});
</code></pre>
<p>æ³¨æ„ï¼šå¦‚æœä½ å¯¹ <code>Future</code> æ„Ÿå…´è¶£ï¼Œè¯·çœ‹ <a href="feature/async_dart.html">è¿™é‡Œ</a>.</p>
<h2 id="å…¶ä»–-crate-ä¸­çš„ç±»å‹"><a class="header" href="#å…¶ä»–-crate-ä¸­çš„ç±»å‹">å…¶ä»– crate ä¸­çš„ç±»å‹</a></h2>
<p>è¿™ä¸ªåŠŸèƒ½è¢«ç§°ä¸º &quot;é•œåƒ (mirror)&quot;. ç®€å•æ¥è¯´ï¼Œå¯¹äºä½ æƒ³ä½¿ç”¨çš„å¤–éƒ¨ç±»å‹ï¼Œä½ éœ€è¦é‡æ–°ç¼–å†™ä¸€æ¬¡ä½œä¸ºé•œåƒã€‚è¿™ä¸ªé•œåƒåªä¼šåœ¨ä»£ç ç”Ÿæˆæ—¶è´Ÿè´£å‘ŠçŸ¥
<code>flutter_rust_bridge</code> æ‰€éœ€çš„ç±»å‹ä¿¡æ¯ã€‚ä¸‹é¢çš„ä¾‹å­é‡Œæœ‰è¯¦ç»†çš„è¯­æ³•ã€‚</p>
<p>ä¸ç”¨æ‹…å¿ƒå®ƒä¼šæ‰“ç ´ DRY (Donâ€™t Repeat Yourself) åŸåˆ™ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒä½ å¯èƒ½å†™é”™ä¸€ä¸ªå­—æ®µã€‚å› ä¸ºå¦‚æœé•œåƒå’ŒåŸå§‹ç±»å‹ä¸å®Œå…¨ä¸€è‡´å°±ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚</p>
<p>æ›´å¤šä¿¡æ¯ï¼š <a href="https://github.com/fzyzcjy/flutter_rust_bridge/pull/352">#352</a></p>
<p>å½“å¤šä¸ªç»“æ„ä½“æœ‰ç›¸åŒçš„å­—æ®µæ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•åªé‡å†™ä¸€éã€‚
<code>#[frb(mirror(FirstStruct, SecondStruct, ThirdStruct))]</code>.
(<a href="https://github.com/fzyzcjy/flutter_rust_bridge/pull/619">#619</a>)</p>
<h3 id="ç¤ºä¾‹-3"><a class="header" href="#ç¤ºä¾‹-3">ç¤ºä¾‹</a></h3>
<!-- TODO! -->
<pre><code class="language-rust noplayground">// Mirroring example:
// The goal of mirroring is to use external objects without needing to convert them with an intermediate type
// In this case, the struct ApplicationSettings is defined in another crate (called external-lib)

// To use an external type with mirroring, it MUST be imported publicly (aka. re-export)
pub use external_lib::{ApplicationEnv, ApplicationMode, ApplicationSettings};

// To mirror an external struct, you need to define a placeholder type with the same definition
#[frb(mirror(ApplicationSettings))]
pub struct _ApplicationSettings {
    pub name: String,
    pub version: String,
    pub mode: ApplicationMode,
    pub env: Box&lt;ApplicationEnv&gt;,
}

// It works with basic enums too
// Enums with struct variants are not yet supported
#[frb(mirror(ApplicationMode))]
pub enum _ApplicationMode {
    Standalone,
    Embedded,
}

#[frb(mirror(ApplicationEnv))]
pub struct _ApplicationEnv {
    pub vars: Vec&lt;String&gt;,
}

// This function can directly return an object of the external type ApplicationSettings because it has a mirror
pub fn get_app_settings() -&gt; ApplicationSettings {
    external_lib::get_app_settings()
}

// Similarly, receiving an object from Dart works. Please note that the mirror definition must match entirely and the original struct must have all its fields public.
pub fn is_app_embedded(app_settings: ApplicationSettings) -&gt; bool {
    // println!(&quot;env: {}&quot;, app_settings.env.vars[0]);
    match app_settings.mode {
        ApplicationMode::Standalone =&gt; false,
        ApplicationMode::Embedded =&gt; true,
    }
}
</code></pre>
<p>ç”¨ä¸€ä¸ªç»“æ„ä½“å»é•œåƒå¤šä¸ªç»“æ„ä½“ï¼š</p>
<pre><code class="language-rust noplayground">// *ä¸* éœ€è¦è¿™æ ·åš
#[frb(mirror(MessageId))]
pub struct MId(pub [u8; 32]);
#[frb(mirror(BlobId))]
pub struct BId(pub [u8; 32]);
#[frb(mirror(FeedId))]
pub struct FId(pub [u8; 32]);

// åªè¦ç¼–å†™ä¸€æ¬¡å°±è¶³å¤Ÿäº†
#[frb(mirror(MessageId, BlobId, FeedId))]
pub struct Id(pub [u8; 32]);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="option"><a class="header" href="#option">Option</a></h1>
<p>Dart å¯¹äºå¯èƒ½ä¸ºç©ºçš„å­—æ®µæœ‰ç‰¹æ®Šçš„è¯­æ³• <code>?</code>ï¼Œè¯¥åº“ä¼šè‡ªåŠ¨æŠŠ <code>Option</code> ç¿»è¯‘ä¸º <code>?</code>ã€‚ä½ å¯ä»¥æŸ¥çœ‹
<a href="https://dart.dev/null-safety">å®˜æ–¹æ–‡æ¡£</a> äº†è§£æ›´å¤šã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>flutter_rust_bridge</code> ä¹Ÿèƒ½å¤Ÿå¤„ç† Dart ä¸­çš„ <code>required</code> å…³é”®å­—ï¼šå¦‚æœä¸€ä¸ªå‚æ•°ä¸èƒ½ä¸ºç©ºï¼Œå®ƒå°±ä¼šè¢«æ ‡è®°ä¸º
<code>required</code>ã€‚å¦‚æœå®ƒå¯ä»¥ä¸ºç©ºï¼Œé‚£å°±ä¸éœ€è¦ <code>required</code>ï¼ŒDart é»˜è®¤ä¸º nullã€‚</p>
<h2 id="ç¤ºä¾‹-4"><a class="header" href="#ç¤ºä¾‹-4">ç¤ºä¾‹</a></h2>
<pre><code class="language-rust noplayground">pub struct Element {
    pub tag: Option&lt;String&gt;,
    pub text: Option&lt;String&gt;,
    pub attributes: Option&lt;Vec&lt;Attribute&gt;&gt;,
    pub children: Option&lt;Vec&lt;Element&gt;&gt;,
}

pub fn parse(mode: String, document: Option&lt;String&gt;) -&gt; Option&lt;Element&gt; { ... }
</code></pre>
<p>è½¬æ¢ä¸ºï¼š</p>
<pre><code class="language-Dart">Future&lt;Element?&gt; handleOptionalStruct({required String mode, String? document});

class Element {
  final String? tag;
  final String? text;
  final List&lt;Attribute&gt;? attributes;
  final List&lt;Element&gt;? children;
  Element({this.tag, this.text, this.attributes, this.children});
}
</code></pre>
<p>æ³¨æ„ï¼šå¦‚æœä½ å¯¹ <code>Future</code> æ„Ÿå…´è¶£ï¼Œè¯·çœ‹ <a href="feature/async_dart.html">è¿™é‡Œ</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ–¹æ³•"><a class="header" href="#æ–¹æ³•">æ–¹æ³•</a></h1>
<p>æ”¯æŒå¸¦æœ‰æ–¹æ³•çš„ç»“æ„ä½“ã€‚åŒ…æ‹¬é™æ€æ–¹æ³•å’Œéé™æ€æ–¹æ³•ã€‚</p>
<h2 id="ç¤ºä¾‹-5"><a class="header" href="#ç¤ºä¾‹-5">ç¤ºä¾‹</a></h2>
<pre><code class="language-rust noplayground">pub struct SumWith { pub x: u32 }

impl SumWith {
    pub fn sum(&amp;self, y: u32) -&gt; u32 { self.x + y }
    pub fn sum_static(x: u32, y: u32) -&gt; u32 { x + y }
}
</code></pre>
<p>è½¬æ¢ä¸º</p>
<pre><code class="language-Dart">class SumWith {
  final FlutterRustBridgeExampleSingleBlockTest bridge;
  final int x;

  SumWith({
    required this.bridge,
    required this.x,
  });

  Future&lt;int&gt; sum({required int y, dynamic hint}) =&gt; ..
  static Future&lt;int&gt; sum({required int x, required int y, dynamic hint}) =&gt; ..
}
</code></pre>
<p>æ³¨æ„ï¼šå¦‚æœä½ å¯¹ <code>Future</code> æ„Ÿå…´è¶£ï¼Œè¯·çœ‹ <a href="feature/async_dart.html">è¿™é‡Œ</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è¿”å›å€¼ç±»å‹"><a class="header" href="#è¿”å›å€¼ç±»å‹">è¿”å›å€¼ç±»å‹</a></h1>
<p>è¿”å›å€¼ç±»å‹å¯ä»¥æ˜¯ <code>anyhow::Result&lt;YourType&gt;</code>, æˆ–è€…ç›´æ¥æ˜¯ä½ çš„ç±»å‹ <code>YourType</code> .</p>
<h2 id="ç¤ºä¾‹-6"><a class="header" href="#ç¤ºä¾‹-6">ç¤ºä¾‹</a></h2>
<pre><code class="language-rust noplayground">pub fn f(a: i32, b: i32) -&gt; i32 { a + b }

pub fn g(a: i32, b: i32) -&gt; anyhow::Result&lt;i32&gt; { Ok(a + b) }
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é›¶æ‹·è´"><a class="header" href="#é›¶æ‹·è´">é›¶æ‹·è´</a></h1>
<p><code>ZeroCopyBuffer&lt;Vec&lt;u8&gt;&gt;</code> (ä»¥åŠä¸å®ƒç±»ä¼¼çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ <code>ZeroCopyBuffer&lt;Vec&lt;i8&gt;&gt;</code>) å¯ä»¥æ— éœ€æ‹·è´å°†æ•°æ®ä»
Rust å‘é€åˆ° Dart. å› æ­¤ï¼Œå¯ä»¥èŠ‚çº¦æ‹·è´æ•°æ®çš„å¼€é”€ï¼Œå¦‚æœä½ çš„æ•°æ®å¾ˆå¤§ï¼ˆæ¯”å¦‚ä¸€å¼ é«˜åˆ†è¾¨ç‡å›¾åƒï¼‰ï¼Œå¼€é”€å¯èƒ½ä¼šå¾ˆé«˜ã€‚</p>
<h2 id="ç¤ºä¾‹-7"><a class="header" href="#ç¤ºä¾‹-7">ç¤ºä¾‹</a></h2>
<pre><code class="language-rust noplayground">pub fn draw_tree(tree: Vec&lt;TreeNode&gt;) -&gt; ZeroCopyBuffer&lt;Vec&lt;u8&gt;&gt; { ... }
</code></pre>
<p>è½¬æ¢ä¸ºï¼š</p>
<pre><code class="language-Dart">Future&lt;Uint8List&gt; drawTree({required List&lt;TreeNode&gt; tree});
</code></pre>
<p>ç”Ÿæˆçš„ Dart ä»£ç çœ‹èµ·æ¥å’Œæ²¡æœ‰ç”¨ <code>ZeroCopyBuffer</code> çš„å‡ ä¹ä¸€æ ·ã€‚ä½†æ˜¯å®ƒçš„å†…éƒ¨å®ç°å·²ç»æ”¹å˜ï¼Œå®Œå…¨ä¸éœ€è¦å†…å­˜æ‹·è´ï¼</p>
<p>æ³¨æ„ï¼šå¦‚æœä½ å¯¹ <code>Future</code> æ„Ÿå…´è¶£ï¼Œè¯·çœ‹ <a href="feature/async_dart.html">è¿™é‡Œ</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stream-æµ--è¿­ä»£å™¨"><a class="header" href="#stream-æµ--è¿­ä»£å™¨">Stream æµ / è¿­ä»£å™¨</a></h1>
<p><em><code>Stream</code> / <code>Iterator</code></em></p>
<p>Stream æ˜¯ä»€ä¹ˆï¼Ÿç®€å•æ¥è¯´ï¼šè°ƒç”¨ä¸€æ¬¡ï¼Œè¿”å›å¤šæ¬¡ï¼Œç±»ä¼¼äº Iteratorã€‚</p>
<blockquote>
<p>è¯‘è€…æ³¨ï¼šå¼‚æ­¥ Iteratorã€‚</p>
</blockquote>
<p>Flutter çš„ <a href="https://dart.dev/tutorials/language/streams">Stream</a> æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æŠ½è±¡ã€‚</p>
<p>å‡å¦‚ï¼Œä½ çš„ Rust ä»£ç åœ¨è¿è¡Œä¸€ä¸ªååˆ†å¤æ‚çš„ç®—æ³•ï¼Œå¹¶ä¸”æ¯éš”å‡ ç™¾æ¯«ç§’ï¼Œå°±èƒ½æ‰¾åˆ°ä¸€ç§æ–°çš„è§£å†³æ–¹æ¡ˆã€‚æ¯æ‰¾åˆ°ä¸€ä¸ªè§£ï¼Œå®ƒå°±å¯ä»¥ç›´æ¥å°†è¿™éƒ¨åˆ†å†…å®¹å›å¤ç»™
Flutterï¼Œå¹¶ç«‹å³æ¸²æŸ“åˆ° UIã€‚ç”¨æˆ·æ— éœ€ç­‰åˆ°ç®—æ³•å®Œå…¨ç»“æŸå°±èƒ½çœ‹åˆ°ä¸€éƒ¨åˆ†ç»“æœã€‚</p>
<p>è‡³äºç»†èŠ‚æ–¹é¢ï¼Œä¸€ä¸ªå¸¦æœ‰ä¸‹é¢å‡½æ•°ç­¾åçš„ Rust å‡½æ•° <code>fn f(sink: StreamSink&lt;T&gt;, ..) -&gt; Result&lt;()&gt;</code>
ä¼šè¢«ç¿»è¯‘ä¸ºï¼š<code>Stream&lt;T&gt; f(..)</code>ã€‚</p>
<!-- TODO! -->
<p>æ³¨æ„ï¼šä½ å¯ä»¥æ°¸è¿œæŒæœ‰è¿™ä¸ª <code>StreamSink</code>ï¼Œå¹¶ä¸”è‡ªç”±ä½¿ç”¨ï¼Œç”šè‡³åœ¨ Rust å‡½æ•°è¿”å›åã€‚ä¸‹é¢çš„ logger
ä¾‹å­è¯æ˜äº†è¿™ç‚¹ï¼ˆ<code>create_log_stream</code> å‡½æ•°å‡ ä¹æ˜¯ç«‹å³è¿”å›ï¼Œä½†æ˜¯ä½ å¯ä»¥åœ¨ä¸€å°æ—¶ä¹‹åä½¿ç”¨ <code>StreamSink</code>ï¼‰ã€‚</p>
<blockquote>
<p>Notice that, you can hold that StreamSink forever, and use it freely even
after the Rust function itself returns. The logger example below also
demonstrates this (the create_log_stream returns almost immediately, while you
can use the StreamSink after, say, an hour).</p>
</blockquote>
<p><code>StreamSink</code> å¯ä»¥è¢«æ”¾åœ¨å‡½æ•°çš„ä»»ä½•åœ°æ–¹ã€‚ä¾‹å¦‚ <code>fn f(a: i32, b: StreamSink&lt;String&gt;)</code> å’Œ
<code>fn f(a: StreamSink&lt;String&gt;, b: i32)</code> éƒ½æ˜¯åˆæ³•çš„ã€‚</p>
<h2 id="ç¤ºä¾‹-8"><a class="header" href="#ç¤ºä¾‹-8">ç¤ºä¾‹</a></h2>
<p>ä¸‹é¢çš„ä¾‹å­åªæ˜¯ä¸ºäº†åŠ æ·±ä½ å¯¹ Stream ç‰¹æ€§çš„ç†è§£ã€‚</p>
<h3 id="ç¤ºä¾‹é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒçš„-logger"><a class="header" href="#ç¤ºä¾‹é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒçš„-logger">ç¤ºä¾‹ï¼šé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ Logger</a></h3>
<p>åœ¨æˆ‘çš„ appï¼ˆå·²ç»åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒï¼‰é‡Œï¼Œæˆ‘ä½¿ç”¨äº†ä¸‹é¢çš„ç­–ç•¥å¤„ç† Rust æ—¥å¿—ï¼šä½¿ç”¨å¸¸è§„çš„ Rust æ–¹æ³•è®°å½•æ—¥å¿—ï¼Œæ¯”å¦‚ <code>info!</code> å’Œ <code>debug!</code>
å®ã€‚æ¥ç€æ—¥å¿—ä¼šåœ¨ä¸¤ä¸ªåœ°æ–¹å¾—åˆ°å¤„ç†ï¼šä¸€æ–¹é¢æ˜¯é€šè¿‡ä¸åŒå¹³å°ç‰¹å®šçš„æ–¹æ³•æ‰“å°ï¼ˆå°±åƒå®‰å“å¹³å°çš„ Logcat å’Œ IOS çš„ NSLogï¼‰å¦ä¸€ä¸ªæ˜¯é€šè¿‡ Stream
å‘é€åˆ° Dart ç«¯å¹¶è¿›ä¸€æ­¥å¤„ç† (ä¾‹å¦‚ä¿å­˜åˆ°æ–‡ä»¶ï¼Œæˆ–è€…æ˜¯å‘é€ç»™æœåŠ¡ç«¯ç­‰)ã€‚</p>
<p>å®Œæ•´çš„ä»£ç å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/486">#486</a>ã€‚</p>
<h3 id="ç¤ºä¾‹ç®€å•çš„-logger"><a class="header" href="#ç¤ºä¾‹ç®€å•çš„-logger">ç¤ºä¾‹ï¼šç®€å•çš„ logger</a></h3>
<p>è®©æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€å•çš„æ—¥å¿—ç³»ç»Ÿï¼ˆæ”¹ç¼–è‡ªæˆ‘åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ <code>flutter_rust_bridge</code> æ„å»ºçš„æ—¥å¿—ç³»ç»Ÿï¼‰ï¼ŒRust ä»£ç å¯ä»¥å‘ Dart
ç«¯å‘é€æ—¥å¿—ã€‚</p>
<p>Rust ç«¯ <code>api.rs</code>:</p>
<pre><code class="language-rust noplayground">pub struct LogEntry {
    pub time_millis: i64,
    pub level: i32,
    pub tag: String,
    pub msg: String,
}

// ç”¨äºå±•ç¤ºçš„ç®€åŒ–ä»£ç 
// ä¸ºäº†æˆåŠŸç¼–è¯‘ï¼Œä½ éœ€è¦ä¸€ä¸ª OnceCellï¼Œæˆ–è€… Mutexï¼Œæˆ–è€… RwLock
// æ›´å¤šèµ„æ–™ï¼šhttps://github.com/fzyzcjy/flutter_rust_bridge/issues/398
lazy_static! { static ref log_stream_sink: StreamSink&lt;LogEntry&gt;; }

pub fn create_log_stream(s: StreamSink&lt;LogEntry&gt;) {
    stream_sink = s;
}
</code></pre>
<p>ç°åœ¨ Rust ç¼–è¯‘å™¨åº”è¯¥ä¼šå‘ä½ æŠ±æ€¨ <code>LogEntry</code> æ²¡æœ‰å®ç° <code>IntoDart</code>ã€‚è¿™æ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œå› ä¸º <code>flutter_rust_bridge</code>
ä¼šä¸ºä½ ç”Ÿæˆç›¸å…³å®ç°ã€‚ä¿®å¤å®ƒä¹Ÿå¾ˆç®€å•ï¼Œå†æ¬¡è¿è¡Œ <code>flutter_rust_bridge_codegen</code> å³å¯</p>
<p>ç”Ÿæˆçš„ Dart ä»£ç ï¼š</p>
<pre><code class="language-Dart">Stream&lt;LogEntry&gt; createLogStream();
</code></pre>
<p>åœ¨ Dart ä¸­ä½¿ç”¨ï¼š</p>
<pre><code class="language-dart">Future&lt;void&gt; setup() async {
    createLogStream().listen((event) {
      print('log from rust: ${event.level} ${event.tag} ${event.msg} ${event.timeMillis}');
    });
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬èƒ½å¤Ÿæ„‰å¿«çš„åœ¨ Rust ä¸­ç”¨æ—¥å¿—è®°å½•ä»»ä½•ä¸œè¥¿ï¼š</p>
<pre><code class="language-rust noplayground">log_stream_sink.add(LogEntry { msg: &quot;hello I am a log from Rust&quot;, ... })
</code></pre>
<p>å½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥è·Ÿç€ Rust ä¸­çš„ <code>log</code> åº“å»å®ç°ä¸€ä¸ªè‡ªå·±çš„ loggerï¼Œåªéœ€è¦åœ¨å¤–é¢åŒ…è£…ä¸€å±‚ stream sinkï¼Œå°±å¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ Rust
æ—¥å¿—æœºåˆ¶ï¼Œä¾‹å¦‚ <code>info!</code>ã€‚æˆ‘åœ¨æˆ‘åœ¨æˆ‘çš„é¡¹ç›®ä¸­å°±æ˜¯è¿™ä¹ˆåšçš„ã€‚</p>
<h3 id="ç¤ºä¾‹ç®€å•å®šæ—¶å™¨"><a class="header" href="#ç¤ºä¾‹ç®€å•å®šæ—¶å™¨">ç¤ºä¾‹ï¼šç®€å•å®šæ—¶å™¨</a></h3>
<p>Credits:
<a href="https://gist.github.com/Desdaemon/be5da0a1c6b4724f20093ef434959744">this</a> and
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/347">#347</a>.</p>
<pre><code class="language-rust noplayground">use anyhow::Result;
use std::{thread::sleep, time::Duration};

use flutter_rust_bridge::StreamSink;

const ONE_SECOND: Duration = Duration::from_secs(1);

// can't omit the return type yet, this is a bug
pub fn tick(sink: StreamSink&lt;i32&gt;) -&gt; Result&lt;()&gt; {
    let mut ticks = 0;
    loop {
        sink.add(ticks);
        sleep(ONE_SECOND);
        if ticks == i32::MAX {
            break;
        }
        ticks += 1;
    }
    Ok(())
}
</code></pre>
<p>ç„¶ååœ¨ Dart ä¸­ä½¿ç”¨ï¼š</p>
<pre><code class="language-dart">import 'package:flutter/material.dart';
import 'ffi.dart';

void main() {
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Flutter Demo',
      theme: ThemeData(
        primarySwatch: Colors.blue,
      ),
      home: const MyHomePage(title: 'Flutter Demo Home Page'),
    );
  }
}

class MyHomePage extends StatefulWidget {
  const MyHomePage({Key? key, required this.title}) : super(key: key);
  final String title;

  @override
  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();
}

class _MyHomePageState extends State&lt;MyHomePage&gt; {
  late Stream&lt;int&gt; ticks;

  @override
  void initState() {
    super.initState();
    ticks = api.tick();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(widget.title),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: &lt;Widget&gt;[
            const Text(&quot;Time since starting Rust stream&quot;),
            StreamBuilder&lt;int&gt;(
              stream: ticks,
              builder: (context, snap) {
                final style = Theme.of(context).textTheme.headline4;
                final error = snap.error;
                if (error != null)
                  return Tooltip(
                      message: error.toString(),
                      child: Text('Error', style: style));

                final data = snap.data;
                if (data != null) return Text('$data second(s)', style: style);

                return const CircularProgressIndicator();
              },
            )
          ],
        ),
      ),
    );
  }
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dart-ä¸­çš„å¼‚æ­¥"><a class="header" href="#dart-ä¸­çš„å¼‚æ­¥">Dart ä¸­çš„å¼‚æ­¥</a></h1>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œç”Ÿæˆçš„ä»£ç éƒ½æ˜¯å¼‚æ­¥çš„ã€‚æ‰€ä»¥ <code>fn f(..) -&gt; String</code> å°†è¢«è½¬æ¢ä¸º <code>Future&lt;String&gt; f(..)</code>ï¼Œå¤šäº†ä¸€ä¸ª
<code>Future</code>ã€‚</p>
<p>ä¸ºä»€ä¹ˆï¼ŸFlutter UI æ˜¯å•çº¿ç¨‹çš„ã€‚å¦‚æœä½ ä½¿ç”¨åŒæ­¥æ–¹æ³•ï¼ˆä¸€äº›è€çš„ binding å°±æ˜¯è¿™æ ·ï¼‰ï¼Œåœ¨ Rust ä»£ç æ‰§è¡Œæ—¶ï¼ŒUI æ¸²æŸ“å°†è¢«é˜»å¡ã€‚å¦‚æœä½ çš„
Rust ä»£ç è¿›è¡Œä¸€æ¬¡å¤æ‚è¿ç®—éœ€è¦è€—æ—¶ 100msï¼Œé‚£ä¹ˆä½ çš„ UI å°±ä¼šå®Œå…¨å†»ç»“ 100msï¼Œç”¨æˆ·å°±ä¸ä¹æ„äº†ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œæœ‰äº†ç”Ÿæˆçš„å¼‚æ­¥ Dart ç»‘å®šï¼Œä½ å°±å¯ä»¥åœ¨ Dart/Flutter çš„ä¸»éš”ç¦»åŒºç›´æ¥è°ƒç”¨ï¼ŒRust ä»£ç ä¸ä¼šé˜»å¡ Flutter UIã€‚</p>
<p>async å’Œ <code>Future</code> åœ¨ Flutter/Dart ä¸­å‡ ä¹æ— å¤„ä¸åœ¨ï¼Œå¹¶ä¸”æœ‰ç€éå¸¸å¥½çš„å†…éƒ¨æ”¯æŒï¼Œå®Œå…¨ä¸ç”¨æ‹…å¿ƒ :Dã€‚</p>
<p>æ³¨æ„ï¼šä¸€ä¸ªå¸¸è§çš„è¯¯è§£æ˜¯åœ¨ Dart çš„å…¶ä»–éš”ç¦»åŒºè°ƒç”¨ Rust ä»£ç ï¼ˆä¾‹å¦‚
&quot;çº¿ç¨‹&quot;ï¼‰ï¼Œè€Œä¸æ˜¯ä¸»éš”ç¦»åŒºã€‚è¿™æ˜¯å®Œå…¨æ²¡å¿…è¦çš„ï¼Œåªä¼šå¾’å¢ä½ çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œå³ä½¿ä½ çš„ Rust åªç”¨ 100ms å°±èƒ½å®Œæˆï¼Œasync ä¹Ÿåªéœ€è¦èŠ±è´¹ 0.1
msï¼Œå¹¶ä¸”ä¸ä¼šé˜»å¡ä½ çš„ UIã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dart-ä¸­çš„åŒæ­¥"><a class="header" href="#dart-ä¸­çš„åŒæ­¥">Dart ä¸­çš„åŒæ­¥</a></h1>
<p>å¦‚æœä½ çœŸçš„éœ€è¦ç”ŸæˆåŒæ­¥çš„ Dart å‡½æ•°ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>SyncReturn&lt;Vec&lt;u8&gt;&gt;</code> ä½œä¸ºè¿”å›å€¼ç±»å‹ã€‚</p>
<p>æˆ‘ä»¬å»ºè®®åªåœ¨éå¸¸å¿«çš„ Rust å‡½æ•°ä¸Šè¿™æ ·åšï¼Œå¦åˆ™ UI å°†è¢«é˜»å¡ã€‚</p>
<p>å› ä¸ºåŒæ­¥ Dart å‡½æ•°ä½¿ç”¨å¾—å¾ˆå°‘ï¼Œæ‰€ä»¥ç°åœ¨ä»…æ”¯æŒ <code>Vec&lt;u8&gt;</code> ä¸€ç§ç±»å‹ï¼Œå…¶ä»–ç±»å‹å¯ä»¥é€šè¿‡åºåˆ—åŒ–å®ç°ï¼Œä¾‹å¦‚ JSON å’Œ
Protobufã€‚æ³¨æ„ï¼Œè¿™ç§æ–¹æ³•æå°‘ç”¨åˆ°ï¼Œ99% çš„ <code>flutter_rust_bridge</code> éƒ½ä¸ä¼šç”¨åˆ°ã€‚å¦‚æœä½ éœ€è¦å…¶ä»–ç±»å‹æ”¯æŒï¼Œè¯·æäº¤ä¸€ä¸ª
issue.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¹¶å‘"><a class="header" href="#å¹¶å‘">å¹¶å‘</a></h1>
<p>å¤šä¸ª Rust å‡½æ•°èƒ½å¤ŸåŒæ—¶è¿è¡Œï¼Œå¹¶ä¸”æ˜¯å¹¶å‘çš„è¿è¡Œã€‚å› ä¸ºæˆ‘ä»¬é»˜è®¤ä¼šä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ± å»æ‰§è¡Œ Rust
ä»£ç ã€‚ä½†æ˜¯ï¼Œä½ å¯ä»¥å®Œå…¨è‡ªå®šä¹‰è¿™é‡Œçš„è¡Œä¸ºï¼ˆç”šè‡³æ˜¯å®Œå…¨èˆå¼ƒçº¿ç¨‹æ± ï¼‰ã€‚</p>
<h2 id="ç¤ºä¾‹-9"><a class="header" href="#ç¤ºä¾‹-9">ç¤ºä¾‹</a></h2>
<p>çœ‹ä¸€ä¸‹ä¸‹é¢çš„ä¾‹å­ï¼š</p>
<pre><code class="language-rust noplayground">pub fn compute() {
  thread::sleep(Duration::from_millis(1000));
}
</code></pre>
<p>ä¸‹é¢çš„ Dart ä»£ç ä½¿ç”¨äº†å®ƒï¼š</p>
<pre><code class="language-dart">var a = compute();
var b = compute();
var c = compute();
await Future.wait([a, b, c]); // ä½ å¯èƒ½éœ€è¦æå‰å­¦ä¹  Dart ä¸­çš„ `Future` and `async` è¯»æ‡‚è¿™è¡Œä»£ç 
</code></pre>
<p>æ€»ä½“è¿è¡Œæ—¶é—´æ˜¯ 1s è€Œä¸æ˜¯ 3sï¼Œå› ä¸ºå¤šä¸ª <code>compute</code> å‡½æ•°æ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="handler"><a class="header" href="#handler">Handler</a></h1>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œfrb ä½¿ç”¨ <code>DefaultHandler</code>ï¼Œä½ å¯ä»¥å®ç°ä½ è‡ªå·±çš„ <code>Handler</code> åšä½ æƒ³åšçš„äº‹æƒ…ã€‚é¦–å…ˆï¼Œä½ éœ€è¦åœ¨ Rust æ–‡ä»¶ä¸­åˆ›å»ºä¸€ä¸ªåä¸º
<code>FLUTTER_RUST_BRIDGE_HANDLER</code> çš„å˜é‡ï¼ˆå¯èƒ½ä¼šç”¨åˆ° <code>lazy_static</code>ï¼‰ã€‚æ¥ç€ï¼Œä½ ä¸ä¸€å®šéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å®ç°äº†
<code>Handler</code> çš„ç»“æ„ä½“ï¼Œåªéœ€è¦åˆ©ç”¨ç°æœ‰çš„ <code>SimpleHandler</code>ï¼Œå¹¶è‡ªå®šä¹‰å®ƒçš„æ³›å‹å‚æ•°ï¼Œä¾‹å¦‚<code>Executor</code>ã€‚</p>
<h2 id="ç¤ºä¾‹-10"><a class="header" href="#ç¤ºä¾‹-10">ç¤ºä¾‹</a></h2>
<h3 id="ä¾‹-1-é™¤äº†-dart-ä¹‹å¤–åŒæ—¶å‘ä½ çš„åç«¯æŠ¥å‘Šé”™è¯¯"><a class="header" href="#ä¾‹-1-é™¤äº†-dart-ä¹‹å¤–åŒæ—¶å‘ä½ çš„åç«¯æŠ¥å‘Šé”™è¯¯">ä¾‹ 1: é™¤äº† Dart ä¹‹å¤–ï¼ŒåŒæ—¶å‘ä½ çš„åç«¯æŠ¥å‘Šé”™è¯¯</a></h3>
<pre><code class="language-rust noplayground">pub struct MyErrorHandler(ReportDartErrorHandler);

impl ErrorHandler for MyErrorHandler {
    fn handle_error(&amp;self, port: i64, error: handler::Error) {
        send_error_to_your_backend(&amp;error);
        self.0.handle_error(port, error)
    }

    ...
}
</code></pre>
<h3 id="ä¾‹-2-è®°å½•å‡½æ•°æ‰§è¡Œå¼€å§‹å’Œç»“æŸçš„æ—¶é—´"><a class="header" href="#ä¾‹-2-è®°å½•å‡½æ•°æ‰§è¡Œå¼€å§‹å’Œç»“æŸçš„æ—¶é—´">ä¾‹ 2: è®°å½•å‡½æ•°æ‰§è¡Œå¼€å§‹å’Œç»“æŸçš„æ—¶é—´</a></h3>
<pre><code class="language-rust noplayground">pub struct MyExecutor(ThreadPoolExecutor&lt;MyErrorHandler&gt;);

impl Executor for MyExecutor {
    fn execute&lt;TaskFn, TaskRet&gt;(&amp;self, wrap_info: WrapInfo, task: TaskFn) {
        let debug_name_string = wrap_info.debug_name.to_string();
        self.thread_pool_executor
            .execute(wrap_info, move |task_callback| {
                Self::log_around(&amp;debug_name_string, move || task(task_callback))
            })
    }
}

impl MyExecutor {
    fn log_around&lt;F, R&gt;(debug_name: &amp;str, f: F) -&gt; R where F: FnOnce() -&gt; R {
        let start = Instant::now();
        debug!(&quot;(Rust) execute [{}] start&quot;, debug_name);
        let ret = f();
        debug!(&quot;(Rust) execute [{}] end delta_time={}ms&quot;, debug_name, start.elapsed().as_millis());
        ret
    }
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åˆå§‹åŒ–"><a class="header" href="#åˆå§‹åŒ–">åˆå§‹åŒ–</a></h1>
<p>å¦‚æœä½ éœ€è¦è¿™ä¸ªç‰¹æ€§ï¼Œå»çœ‹ä¸€ä¸‹ Flutter ä¾§çš„ <code>FlutterRustBridgeSetupMixin</code> ï¼ˆæ–‡æ¡£å°šæœªå®Œæˆï¼Œå¦‚æœä½ æœ‰é—®é¢˜ï¼Œè®°å¾—åˆ›å»ºä¸€ä¸ª
issueï¼‰ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-ä¸­çš„å¼‚æ­¥"><a class="header" href="#rust-ä¸­çš„å¼‚æ­¥">Rust ä¸­çš„å¼‚æ­¥</a></h1>
<p>å¦‚æœä½ æƒ³åœ¨ Rust ä¸­ä½¿ç”¨ async / await æˆ–è€…æ˜¯è¿”å›ä¸€ä¸ª Futureï¼Œè¯·çœ‹
<a href="feature/../article/async_in_rust.html">è¿™ä¸ªæ–‡æ¡£</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¤šæ–‡ä»¶"><a class="header" href="#å¤šæ–‡ä»¶">å¤šæ–‡ä»¶</a></h1>
<p>åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼ŒæŠŠæ‰€æœ‰çš„æ–‡ä»¶éƒ½æ”¾åœ¨ä¸€ä¸ª <code>api.rs</code> æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬é€šå¸¸æƒ³æŠŠå®ƒåˆ†ç¦»åˆ° <code>api_of_one_module.rs</code>,
<code>api_of_another_module.rs</code> ç­‰å¤šä¸ªæ–‡ä»¶é‡Œã€‚</p>
<p>ä½ åªéœ€è¦æŒ‡å®šæ‰€æœ‰çš„ Rust è¾“å…¥æ–‡ä»¶ä»¥åŠè¾“å‡ºä½ç½®å³å¯ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre><code class="language-shell">flutter_rust_bridge_codegen \
  --rust-input &quot;$REPO_DIR/native/src/api_1.rs&quot; &quot;$REPO_DIR/native/src/api_2.rs&quot; \
  --dart-output &quot;$REPO_DIR/lib/bridge_generated_api_1.dart&quot; &quot;$REPO_DIR/lib/bridge_generated_api_2.dart&quot; \
  --class-name ApiClass1 ApiClass2 \
  --rust-output generated_api_1 generated_api_2
</code></pre>
<p>æ›´å¤šä¿¡æ¯åœ¨ <a href="feature/../article/generate_multiple_files.html">è¿™ç¯‡æ–‡ç« </a>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åœ¨-buildrs-ä¸­è¿è¡Œ"><a class="header" href="#åœ¨-buildrs-ä¸­è¿è¡Œ">åœ¨ <code>build.rs</code> ä¸­è¿è¡Œ</a></h1>
<p>æ‰§è¡Œä»£ç ç”Ÿæˆå™¨æœ‰ä¸¤ç§æ–¹æ³•ã€‚ç¬¬ä¸€ç§ä¹Ÿæ˜¯æœ€æ˜æ˜¾çš„æ–¹æ³•æ˜¯ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ <code>flutter_rust_bridge</code>ã€‚</p>
<p>å¦ä¸€ç§æ–¹æ³•æ—¶é›†æˆåˆ° <code>build.rs</code> é‡Œã€‚é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œä»£ç ç”Ÿæˆå™¨ä¼šåœ¨ç¼–è¯‘ Rust é¡¹ç›®æ—¶è‡ªåŠ¨è§¦å‘ã€‚æ›´å¤šä¿¡æ¯è¯·çœ‹
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/frb_example/pure_dart/rust/build.rs">build.rs</a>
æ–‡ä»¶ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¯å–æ¶ˆçš„ä»»åŠ¡"><a class="header" href="#å¯å–æ¶ˆçš„ä»»åŠ¡">å¯å–æ¶ˆçš„ä»»åŠ¡</a></h1>
<p>å½“ Rust ä»£ç çš„è®¡ç®—é‡å¾ˆå¤§æ—¶ï¼Œä½ å¯èƒ½ä¼šåœ¨ä¸­é€”æƒ³è¦å–æ¶ˆ (ä¾‹å¦‚ç”¨æˆ·ä¸­é€”ç‚¹å‡»äº†å–æ¶ˆ)ï¼Œè¿™æ ·å°±èƒ½èŠ‚çº¦å®è´µçš„è®¡ç®—èµ„æºã€‚</p>
<p>å®‰è£…ï¼šç›®å‰ï¼Œè¯¥åŠŸèƒ½å·²ç»å®Œæˆï¼Œå¹¶ä¸”æˆ‘å·²ç»åœ¨æˆ‘è‡ªå·±çš„ app ä¸­ä½¿ç”¨äº†å¾ˆé•¿æ—¶é—´ã€‚ï¼ˆä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰å°†è¿™ä¸ª PR åˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼Œå› ä¸ºæˆ‘éœ€è¦æ—¶é—´å†³å®šå¦‚ä½•æŠŠè¿™éƒ¨åˆ†ä»£ç æ”¾åˆ°
<code>api.rs</code> ä¸­ï¼‰ï¼Œå› æ­¤å¦‚æœä½ éœ€è¦çš„è¯ï¼Œè¯·ç›´æ¥å°†
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/pull/333">è¿™é‡Œçš„ä»£ç  (#333)</a>
å¤åˆ¶åˆ°ä½ çš„é¡¹ç›®é‡Œï¼Œç„¶ååƒå¹³å¸¸ä¸€æ ·ä½¿ç”¨å³å¯ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¯¹è±¡æ± "><a class="header" href="#å¯¹è±¡æ± ">å¯¹è±¡æ± </a></h1>
<p>å½“ä½ çš„ Rust ä¾§æœ‰ä¸€äº›å¤§å‹çš„å¯¹è±¡æ—¶ï¼Œä½ å¯èƒ½ä¸æƒ³è®©å®ƒåœ¨ Rust å’Œ Dart ä¹‹é—´åå¤å¤åˆ¶ã€‚è¿™æ˜¯ï¼Œå¯¹è±¡æ± å°±æ´¾ä¸Šç”¨åœºäº†ï¼šä½ åªéœ€è¦åœ¨ Rust å’Œ Dart
ä¹‹é—´ä¼ é€’ä¸€ä¸ª &quot;å¯¹è±¡å¥æŸ„&quot;ï¼ˆå®é™…ä¸Šåªæ˜¯å‡ ä¸ªæ•´æ•°ï¼‰ï¼ŒRust ä¼šæŠŠè¿™ä¸ªå¥æŸ„è½¬æ¢ä¸ºçœŸå®çš„å¯¹è±¡ã€‚</p>
<p>å®‰è£…ï¼šå’Œ <a href="feature/cancelable_task.html">cancelable tasks</a> ä¸€æ ·ï¼Œè¯·æŸ¥çœ‹æ–‡æ¡£ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ‚é¡¹"><a class="header" href="#æ‚é¡¹">æ‚é¡¹</a></h1>
<h2 id="æŠŠç”Ÿæˆä»£ç çš„å®šä¹‰å’Œå®ç°åˆ†å¼€"><a class="header" href="#æŠŠç”Ÿæˆä»£ç çš„å®šä¹‰å’Œå®ç°åˆ†å¼€">æŠŠç”Ÿæˆä»£ç çš„å®šä¹‰å’Œå®ç°åˆ†å¼€</a></h2>
<p>ç”Ÿæˆçš„ <code>bridge_generated.dart</code> æ–‡ä»¶é»˜è®¤æƒ…å†µä¸‹ä¼šåŒ…å« API çš„å®šä¹‰å’Œå®ç°ã€‚åœ¨ç”Ÿæˆæ—¶ï¼ŒåŠ ä¸Š <code>--dart-decl-output</code>
å‚æ•°ï¼Œå®ƒä»¬å°±ä¼šè¢«åˆ†å¼€ï¼Œå¹¶ä¸”å®šä¹‰ä¸­ä¸ä¼šåŒ…å«ä»»ä½•ç±»ä¼¼äº <code>dart:ffi</code> çš„ä¸œè¥¿ã€‚</p>
<p>æ›´å¤šä¿¡æ¯ï¼š<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/298">#298</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä»æ¨¡æ¿åˆ›å»ºæ–°é¡¹ç›®"><a class="header" href="#ä»æ¨¡æ¿åˆ›å»ºæ–°é¡¹ç›®">ä»æ¨¡æ¿åˆ›å»ºæ–°é¡¹ç›®</a></h1>
<p>åœ¨è¿™ä¸€ç« é‡Œï¼Œæˆ‘ä»¬å°†ä»æ¨¡æ¿åˆ›å»ºä½ è‡ªå·±çš„é¡¹ç›®ã€‚çœ‹èµ·æ¥æœ‰ç‚¹é•¿ï¼Œè¿™åªæ˜¯å› ä¸ºæˆ‘ä»¬æƒ³è®²æ¸…æ¥šä½ å¯èƒ½é‡åˆ°çš„æ¯ä¸ªç»†èŠ‚ã€‚</p>
<p><strong>æ³¨æ„:</strong> è™½ç„¶è¿‡ç¨‹å¾ˆå¤æ‚ï¼Œä½†æ˜¯ç»å¤§å¤šæ•°åŸå› éƒ½ä¸æ˜¯æ¥æºäºè¯¥åº“æœ¬èº«ï¼Œä½¿ç”¨åŸå§‹çš„ Rust/Flutter FFI å’Œå®ƒä¸€æ ·å¤æ‚ã€‚æ¢å¥è¯è¯´ï¼ŒçœŸæ­£è€—æ—¶çš„æ˜¯æ­å»º
Dart/Flutter + Rust å·¥å…·é“¾ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®"><a class="header" href="#åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®">åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®</a></h1>
<p>é¦–å…ˆä½¿ç”¨ <a href="https://github.com/Desdaemon/flutter_rust_bridge_template">flutter_rust_bridge_template</a> çš„æ¨¡æ¿åˆ›å»ºä¸€ä¸ªä»“åº“ã€‚è¿™ä¸ªæ¨¡æ¿åœ¨å¤§å¤šæ•° Flutter æ”¯æŒçš„å¹³å°åº”è¯¥å¯ä»¥é€šè¿‡
<code>flutter run</code> ç›´æ¥è¿è¡Œã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å®‰å“è®¾ç½®"><a class="header" href="#å®‰å“è®¾ç½®">å®‰å“è®¾ç½®</a></h1>
<p>å¯¹äºå®‰å“å¹³å°ï¼Œä½ éœ€è¦å®‰è£…ä¸€éƒ¨åˆ†ç»„ä»¶ï¼š</p>
<h2 id="rust-ç¼–è¯‘ç›®æ ‡"><a class="header" href="#rust-ç¼–è¯‘ç›®æ ‡">Rust ç¼–è¯‘ç›®æ ‡</a></h2>
<p>äº¤å‰ç¼–è¯‘åˆ°å®‰å“éœ€è¦ä¸€äº›é¢å¤–çš„ç»„ä»¶ï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤å®‰è£…ï¼š</p>
<pre><code class="language-shell">rustup target add \
    aarch64-linux-android \
    armv7-linux-androideabi \
    x86_64-linux-android \
    i686-linux-android
</code></pre>
<h2 id="jdk-8"><a class="header" href="#jdk-8">JDK 8</a></h2>
<p>Android Studio ä¾èµ–äº <code>javax</code> åº“å­˜åœ¨äº Java è¿è¡Œæ—¶ï¼ŒéªŒè¯å®‰è£…æˆåŠŸçš„å”¯ä¸€å¯é çš„æ–¹æ³•æ˜¯å®‰è£…ä¸€ä¸ªè€ç‰ˆæœ¬çš„ Javaã€‚åœ¨ç±» Unix
ç³»ç»Ÿä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨ <a href="https://asdf-vm.com/">asdf</a> æˆ–è€…ç±»ä¼¼çš„å·¥å…·å»ç®¡ç†ä½ çš„ Java ç‰ˆæœ¬ã€‚æ¨¡æ¿åœ¨ <code>.tool-versions</code>
æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ªå·²çŸ¥çš„å¯ä»¥æ­£å¸¸è¿è¡Œçš„ Java ç‰ˆæœ¬ã€‚</p>
<blockquote>
<p>è¯‘è€…æ³¨ï¼š<code>asdf</code> æ˜¯ä¸€ä¸ªç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼Œ<code>.tool-versions</code> æ˜¯ asdf çš„é…ç½®æ–‡ä»¶</p>
</blockquote>
<h2 id="android-ndk"><a class="header" href="#android-ndk"><a href="https://developer.android.com/ndk">Android NDK</a></a></h2>
<p>å®‰è£…ï¼š</p>
<blockquote>
<p>Android Studio &gt; SDK Manager &gt; SDK Tools &gt; uncheck Hide Obsolete Packages &gt;
NDK (version 22)</p>
</blockquote>
<blockquote>
<p>è¯‘è€…æ³¨ï¼šæ‚¨ä¹Ÿå¯ä»¥ä¸ä¸‹è½½ Android Studioï¼Œç›´æ¥é€šè¿‡ sdkmanager åœ¨å‘½ä»¤è¡Œå®‰è£…ã€‚</p>
</blockquote>
<p><a href="https://developer.android.com/ndk">Android NDK</a>, æˆ–è€…è¯´ Native Development Kit, ç¡®ä¿äº†ä½¿ç”¨å…¶ä»–è¯­è¨€ç¼–å†™çš„ä»£ç å¯ä»¥é€šè¿‡ JNI æˆ–è€…è¯´
<a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/jniTOC.html">Java Native Interface</a> è¿è¡Œåœ¨ JVM ä¸Šã€‚æˆ‘ä»¬ä¼šæŠŠ Cargo åˆ›å»ºçš„åŠ¨æ€è¿æ¥åº“å’Œé¡¹ç›®çš„æ‰“åŒ…ç»“æœæ‰“åŒ…åœ¨ä¸€èµ·ã€‚</p>
<p>è·Ÿç€ä¸Šé¢çš„æ­¥éª¤ï¼Œä½ åº”è¯¥ä¼šæŠŠ NDK å®‰è£…åˆ°äº† <code>$ANDROID_SDK_HOME/ndk</code> æ–‡ä»¶å¤¹ï¼ŒANDROID_SDK_HOME é€šå¸¸æ˜¯ï¼š</p>
<ul>
<li>Windows: <code>%APPDATA%\Local\Android\sdk</code></li>
<li>MacOS: <code>~/Library/Android/sdk</code></li>
<li>Linux: é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ ANDROID_SDK_HOME, æˆ–è€… <code>~/Android/sdk</code></li>
</ul>
<p><a href="https://github.com/rust-lang/rust/pull/85806">An issue</a> åœ¨æ„å»º Rust <code>core</code> åº“æ—¶ï¼Œåªæœ‰ NDK 22 å’Œæ›´æ—©ç‰ˆæœ¬å¯ä»¥ä½¿ç”¨ã€‚</p>
<h2 id="android_ndk-gradle-é…ç½®"><a class="header" href="#android_ndk-gradle-é…ç½®"><code>ANDROID_NDK</code> Gradle é…ç½®</a></h2>
<pre><code class="language-shell">echo &quot;ANDROID_NDK=(path to NDK)&quot; &gt;&gt; ~/.gradle/gradle.properties
</code></pre>
<p>ä¸‹ä¸€æ­¥ï¼Œä½ éœ€è¦è®¾ç½® NDK å¯¹ Gradle å¯è§ã€‚æ ¹æ®ä½ çš„ç³»ç»Ÿæœ‰ä¸åŒçš„è®¾ç½®æ–¹æ³•ï¼Œä½†æ˜¯ä¸€èˆ¬éƒ½å¯ä»¥åœ¨ <code>~/.gradle/gradle.properties</code>
é‡Œé…ç½®ä»¥ä¸‹å†…å®¹ï¼š</p>
<pre><code>ANDROID_NDK=(path to NDK)
</code></pre>
<p>æˆ–è€…æ˜¯ä¿®æ”¹å½“å‰é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œandroid ç›®å½•é‡Œçš„åŒåæ–‡ä»¶ã€‚</p>
<h2 id="cargo-ndk"><a class="header" href="#cargo-ndk"><a href="https://github.com/bbqsrc/cargo-ndk">cargo-ndk</a></a></h2>
<pre><code class="language-shell">cargo install cargo-ndk --version 2.6.0
</code></pre>
<p><a href="https://github.com/bbqsrc/cargo-ndk">cargo-ndk</a> æ˜¯ä¸€ä¸ª cargo æ’ä»¶ï¼Œå®ƒèƒ½å¤Ÿå°†ä»£ç ç¼–è¯‘åˆ°é€‚åˆçš„ JNI è€Œä¸éœ€è¦é¢å¤–çš„é…ç½®ã€‚è¿è¡Œä¸Šè¿°å‘½ä»¤è¿›è¡Œå®‰è£…ã€‚cargo-ndk 2.7.0
ç‰ˆæœ¬å¼•å…¥äº†ä¸€äº›å˜åŒ–ï¼Œç ´åäº†å¯¹ NDK 22 ç‰ˆæœ¬çš„æ”¯æŒï¼Œæ‰€ä»¥ ç›®å‰å¿…é¡»ä½¿ç”¨ 2.6.0ã€‚</p>
<h2 id="å¯é€‰çš„-ndk-è®¾ç½®"><a class="header" href="#å¯é€‰çš„-ndk-è®¾ç½®">å¯é€‰çš„ NDK è®¾ç½®</a></h2>
<p>ä½ ä¹Ÿå¯ä»¥é€‰æ‹©æœ€æ–°ç‰ˆæœ¬çš„ NDKï¼Œå®ƒæ¯” 22 ç‰ˆæœ¬è¦å¥½ã€‚ä½†æ˜¯ä½ éœ€è¦ Hack
éƒ¨åˆ†ä»£ç å»è§£å†³ä¸€ä¸ªæŠ¥é”™ï¼š<a href="https://github.com/bbqsrc/cargo-ndk/issues/22">unable to find library -lgcc error</a>.</p>
<h3 id="android-ndk-1"><a class="header" href="#android-ndk-1">Android NDK</a></h3>
<p>å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ NDK:</p>
<blockquote>
<p>Android Studio &gt; SDK Manager &gt; SDK Tools &gt; NDK (Side by side)</p>
</blockquote>
<h3 id="cargo-ndk-1"><a class="header" href="#cargo-ndk-1"><a href="https://github.com/bbqsrc/cargo-ndk">cargo-ndk</a></a></h3>
<p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ç‰ˆæœ¬é«˜äº 22 çš„ NDKï¼Œé‚£ä¹ˆä½ éœ€è¦ <code>cargo-ndk</code> 2.7.0 æˆ–è€…æ›´æ–°ç‰ˆæœ¬ã€‚</p>
<pre><code>cargo install cargo-ndk --version ^2.7.0
</code></pre>
<p>A workaround may be under development in the cargo-ndk project. Until it is
finished, you need to manually create four text files to redirect calls from
libgcc to libunwind (<a href="https://github.com/rust-lang/rust/pull/85806#issuecomment-1096266946">reference</a>):</p>
<ol>
<li>
<p>Find out all the 4 folders containing file <code>libunwind.a</code>.</p>
<ul>
<li>
<p>On Windows, it is similar to:</p>
<pre><code>C:\Users\Administrator\AppData\Local\Android\Sdk\ndk\24.0.8215888\toolchains\llvm\prebuilt\windows-x86_64\lib64\clang\14.0.1\lib\linux\x86_64\
</code></pre>
</li>
<li>
<p>On macOS Monterey, it is similar to:</p>
<pre><code>~/Library/Android/sdk/ndk/24.0.8215888/toolchains/llvm/prebuilt/darwin-x86_64/lib64/clang/14.0.1/lib/linux/x86_64/
</code></pre>
</li>
</ul>
<p>The three other folders end with <code>aarch64</code>, <code>arm</code>, <code>i386</code> instead of
<code>x86_64</code>.</p>
</li>
<li>
<p>Create 4 text files named <code>libgcc.a</code> in the four folders mentioned above with
this contents</p>
<pre><code>INPUT(-lunwind)
</code></pre>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ios-è®¾ç½®"><a class="header" href="#ios-è®¾ç½®">iOS è®¾ç½®</a></h1>
<p>iOS éœ€è¦ä¸€äº›é¢å¤–çš„äº¤å‰ç¼–è¯‘ç›®æ ‡ï¼š</p>
<pre><code class="language-bash"># 64 bit targets (çœŸæœº &amp; æ¨¡æ‹Ÿå™¨):
rustup target add aarch64-apple-ios x86_64-apple-ios
# New simulator target for Xcode 12 and later
rustup target add aarch64-apple-ios-sim
# 32 bit targets (ä½ åº”è¯¥ä¸éœ€è¦è¿™ä¸ª):
rustup target add armv7-apple-ios i386-apple-ios
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="web-è®¾ç½®"><a class="header" href="#web-è®¾ç½®">Web è®¾ç½®</a></h1>
<p>ç›®å‰ä¸ºæ­¢ï¼ŒWeb æ”¯æŒå°šæœªå®Œæˆ
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/315">fzyzcjy/flutter_rust_bridge#315</a>ã€‚</p>
<p>è€ƒè™‘ä¸€ä¸‹è¯„è®ºæˆ–è€…å»ºè®®è®©æˆ‘ä»¬äº†è§£æ‚¨å¯¹è¯¥åŠŸèƒ½çš„éœ€æ±‚ï¼</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="windows-å’Œ-linux"><a class="header" href="#windows-å’Œ-linux">Windows å’Œ Linux</a></h1>
<p>Windows å’Œ Linux å…±äº«åŒä¸€å¥—ç¼–è¯‘ç³»ç»Ÿï¼ˆCMakeï¼‰ï¼Œä»é›¶å¼€å§‹è®¾ç½®è¿™ä¸¤ä¸ªå¹³å°ä¹Ÿéå¸¸ç®€å•ã€‚æ¨¡æ¿è¯¥æ¨¡æ¿ä½¿ç”¨åˆ°äº† <a href="https://github.com/corrosion-rs/corrosion">Corrosion</a>
åº“æ¥åŠ å¿«è¿™ä¸€è¿‡ç¨‹ï¼Œå®‰è£… Corrosion éœ€è¦å…ˆå…‹éš†ä»£ç ï¼Œå¹¶åˆå§‹åŒ–ã€‚è·Ÿç€ <a href="https://github.com/corrosion-rs/corrosion#installation">æœ¬æŒ‡å—</a> å­¦ä¹ å¦‚ä½•å°† <a href="https://github.com/corrosion-rs/corrosion">Corrosion</a>
å®‰è£…åˆ°ä½ çš„ç³»ç»Ÿä¸Šã€‚å®‰è£…å®Œæˆåï¼Œè¯·ç»§ç»­ä¿®æ”¹ <code>rust.cmake</code>ã€‚</p>
<pre><code class="language-diff">-# find_package(Corrosion REQUIRED)
+find_package(Corrosion REQUIRED)

-include(FetchContent)
-
-FetchContent_Declare(
-    Corrosion
-    GIT_REPOSITORY https://github.com/AndrewGaspar/corrosion.git
-    GIT_TAG origin/master # Optionally specify a version tag or branch here
-)
-
-FetchContent_MakeAvailable(Corrosion)
</code></pre>
<h2 id="troubleshooting-cmake-on-linux"><a class="header" href="#troubleshooting-cmake-on-linux">Troubleshooting: CMake on Linux</a></h2>
<p><a href="https://github.com/corrosion-rs/corrosion">Corrosion</a> å¯¹ CMake çš„æœ€ä½ç‰ˆæœ¬éœ€æ±‚æ˜¯ 3.12ï¼Œè¿™ä¸æ˜¯ <code>CMakeLists.txt</code> çš„é»˜è®¤ç‰ˆæœ¬ã€‚æ‰€ä»¥ä½ éœ€è¦æ‰‹åŠ¨ä¿®æ”¹
<code>linux/CMakeLists.txt</code>:</p>
<pre><code class="language-diff">-cmake_minimum_required(VERSION 3.10)
+cmake_minimum_required(VERSION 3.12)
</code></pre>
<p>ä½†æ˜¯å®ƒå¸¦æ¥äº†å¦ä¸€ä¸ªé—®é¢˜ï¼Œå®ƒä¸å…è®¸ä½ é€šè¿‡ Flutter SDK é€šè¿‡ Snap æ„å»ºï¼Œå› ä¸ºä»–çš„æ„å»ºè¿‡ç¨‹å’Œ CMake 3.10
ç»‘å®šã€‚å¯èƒ½çš„è¯ï¼Œå»ºè®®ä½¿ç”¨å‘½ä»¤è¡Œæ‰‹åŠ¨å®‰è£…
Flutterã€‚<a href="https://github.com/canonical/flutter-snap/pull/61">canonical/flutter-snap#61</a>
åœ°ã€‚</p>
<p>ä¸€ä¸ªå˜é€šçš„æ–¹æ³•æ˜¯å¿½ç•¥ <code>rust.cmake</code> å¹¶æ‰‹åŠ¨é…ç½® CMake æ¥æ„å»ºå’Œæ†ç»‘ Rust åº“ã€‚ä¾‹å¦‚
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/318#issuecomment-1038751426">æœ¬è¯„è®º</a>
æ˜¯åœ¨ ARM Linux ä¸Šä½¿ç”¨ Flutterã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å…¶ä»–å¹³å°"><a class="header" href="#å…¶ä»–å¹³å°">å…¶ä»–å¹³å°</a></h1>
<p>å¯¹äºæ‰€æœ‰å‰©ä¸‹çš„å¹³å°ï¼ŒåŸºæœ¬æ²¡æœ‰éœ€è¦è®¾ç½®çš„æ­¥éª¤ã€‚é™¤äº†åœ¨ä¸‹é¢åˆ—è¡¨ä¸­æ ‡æ³¨çš„ã€‚<a href="https://docs.flutter.dev/desktop">Desktop support for Flutter</a>ã€‚å¦‚æœä½ è¦æŸ¥çœ‹å½“å‰è¿›å±•ï¼Œè¿è¡Œ
<code>flutter -v</code> å®ƒä¼šæ˜¾ç¤ºä½ çš„å·¥å…·é“¾çš„çŠ¶æ€å’Œä»»ä½•å¯æ“ä½œçš„æ­¥éª¤ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ¨¡æ¿ä¹‹æ—…"><a class="header" href="#æ¨¡æ¿ä¹‹æ—…">æ¨¡æ¿ä¹‹æ—…</a></h1>
<p><img src="template/success.png" alt="success-screen" /></p>
<p>ç¥è´ºï¼ğŸ‰ ç°åœ¨ä½ åº”è¯¥æœ‰ä¸€ä¸ªå¯ä»¥æ­£å¸¸è¿è¡Œçš„ Flutter åº”ç”¨äº†ï¼Œå¹¶ä¸”é…å¤‡äº† ä¸€ä¸ª Rust è¿è¡Œæ—¶ç»„ä»¶ã€‚æœ¬èŠ‚æ—¨åœ¨æ¸©å’Œåœ°ä»‹ç» Rust ä¸ç°æœ‰ Flutter
å·¥å…·é“¾é›†æˆçš„ç»†èŠ‚ã€‚ä¸ç”¨æ‹…å¿ƒï¼Œä½ å¯ä»¥ç›´æ¥è·³åˆ°<a href="template/generate.html">ç”Ÿæˆä»£ç </a>ä¸€èŠ‚æ¥å­¦ä¹ å¦‚ä½•ç¼–å†™æ–°çš„ä»£ç ã€‚æˆ–è€…ç›´æ¥æŸ¥çœ‹
<a href="template/../integrate.html">é›†æˆåˆ°ç°æœ‰é¡¹ç›®</a> ä¸€èŠ‚ï¼Œå°† Rust æ·»åŠ åˆ°ç°æœ‰çš„ Flutter é¡¹ç›®</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nativesrcapirs"><a class="header" href="#nativesrcapirs"><code>native/src/api.rs</code></a></h1>
<p>è¿™æ˜¯åº“é»˜è®¤å…¥å£æ–‡ä»¶ï¼Œåªæœ‰å®šä¹‰åœ¨è¿™é‡Œçš„å‡½æ•°æ‰èƒ½è¿›è¡Œä»£ç ç”Ÿæˆã€‚å‡½æ•°å¯ä»¥å¼•ç”¨å®šä¹‰åœ¨å…¶ä»–æ–‡ä»¶ä¸­çš„ç±»å‹ï¼Œä½œä¸ºå‚æ•°æˆ–è€…è¿”å›å€¼ç±»å‹ã€‚ä½†æ˜¯è¿™äº›ç±»å‹å¿…é¡»é€šè¿‡ <code>pub use</code>
å¯¼å…¥ï¼Œä»¥ä¾¿å®ƒä»¬åœ¨ <code>native/src/bridge_generated.rs</code> ä¸­å¯è§ã€‚</p>
<p>åªæœ‰å®šä¹‰åœ¨å½“å‰ crate çš„ç±»å‹æœ‰èµ„æ ¼è¿›è¡Œä»£ç ç”Ÿæˆã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œç»“æ„å’Œæšä¸¾çš„å­—æ®µä¹Ÿéœ€è¦ç¬¦åˆä¸Šè¿°æ¡ä»¶ã€‚</p>
<p>è¦æŸ¥çœ‹ç›®å‰ç¬¦åˆæ¡ä»¶çš„å‡½æ•°å’Œç±»å‹ï¼Œè¯·çœ‹
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/frb_example/pure_dart/rust/src/api.rs">ç¤ºä¾‹æ–‡ä»¶</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="androidappbuildgradle"><a class="header" href="#androidappbuildgradle"><code>android/app/build.gradle</code></a></h1>
<p>è¯¥æ–‡ä»¶æ˜¯ Flutter æ„å»ºå®‰å“ app æ‰€éœ€é»˜è®¤æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>æ¨¡æ¿ä¸­æ³¨å…¥äº†é¢å¤–çš„é’©å­ï¼Œä»¥ä¾¿åœ¨è°ƒç”¨ <code>flutter run</code> æ—¶è¿è¡Œ
<a href="https://lib.rs/crates/cargo-ndk"><code>cargo-ndk</code></a>ã€‚è¿™ä¸ªæ–¹æ³•åœ¨ä»¥ä¸‹æ–‡ç« ä¸­æœ‰æ›´è¯¦ç»†çš„è§£é‡Š
<a href="template/.../integrate/android_tasks.html">Hooking onto tasks</a>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nativenativexcodeproj"><a class="header" href="#nativenativexcodeproj"><code>native/native.xcodeproj</code></a></h1>
<p>è¿™æ˜¯ç”± <a href="https://lib.rs/crates/cargo-xcode"><code>cargo-xcode</code></a> ç”Ÿæˆçš„ Xcode é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œç”¨äºç”Ÿæˆ Rust
ä»£ç åº“ã€‚</p>
<p>iOS å’Œ MacOS çš„æ ¹é¡¹ç›®ä¼šæŠŠè¿™ä¸ªæ–‡ä»¶å¤¹ä½œä¸º <em>å­é¡¹ç›®</em> å¯¼å…¥ï¼Œå¹¶åœ¨ build æ—¶ä¾èµ–å®ƒã€‚</p>
<p>ä¸ºä½ çš„ç›®æ ‡è®¾å¤‡é…ç½®åˆé€‚çš„ <code>cate-type</code> éå¸¸é‡è¦ã€‚ç¡®ä¿ä½ çš„ <code>Cargo.toml</code> ä¸­æœ‰è¿™å‡ è¡Œï¼š</p>
<pre><code class="language-toml">[lib]
crate-type = [&quot;lib&quot;, &quot;cdylib&quot;, &quot;staticlib&quot;]
</code></pre>
<p>ä¸€äº›è¯´æ˜ï¼š</p>
<ul>
<li><code>lib</code> å¯¹äºéåº“é¡¹ç›®æ—¶å¿…é¡»çš„ï¼Œä¾‹å¦‚ tests å’Œ benchmarks</li>
<li><code>staticlib</code> å¯¹ iOS æ˜¯å¿…é¡»çš„</li>
<li><code>cdylib</code> æ˜¯ç”¨äºå…¶ä»–å¹³å°</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="justfile"><a class="header" href="#justfile"><code>justfile</code></a></h1>
<p>è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº† <a href="https://github.com/casey/just">just</a> å‘½ä»¤çš„ &quot;é…æ–¹&quot;ï¼Œå®ƒå’Œ <code>make</code> ä¸ MakeFile ç±»ä¼¼ã€‚<a href="https://github.com/casey/just">just</a> ä½¿ç”¨ Rust æ„å»ºï¼Œå¹¶åœ¨ä¼ ç»Ÿçš„
Makefile è¯­æ³•åŸºç¡€ä¸Šåšäº†æ”¹è¿›ï¼Œæ›´å¥½åœ°æ”¯æŒæ¡ä»¶è¯­å¥ã€å‚æ•°ã€è·¨å¹³å°å…¼å®¹æ€§ç­‰ã€‚</p>
<p>åœ¨æŸäº›è®¾ç½®ä¸­ï¼Œé€šè¿‡ <code>brew install llvm</code> å®‰è£…ä¸ä¼šä½¿ LLVM åº“å¯¹å…¶ä»–å¯æ‰§è¡Œæ–‡ä»¶å¯è§ï¼Œè¿™ä¼šç»™ <code>ffigen</code> å¸¦æ¥äº†é—®é¢˜ã€‚
<code>flutter_rust_bridge_codegen</code> ä½¿ç”¨å®ƒä½œä¸º C-to-Dart çš„ä»£ç ç”Ÿæˆå™¨ã€‚</p>
<p>è¿è¡Œ <code>just</code> é»˜è®¤ä¼šè¿è¡Œ <code>gen</code> å’Œ <code>lint</code> ä»»åŠ¡ã€‚</p>
<h2 id="just-gen"><a class="header" href="#just-gen"><code>just gen</code></a></h2>
<p>ç”Ÿæˆ Rust ç»‘å®šå¹¶æŠŠå®ƒä»¬æ”¾åˆ°æ­£ç¡®çš„æ–‡ä»¶å¤¹ã€‚<a href="template/generate.html">Generating new code</a>
è¿™éƒ¨åˆ†ä¼šè¯¦ç»†ä»‹ç»å¦‚ä½•ä¿®æ”¹ä»»åŠ¡è„šæœ¬ä»¥æ‰§è¡Œé™„åŠ ä»»åŠ¡ã€‚</p>
<h2 id="just-lint"><a class="header" href="#just-lint"><code>just lint</code></a></h2>
<p>è¿è¡Œ Dart å’Œ Rust é»˜è®¤çš„ linterã€‚</p>
<h2 id="just-clean"><a class="header" href="#just-clean"><code>just clean</code></a></h2>
<p>è¿è¡Œ Flutter å’Œ Rust é»˜è®¤çš„ clean å‘½ä»¤ã€‚é€šå¸¸åœ¨è°ƒè¯•å’Œ build ç›¸å…³çš„é—®é¢˜æ—¶æœ‰ç”¨ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rustcmake"><a class="header" href="#rustcmake"><code>rust.cmake</code></a></h1>
<p>åœ¨ <code>windows</code> å’Œ <code>linux</code> ä¸­æœ‰ä¸¤ä¸ªç›¸åŒçš„æ–‡ä»¶ï¼Œåä¸º<code>rust.cmake</code>ã€‚
è¿™äº›æ–‡ä»¶åŒ…å«åœ¨ç°æœ‰çš„<code>CMakeLists.txt</code>ä¸­ï¼ŒFlutter ä½¿ç”¨å®ƒæ¥ç¼–è¯‘å¯¹åº”å¹³å°çš„åº”ç”¨ç¨‹åºã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä»£ç ç”Ÿæˆ"><a class="header" href="#ä»£ç ç”Ÿæˆ">ä»£ç ç”Ÿæˆ</a></h1>
<p>è¿™ä¸€éƒ¨åˆ†éœ€è¦æ‚¨å·²ç»è·Ÿéš <a href="template/template.html">åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®</a> ç« èŠ‚ï¼Œå¹¶æˆåŠŸè¿è¡Œ <code>flutter run</code> åˆ°æ‚¨çš„è®¾å¤‡ä¸Šã€‚</p>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œç¨‹åºè¿è¡Œçš„æ‰€æœ‰å¿…è¦ä»£ç éƒ½å·²ç»æä¾›ï¼Œæ²¡æœ‰é¢å¤–çš„ä¸œè¥¿éœ€è¦å®‰è£…ã€‚ç°åœ¨æˆ‘ä»¬å°†æ³¨æ„åŠ›é›†ä¸­åœ¨å¦‚ä½•ç¼–å†™ Rust ä»£ç ï¼Œç”Ÿæˆå¿…è¦çš„èƒ¶æ°´ä»£ç å¹¶åœ¨ Dart ä¸­ä½¿ç”¨ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å®‰è£…ä»£ç ç”Ÿæˆå™¨"><a class="header" href="#å®‰è£…ä»£ç ç”Ÿæˆå™¨">å®‰è£…ä»£ç ç”Ÿæˆå™¨</a></h1>
<p>æ›´å¤šä¿¡æ¯åœ¨ <a href="template/../integrate/deps.html">å®‰è£…ä¾èµ–</a> éƒ¨åˆ†ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ·»åŠ æ–°ä»£ç "><a class="header" href="#æ·»åŠ æ–°ä»£ç ">æ·»åŠ æ–°ä»£ç </a></h1>
<p>æˆ‘ä»¬æƒ³è¦è·¨å¹³å°ï¼Œå¹¶ä¸å…³å¿ƒä»£ç åˆ°åº•æ˜¯åœ¨ Inter è¿˜æ˜¯ Apple Silicon
ä¸Šè¿è¡Œã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦ä¿ç•™å¹³å°ä¿¡æ¯ï¼Œä»¥ä¾¿åº•å±‚ä»£ç èƒ½å¤Ÿä½œå‡ºå¯¹åº”çš„å“åº”ã€‚æˆ‘ä»¬å¯ä»¥æŠŠ <code>MacApple</code> å’Œ <code>MacIntel</code> å½’ä¸ºä¸€ä¸ª
<code>MacOs(String)</code>ï¼Œé‡Œé¢åŒ…å«äº†å½“å‰ CPU æ¶æ„ã€‚ç°åœ¨æ›´æ–° <code>native/src/api.rs</code>:</p>
<pre><code class="language-diff"> pub enum Platform {
     ..
-    MacIntel,
-    MacApple,
+    MacOs(String),
     ..
 }
</code></pre>
<p>æ¥ç€è¿è¡Œ <code>just</code>ï¼Œçœ‹çœ‹ç”Ÿæˆçš„ç»‘å®šä»£ç ä¼šå¦‚ä½•å˜åŒ–ã€‚</p>
<h2 id="troubleshooting-please-supply-one-or-more-pathtollvm"><a class="header" href="#troubleshooting-please-supply-one-or-more-pathtollvm">Troubleshooting: &quot;Please supply one or more path/to/llvm...&quot;</a></h2>
<p>å¯¹ LLVM å®‰è£…çš„æ£€æµ‹åœ¨ä¸åŒå¹³å°ä¸Šå¹¶ä¸å¯é ã€‚ç‰¹åˆ«æ˜¯å¯¹äº MacOS å’Œ x86-64 å’Œ arm64 çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½ å¯èƒ½éœ€è¦ä¿®æ”¹ <code>justfile</code>
ä»¥æ˜ç¡®æŒ‡å‘å®ƒçš„ä½ç½®ï¼š</p>
<pre><code>llvm_path := if os() == &quot;macos&quot; {
    &quot;--llvm-path /opt/homebrew/opt/llvm&quot;
} else {
    &quot;&quot;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä½¿ç”¨-build_runner"><a class="header" href="#ä½¿ç”¨-build_runner">ä½¿ç”¨ <code>build_runner</code></a></h1>
<p>æ£€æŸ¥ä¸€ä¸‹ä½ çš„ <code>lib/bridge_generated.dart</code>ï¼Œä½ ä¼šå‘ç° <code>Platform</code> çš„å®šä¹‰å˜ä¸ºäº†ï¼š</p>
<pre><code class="language-dart">@freezed
class Platform with _$Platform {
    const factory Platform.unknown() = Unknown;
    const factory Platform.android() = Android;
    const factory Platforn.ios() = Ios;
    const factory Platform.windows() = Windows;
    const factory Platform.unix() = Unix;
    const factory Platform.macOs(
        String field0,
    ) = MacOs;
    const factory Platform.wasm() = Wasm;
}
</code></pre>
<p>å®ƒä¸å†æ˜¯ä¸€ä¸ªæ™®é€šçš„æšä¸¾ï¼Œè€Œæ˜¯å¸¦ç€ä¸€ä¸ªå…·æœ‰å˜ä½“çš„æšä¸¾ç±»ï¼ç°åœ¨ä»£ç ä¸èƒ½é€šè¿‡ç¼–è¯‘ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜ç¼ºå°‘ <a href="https://pub.dev/packages/freezed"><code>freezed</code></a> åº“ã€‚<a href="https://pub.dev/packages/freezed"><code>freezed</code></a>
åº“ä¹Ÿæ˜¯ä¸€ä¸ªä»£ç ç”Ÿæˆåº“ï¼Œå’Œæˆ‘ä»¬ç›®å‰ä¸ºæ­¢é‡åˆ°çš„æœ‰äº›ç›¸ä¼¼ï¼Œä½†æ˜¯å®ƒç”Ÿæˆçš„æ›´å¤šæ˜¯ Dart ä»£ç ã€‚æ‰€æœ‰çš„è¿™äº›åº“éƒ½æ˜¯åœ¨è°ƒç”¨ <code>build_runner</code>
æ—¶è¿›è¡Œä»£ç ç”Ÿæˆçš„ï¼Œå³æ‰§è¡Œ <code>flutter pub run build_runner build</code> æ—¶ã€‚</p>
<p>ä¸ç®¡æ€ä¹ˆè¯´ï¼Œä¸ºäº†ä½¿è¿™æ®µä»£ç é€šè¿‡ç¼–è¯‘ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›ä¿®æ”¹ï¼š</p>
<ul>
<li>æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼Œæ·»åŠ æœ€æ–°çš„ <a href="https://pub.dev/packages/freezed"><code>freezed</code></a> ä¾èµ–ï¼š</li>
</ul>
<pre><code class="language-shell">flutter pub add -d build_runner
flutter pub add -d freezed
flutter pub add freezed_annotation
</code></pre>
<ul>
<li>æ›´æ–° <code>justfile</code> æ–‡ä»¶ï¼Œåœ¨ Rust ä»£ç ç”Ÿæˆåè¿è¡Œ <code>build_runner</code>:</li>
</ul>
<pre><code class="language-diff"> gen:
     ..
     # Uncomment this line to invoke build_runner as well
-    # flutter pub run build_runner build
+    flutter pub run build_runner build
</code></pre>
<p>ç°åœ¨è°ƒç”¨ <code>just</code> ä¼šåŒæ—¶ç”Ÿæˆ Rust ç»‘å®šå’Œ Dart ä»£ç ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ”¶å°¾"><a class="header" href="#æ”¶å°¾">æ”¶å°¾</a></h1>
<p>æœ‰äº†å¯¹ &quot;å¹³å°&quot; çš„æ–°å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥é‡å†™ä»¥å‰çš„ä»£ç å»ä½¿ç”¨å®ƒï¼ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå±•ç¤ºäº† freezed æšä¸¾çš„ä½¿ç”¨æŠ€å·§ã€‚</p>
<p>åœ¨ <code>lib/main.dart</code> é‡Œï¼š</p>
<pre><code class="language-diff">- final text = const {
-   Platform.Android: 'Android',
-   Platform.Ios: 'iOS',
-   Platform.MacApple: 'MacOS with Apple Silicon',
-   Platform.MacIntel: 'MacOS',
-   Platform.Windows: 'Windows',
-   Platform.Unix: 'Unix',
-   Platform.Wasm: 'the Web',
- }[platform] ??
- 'Unknown OS';
+ final text = platform.when(
+   android: () =&gt; 'Android',
+   ios: () =&gt; 'iOS',
+   macOs: (arch) =&gt; 'MacOS on $arch',
+   windows: () =&gt; 'Windows',
+   unix: () =&gt; 'Unix',
+   wasm: () =&gt; 'the Web',
+ );
</code></pre>
<p>åœ¨ <code>native/src/api.rs</code> é‡Œï¼š</p>
<pre><code class="language-diff">     } else if cfg!(target_os = &quot;ios&quot;) {
         Platform::Ios
     } else if cfg!(all(target_os = &quot;macos&quot;, target_arch = &quot;aarch64&quot;)) {
-        Platform::MacApple
+        Platform::MacOs(&quot;Apple Silicon&quot;.into())
     } else if cfg!(target_os = &quot;macos&quot;) {
-        Platform::MacIntel
+        Platform::MacOs(&quot;Intel&quot;.into())
     } else if cfg!(target_family = &quot;wasm&quot;) {
         Platform::Wasm
     } else if cfg!(unix) {
</code></pre>
<p>å½“ä½ è¿è¡Œ <code>flutter run</code> åï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°ï¼š <img src="template/macos_intel.png" alt="macos-intel" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é›†æˆåˆ°ç°æœ‰é¡¹ç›®"><a class="header" href="#é›†æˆåˆ°ç°æœ‰é¡¹ç›®">é›†æˆåˆ°ç°æœ‰é¡¹ç›®</a></h1>
<p>è¿™ä¸€éƒ¨åˆ†æ˜¯ä¸­çº§æ•™ç¨‹ï¼Œä»‹ç»äº†å¦‚ä½•å°† Rust ä¸ç°æœ‰çš„ Flutter é¡¹ç›®é›†æˆã€‚å¦‚æœæ‚¨æ˜¯ Rust åˆå­¦è€…ï¼Œæˆ–è€…åªæ˜¯åœ¨é…ç½®å¼€å‘ç¯å¢ƒï¼Œæˆ‘å»ºè®®ä½ å…ˆå»çœ‹
<a href="template/tour.html">the template tour</a> ç« èŠ‚ï¼Œå­¦ä¹  <code>flutter run</code> èƒŒåçš„éƒ¨åˆ†ã€‚</p>
<p>åœ¨è¿›å…¥æ•™ç¨‹ä¹‹å‰ï¼Œä¸ºäº†ä½¿é›†æˆæ›´ç®€å•ï¼Œè¯·æ›´æ–°ä½ çš„ Flutter SDKï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œä¹Ÿè¯·æ‚¨é‡æ–°æ„å»ºé¡¹ç›®ã€‚</p>
<p><strong>æ³¨æ„:</strong> è™½ç„¶è¿‡ç¨‹å¾ˆå¤æ‚ï¼Œä½†æ˜¯ç»å¤§å¤šæ•°åŸå› éƒ½ä¸æ˜¯æ¥æºäºè¯¥åº“æœ¬èº«ï¼Œä½¿ç”¨åŸå§‹çš„ Rust/Flutter FFI å’Œå®ƒä¸€æ ·å¤æ‚ã€‚æ¢å¥è¯è¯´ï¼ŒçœŸæ­£è€—æ—¶çš„æ˜¯æ­å»º
Dart / Flutter + Rust å·¥å…·é“¾ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åˆ›å»ºä¸€ä¸ªæ–°çš„-crate"><a class="header" href="#åˆ›å»ºä¸€ä¸ªæ–°çš„-crate">åˆ›å»ºä¸€ä¸ªæ–°çš„ crate</a></h1>
<p>é¦–å…ˆï¼Œä½ éœ€è¦åœ¨é¡¹ç›®æ–‡ä»¶å¤¹é‡Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Rust crateï¼Œè¿è¡Œ <code>cargo new --lib</code>ã€‚å»ºè®®å°† crate
çš„æ ¹ç›®å½•è®¾ä¸ºå’Œå…¶ä»–é¡¹ç›®åŒç­‰çº§åˆ«ï¼Œè¿™æ ·æœ‰åŠ©äºç®€åŒ–é…ç½®è¿‡ç¨‹ã€‚</p>
<pre><code>â”œâ”€â”€ android
â”œâ”€â”€ ios
â”œâ”€â”€ lib
â”œâ”€â”€ linux
â”œâ”€â”€ macos
â”œâ”€â”€ $crate
â”‚Â Â  â”œâ”€â”€ Cargo.toml
â”‚Â Â  â””â”€â”€ src
â”œâ”€â”€ test
â”œâ”€â”€ web
â””â”€â”€ windows
</code></pre>
<p>è¿™éƒ¨åˆ†ä¸­æˆ‘ä»¬ä¼šæŠŠä½ çš„ crate ç§°ä¸º <code>$crate</code>ã€‚é™¤éæœ‰å…¶ä»–è¯´æ˜ï¼Œcrate æ–‡ä»¶å¤¹å’Œ crate åç§°æ„ä¹‰ç›¸åŒã€‚</p>
<p>æ¥ç€ï¼Œåœ¨ä½ çš„ <code>Cargo.toml</code> åŠ ä¸Šè¿™ä¸¤è¡Œï¼š</p>
<pre><code class="language-diff">+[lib]
+crate-type = [&quot;staticlib&quot;, &quot;cdylib&quot;]
</code></pre>
<p>è¿™ä¸¤ä¸ªè¡Œé…ç½®ä¼šè®©ä½ çš„ crate åœ¨ MacOS å’Œ iOS ä¸Šæ„å»ºä¸ºä¸€ä¸ªé™æ€åº“ã€‚åœ¨å…¶ä»–å¹³å°ä¸Šåˆ™æ˜¯åŠ¨æ€åº“ã€‚æ ¹æ®ä½ çš„éœ€è¦è¿›è¡Œé…ç½®ã€‚å¦‚æœä½ 
éœ€è¦ç¼–å†™å•å…ƒæµ‹è¯•æˆ–åŸºå‡†æµ‹è¯•ï¼Œä¹Ÿå¯ä»¥æŠŠ <code>&quot;rlib&quot;</code> åŠ è¿›å»ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å®‰è£…ä¾èµ–"><a class="header" href="#å®‰è£…ä¾èµ–">å®‰è£…ä¾èµ–</a></h1>
<p>ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€äº›æ„å»ºæ—¶å’Œè¿è¡Œæ—¶ä¾èµ–ã€‚</p>
<h2 id="æ„å»ºä¾èµ–"><a class="header" href="#æ„å»ºä¾èµ–">æ„å»ºä¾èµ–</a></h2>
<p>è¿™äº›ä¾èµ–åªåœ¨ build æ—¶éœ€è¦ï¼š</p>
<ul>
<li><a href="https://lib.rs/crates/flutter_rust_bridge_codegen"><code>flutter_rust_bridge_codegen</code></a>,
ç”Ÿæˆ Rust-Dart èƒ¶æ°´ä»£ç çš„æ ¸å¿ƒ</li>
<li><a href="https://pub.dev/packages/ffigen"><code>ffigen</code></a>, ä» C å¤´æ–‡ä»¶ä¸­ç”Ÿæˆ Dart ä»£ç </li>
<li>å®‰è£… LLVM, è¯·çœ‹
<a href="https://pub.dev/packages/ffigen#installing-llvm">Installing LLVM</a>, <code>ffigen</code>
ä¼šä½¿ç”¨åˆ°</li>
<li>(å¯é€‰) <a href="https://lib.rs/crates/cargo-xcode"><code>cargo-xcode</code></a>,å¦‚æœä½ æƒ³ç”Ÿæˆä¸º IOS å’Œ MacOS çš„
Xcode é¡¹ç›®</li>
</ul>
<p>å®‰è£…è¿™äº›ä¾èµ–çš„ç®€å•æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>dart é¡¹ç›®</p>
<pre><code class="language-bash">cargo install flutter_rust_bridge_codegen
dart pub add --dev ffigen &amp;&amp; dart pub add ffi
# if building for iOS or MacOS
cargo install cargo-xcode
</code></pre>
</li>
<li>
<p>flutter é¡¹ç›®</p>
<pre><code class="language-bash">cargo install flutter_rust_bridge_codegen
flutter pub add --dev ffigen &amp;&amp; flutter pub add ffi
# if building for iOS or MacOS
cargo install cargo-xcode
</code></pre>
</li>
</ul>
<p>å¦å¤–ï¼Œè¿™äº›ä¾èµ–ä¹Ÿå¯èƒ½å·²ç»æä¾›äº†é¢„æ„å»ºçš„äºŒè¿›åˆ¶ç‰ˆæœ¬ã€‚è¯·è‡ªè¡Œåˆ°åŒ…ç®¡ç†å™¨ä¸­æŸ¥æ‰¾ã€‚</p>
<h2 id="dart-ä¾èµ–"><a class="header" href="#dart-ä¾èµ–">Dart ä¾èµ–</a></h2>
<p>åœ¨ Dart è¿™é‡Œï¼Œ<code>flutter_rust_bridge</code> æ˜¯ <code>flutter_rust_bridge_codegen</code> å¿…éœ€çš„è¿è¡Œæ—¶ç»„ä»¶ã€‚å¦‚æœä½ æ‰“ç®—åœ¨
Dart ä¸­ä½¿ç”¨ Rust çš„ enum structï¼Œä½ éœ€è¦è¿™äº›ä¾èµ–ï¼š</p>
<ul>
<li><code>build_runner</code> (dev)</li>
<li><code>freezed</code> (dev)</li>
<li><code>freezed_annotation</code></li>
</ul>
<p>å®ƒä»¬çš„æ˜¯ä½¿ç”¨æ–¹æ³•åœ¨ <a href="integrate/../generate/build_runner.html">Using <code>build_runner</code></a>ã€‚</p>
<pre><code class="language-bash">flutter pub add flutter_rust_bridge
# if using Dart codegen
flutter pub add -d build_runner
flutter pub add -d freezed
flutter pub add freezed_annotation
</code></pre>
<h2 id="rust-ä¾èµ–"><a class="header" href="#rust-ä¾èµ–">Rust ä¾èµ–</a></h2>
<p>å’Œ Dart ç±»ä¼¼ï¼ŒRust éœ€è¦ <code>flutter_rust_bridge</code> æœ€ä¸ºè¿è¡Œæ—¶ä¾èµ–ã€‚</p>
<p>åœ¨ <code>Cargo.toml</code> é‡Œæ·»åŠ ï¼š</p>
<pre><code class="language-diff">+[dependencies]
+flutter_rust_bridge = &quot;1&quot;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é›†æˆåˆ°å®‰å“"><a class="header" href="#é›†æˆåˆ°å®‰å“">é›†æˆåˆ°å®‰å“</a></h1>
<p>è®¾ç½®è¿‡ç¨‹ä¸ <a href="integrate/../template/setup_android.html">Android setup</a> ç›¸åŒã€‚
æ‰€ä»¥è¯·ç»§ç»­æŒ‰ç…§é‚£é‡Œçš„æ­¥éª¤è¿›è¡Œã€‚å½“ä½ å®Œæˆåï¼Œæˆ‘ä»¬å°†ç»§ç»­ä¿®æ”¹ç°æœ‰çš„å·¥å…·é“¾ä»¥é€‚åº” Rustã€‚</p>
<p>è®¾ç½® Cargo ä¸ Gradle ä¸€èµ·è¿è¡Œçš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œæœ¬æŒ‡å—å°†ä»‹ç»ä¸¤ç§ä¸»è¦æ–¹å¼ï¼šä»»åŠ¡é’©å­ï¼ˆhooking onto tasksï¼‰ï¼Œä»¥åŠä¸ CMake é›†æˆã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hooking-onto-tasks"><a class="header" href="#hooking-onto-tasks">Hooking onto tasks</a></h1>
<p>è¿™éƒ¨åˆ†ä¸æ¨¡æ¿çš„ä½¿ç”¨æ–¹æ³•ç›¸åŒï¼Œä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„æ–¹æ³•ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… <code>cargo-ndk</code>ï¼Œè¯·ç»§ç»­å®‰è£…ã€‚</p>
<pre><code>cargo install cargo-ndk
</code></pre>
<p>æ¥ç€ï¼Œåœ¨ <code>android/app/build.gradle</code> çš„æœ€åæ·»åŠ ä¸‹é¢å‡ è¡Œï¼š</p>
<pre><code class="language-gradle">[
    new Tuple2('Debug', ''),
    new Tuple2('Profile', '--release'),
    new Tuple2('Release', '--release')
].each {
    def taskPostfix = it.first
    def profileMode = it.second
    tasks.whenTaskAdded { task -&gt;
        if (task.name == &quot;javaPreCompile$taskPostfix&quot;) {
            task.dependsOn &quot;cargoBuild$taskPostfix&quot;
        }
    }
    tasks.register(&quot;cargoBuild$taskPostfix&quot;, Exec) {
        // Until https://github.com/bbqsrc/cargo-ndk/pull/13 is merged,
        // this workaround is necessary.

        def ndk_command = &quot;&quot;&quot;cargo ndk \
            -t armeabi-v7a -t arm64-v8a -t x86_64 -t x86 \
            -o ../android/app/src/main/jniLibs build $profileMode&quot;&quot;&quot;

        workingDir &quot;../../$crate&quot;
        environment &quot;ANDROID_NDK_HOME&quot;, &quot;$ANDROID_NDK&quot;
        if (org.gradle.nativeplatform.platform.internal.DefaultNativePlatform.currentOperatingSystem.isWindows()) {
            commandLine 'cmd', '/C', ndk_command
        } else {
            commandLine 'sh', '-c', ndk_command
        }
    }
}
</code></pre>
<p>æ³¨æ„ ANDROID_NDK å˜é‡ï¼Œè¿™æ˜¯ä¸€ä¸ª Gradle å±æ€§ï¼Œå®ƒæŒ‡å‘ä½ å®‰è£…çš„ Android NDK ç›®å½•ã€‚ä½ å¯ä»¥ç¡¬ç¼–ç è¿™ä¸ªå€¼ï¼Œä½†æœ€å¯é çš„æ–¹æ³•æ˜¯å†™å…¥åˆ°
<code>~/.gradle/gradle.properties</code>ï¼š</p>
<pre><code>ANDROID_NDK=(path to NDK)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cmake-å’Œ-gradle"><a class="header" href="#cmake-å’Œ-gradle">CMake å’Œ Gradle</a></h1>
<p>å¦‚æœä½ ä¹‹å‰çœ‹è¿‡ <em>windows</em> æˆ– <em>linux</em> æ–‡ä»¶å¤¹ï¼Œä½ ä¼šçœ‹åˆ° ä¸€ä¸ªåä¸º <em>CMakeLists.txt</em> çš„æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯ CMake
å·¥å…·é“¾çš„å®šä¹‰æ–‡ä»¶ï¼ŒFlutter ä½¿ç”¨å®ƒæ¥æ„å»º Windows å’Œ Linux åº”ç”¨ç¨‹åºã€‚ä½ ä¹Ÿå¯ä»¥åœ¨ Gradle ä¸Šä½¿ç”¨
è¿™ä¸ªç­–ç•¥ï¼Œä½†è¿™ç§è®¾ç½®è¶…å‡ºäº†æœ¬æŒ‡å—çš„èŒƒå›´ï¼Œæ˜¯ç•™ç»™é«˜çº§äººå‘˜çš„ã€‚</p>
<p>è¯·å‚è€ƒå®˜æ–¹ Android æ–‡æ¡£ä¸­çš„
<a href="https://developer.android.com/studio/projects/add-native-code">Add C and C++ code to your project</a>ï¼Œå›´ç»•
C è¯­è¨€çš„ç‰¹å®šéƒ¨åˆ†è¿›è¡Œä¿®æ”¹ï¼Œå¹¶ä½¿ç”¨ <a href="https://github.com/corrosion-rs/corrosion"><code>Corrosion</code></a>
è¿™æ ·çš„å·¥å…·æ¥é›†æˆåˆ° Cargoã€‚è¿™ç§è®¾ç½®çš„å¥½å¤„æ˜¯ï¼Œä½ å¯ä»¥é‡å¤ä½¿ç”¨ C è¯­è¨€å·¥å…·ï¼Œå¹¶ä¸”å—ç›Šäºå„ç§ç°æœ‰æˆç†ŸæŠ€æœ¯ï¼Œå¦‚æ„å»ºç¼“å­˜ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä¸-iosmacos-é›†æˆ"><a class="header" href="#ä¸-iosmacos-é›†æˆ">ä¸ iOS/MacOS é›†æˆ</a></h1>
<p><em>Credit to
<a href="https://github.com/brotskydotcom/rust-on-ios">brotskydotcom/rust-on-ios</a> for
the inspiration of this method.</em></p>
<p>ä¸º iOS å’Œ MacOS è®¾ç½® <code>flutter run</code> æ¯”å…¶ä»–å¹³å°ç¨å¾®å¤æ‚ä¸€äº›ã€‚ç”±äºå…¶å¯¹ Xcode ç”¨æˆ·ç•Œé¢çš„ä¾èµ–ã€‚æœ¬æŒ‡å—å‡è®¾æ‚¨æ­£åœ¨è¿è¡Œ
ä¸€ä¸ªç›¸å¯¹è¾ƒæ–°çš„ Xcode ç‰ˆæœ¬ï¼Œåœ¨å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™æ˜¯ Xcode 13ã€‚å…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰ä¸€äº›å°çš„å·®å¼‚ï¼Œä½†æ•´ä½“è¿‡ç¨‹åº”è¯¥æ˜¯ç›¸åŒçš„ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åˆ›å»º-rust-é¡¹ç›®"><a class="header" href="#åˆ›å»º-rust-é¡¹ç›®">åˆ›å»º Rust é¡¹ç›®</a></h1>
<p>é¦–å…ˆï¼Œè¯·æŒ‰ç…§ <a href="https://gitlab.com/kornelski/cargo-xcode#usage">Usage</a> ä¸­ <code>cargo-xcode</code>
éƒ¨åˆ†çš„è¯´æ˜è¿›è¡Œæ“ä½œã€‚ä¸‹é¢çš„å†…å®¹å°±æ˜¯ä»é‚£é‡Œå¼•ç”¨çš„ï¼Œä½†è¯·æ³¨æ„ï¼Œå®ƒå¯èƒ½å·²ç»è¿‡æ—¶äº†ã€‚</p>
<hr />
<p>ç¡®ä¿ä½ çš„ <code>$crate/Cargo.toml</code> é‡Œæœ‰ä¸‹é¢å‡ è¡Œä»£ç ï¼š</p>
<pre><code class="language-toml">[lib]
crate-type = [&quot;lib&quot;, &quot;staticlib&quot;, &quot;cdylib&quot;]
</code></pre>
<p>ä¸€äº›è¯´æ˜</p>
<ul>
<li><code>lib</code> å¯¹äºéåº“é¡¹ç›®æ—¶å¿…é¡»çš„ï¼Œä¾‹å¦‚ tests å’Œ benchmarks</li>
<li><code>staticlib</code> å¯¹ iOS æ˜¯å¿…é¡»çš„</li>
<li><code>cdylib</code> æ˜¯ç”¨äºå…¶ä»–å¹³å°</li>
</ul>
<p>è¯·æŒ‰ç…§æ‚¨çš„éœ€æ±‚è¿›è¡Œé…ç½®ã€‚æ¥ç€åœ¨ <code>$crate</code> ä¸‹è¿è¡Œï¼š</p>
<pre><code class="language-bash">cargo xcode
</code></pre>
<p>è¿™è¡Œå‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ª <code>$crate/$crate.xcodeproj</code>ï¼Œå¯ä»¥å¯¼å…¥åˆ°å…¶ä»– Xcode é¡¹ç›®ã€‚ä½ åªéœ€è¦ä¸ºæ¯ä¸ª crate
åšä¸€æ¬¡è¿™æ ·çš„å·¥ä½œã€‚å…ˆä¸è¦æ‰“å¼€è¿™ä¸ªé¡¹ç›® æˆ‘ä»¬éœ€è¦å…ˆé€šè¿‡çˆ¶é¡¹ç›®å¯¹å…¶è¿›è¡Œé…ç½®ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é“¾æ¥è¯¥é¡¹ç›®"><a class="header" href="#é“¾æ¥è¯¥é¡¹ç›®">é“¾æ¥è¯¥é¡¹ç›®</a></h1>
<p>åœ¨ Xcode ä¸­æ‰“å¼€ <code>ios/Runner.xcodeproj</code>, æ¥ç€æŠŠ <code>$crate/$crate.xcodeproj</code>
æ·»åŠ ä¸ºå­é¡¹ç›®ã€‚ç»“æœå¤§è‡´æ˜¯è¿™æ ·ï¼š</p>
<p><img src="integrate/ios_proj_tree.png" alt="proj-tree" /></p>
<p>ç‚¹å‡» <code>Runner</code> æ ¹é¡¹ç›®ï¼Œæ¥ç€æ‰¾åˆ° <strong>Build Phases</strong>. é¦–å…ˆï¼Œå±•å¼€ <strong>Dependencies</strong> , æ¥ç€å¯¹äº IOS è¯·æ·»åŠ 
<strong>$crate-staticlib</strong> ï¼Œå¯¹äº MacOS è¯·æ·»åŠ  <strong>$crate-cdylib</strong> ã€‚</p>
<p><img src="integrate/ios_dep_phase.png" alt="dep-phase" /></p>
<p>æ¥ç€ï¼Œå±•å¼€ <strong>Link Binary With Libraries</strong>, ä¸º IOS æ·»åŠ  <strong>lib$crate_static.a</strong>ï¼Œæˆ–è€…å¯¹äº MacOS
æ·»åŠ  <strong>$crate.dylib</strong>.</p>
<p><img src="integrate/ios_link_phase.png" alt="link-phase" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç”Ÿæˆç»‘å®š"><a class="header" href="#ç”Ÿæˆç»‘å®š">ç”Ÿæˆç»‘å®š</a></h1>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº†å¤§éƒ¨åˆ†çš„å·¥ä½œï¼Œè®©æˆ‘ä»¬æ¥ç¼–è¯‘æˆ‘ä»¬çš„ Rust ç¨‹åºã€‚å¦‚æœä½ åˆšæ‰åˆ›å»ºäº†ä½ çš„ crateï¼Œè¯·ç»§ç»­ åœ¨ <em>$crate/src/api.rs</em>
å¤„æ·»åŠ ä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå¹¶å°†å…¶å†…å®¹æ›¿æ¢ä¸ºä¸‹é¢çš„ä»£ç ç‰‡æ®µæˆ–å…¶ä»–å†…å®¹ã€‚</p>
<pre><code class="language-rust ignore">pub fn greet() -&gt; String {
    &quot;Hello from Rust! ğŸ¦€&quot;.into()
}
</code></pre>
<p>æ¥ç€åœ¨ <code>$crate/src/lib.rs</code> æ·»åŠ ï¼š</p>
<pre><code class="language-diff">+mod api;
</code></pre>
<h2 id="è¿è¡Œä»£ç ç”Ÿæˆ"><a class="header" href="#è¿è¡Œä»£ç ç”Ÿæˆ">è¿è¡Œä»£ç ç”Ÿæˆ</a></h2>
<p>åœ¨æˆ‘ä»¬ç¼–è¯‘ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç”Ÿæˆç»‘å®šã€‚ä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œè¿™äº›å‘½ä»¤ï¼š</p>
<pre><code class="language-bash">flutter_rust_bridge_codegen \
    -r $crate/src/api.rs \
    -d lib/bridge_generated.dart \
    -c ios/Runner/bridge_generated.h \
    -c macos/Runner/bridge_generated.h   # if building for MacOS
</code></pre>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong> æ¯æ¬¡ä¿®æ”¹ Rust ä»£ç åéƒ½ä¼šä½¿ç”¨åˆ°è¿™äº›å‘½ä»¤ã€‚</p>
</blockquote>
<p>è¿è¡Œè¿™ä¸ªå‘½ä»¤å¯ä»¥å¾—åˆ°ç”± Rust åº“å¯¼å‡ºçš„å‡½æ•°å’Œç±»å‹çš„ C å¤´æ–‡ä»¶ã€‚æˆ‘ä»¬éœ€è¦ç¡®ä¿å®ƒæ¥ä¿æŒç¬¦å·ä¸è¢«å‰¥ç¦»ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-dummy-headers"><a class="header" href="#using-dummy-headers">Using dummy headers</a></h1>
<p><code>flutter_rust_bridge_codegen</code> ä¼šåˆ›å»ºä¸€ä¸ª C å¤´æ–‡ä»¶ï¼Œé‡Œé¢åˆ—å‡ºäº† Rust åº“å¯¼å‡ºçš„æ‰€æœ‰ç¬¦å·ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å®ƒç¡®ä¿ Xcode
ä¸ä¼šå°†ç¬¦å·å»é™¤ã€‚</p>
<p>åœ¨é¡¹ç›®ä¸­æ·»åŠ  <code>ios/Runner/bridge_generated.h</code> (æˆ–è€…
<code>macos/Runner/bridge_generated.h</code>)ï¼Œä½ å¯ä»¥æŠŠæ–‡ä»¶ç›´æ¥æ‹–åˆ°é¡¹ç›®æ–‡ä»¶å¤¹ä¸­æˆ–è€…ç‚¹å‡»èœå•ä¸Šçš„ <strong>Add Files to
&quot;Runner&quot;...</strong> .</p>
<p>å¦‚æœå®ƒè¿˜æ²¡æœ‰å‡ºç°ï¼Œè¯·åˆ‡æ¢åˆ° <strong>Build Phases</strong> æ ‡ç­¾é¡µï¼ŒæŠŠ <strong>bridge_generated.h</strong> æ–‡ä»¶æ‹–åˆ° <strong>Copy Bundle
Resources</strong>ã€‚</p>
<h2 id="ios"><a class="header" href="#ios">iOS</a></h2>
<p>æ¥ä¸‹æ¥ï¼Œåœ¨ <code>ios/Runner/Runner-Bridging-Header.h</code> ä¸­æ·»åŠ ï¼š</p>
<pre><code class="language-diff">+#import &quot;bridge_generated.h&quot;
</code></pre>
<p>åœ¨ <code>ios/Runner/AppDelegate.swift</code> ä¸­æ·»åŠ ï¼š</p>
<pre><code class="language-diff"> override func application(
     _ application: UIApplication,
     didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
 ) -&gt; Bool {
+    let dummy = dummy_method_to_enforce_bundling()
+    print(dummy)
     ..
 }
</code></pre>
<p>è¿™é‡Œè°ƒç”¨ <code>dummy_method_to_enforce_bundling()</code>
å¹¶æ‰“å°è¿”å›å€¼çš„æ­¥éª¤éå¸¸é‡è¦ï¼ˆç±»ä¼¼äºä¸Šé¢çš„ä¾‹å­ï¼‰ï¼Œå¦åˆ™æœ€ç»ˆçš„ç¬¦å·è¿˜æ˜¯å¯èƒ½è¢«å»é™¤ã€‚</p>
<h2 id="macos"><a class="header" href="#macos">MacOS</a></h2>
<p>Flutter åœ¨ MacOS ä¸Šé»˜è®¤ä¸ä½¿ç”¨ç¬¦å·ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ æˆ‘ä»¬è‡ªå·±çš„ã€‚åœ¨ <strong>Build Settings</strong> æ ‡ç­¾é¡µä¸­ï¼ŒæŠŠ <strong>Objective-C
Bridging Header</strong> è®¾ç½®ä¸º <strong>Runner/bridge_generated.h</strong></p>
<p>æœ€åï¼Œåœ¨ <code>macos/Runner/AppDelegate.swift</code> æ–‡ä»¶çš„æŸä¸ªåœ°æ–¹ä½¿ç”¨ä¸€ä¸‹
<code>dummy_method_to_enforce_bundling</code> , åªè¦ Xcode ä¸æŠŠå®ƒå½“ä½œ dead code å°±è¡Œã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä¸-windows-å’Œ-linux-é›†æˆ"><a class="header" href="#ä¸-windows-å’Œ-linux-é›†æˆ">ä¸ Windows å’Œ Linux é›†æˆ</a></h1>
<p>æœ¬æŒ‡å—å°† Windows å’Œ Linux æ¡Œé¢åº”ç”¨ç¨‹åºçš„è¯´æ˜æ”¾åœ¨ä¸€èµ·ï¼Œå› ä¸ºå®ƒä»¬ä½¿ç”¨ç›¸åŒçš„æ„å»ºç³»ç»Ÿã€‚</p>
<p>å’Œå…¶ä»–å¹³å°ä¸€æ ·ï¼šæˆ‘ä»¬å°†ä½¿ç”¨è„šæœ¬æ•´åˆåˆ°ç°æœ‰çš„é¡¹ç›®ã€‚ç°åœ¨æˆ‘ä»¬å°†å€Ÿç”¨ä¸‹æ¨¡æ¿ï¼ŒæŠŠ
<a href="https://raw.githubusercontent.com/Desdaemon/flutter_rust_bridge_template/main/windows/rust.cmake">rust.cmake</a>
ä¸‹è½½åˆ°ä½ çš„ &quot;windows&quot; å’Œ &quot;linux&quot; æ–‡ä»¶å¤¹é‡Œã€‚è¯·æ³¨æ„ï¼ŒCMake
ä¼šæ‹’ç»ä½¿ç”¨ä½äºå…¶å·¥ä½œç›®å½•ä¹‹å¤–çš„æ–‡ä»¶ï¼Œæ‰€ä»¥åœ¨è¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹ä¹‹é—´ä¼šæœ‰ä¸€äº›é‡å¤çš„æ–‡ä»¶ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œåœ¨ä½ çš„<code>CMakeLists.txt</code>æ–‡ä»¶ä¸­æ·»åŠ è¿™ä¸€è¡Œï¼š</p>
<pre><code class="language-diff"> # Generated plugin build rules, which manage building the plugins and adding
 # them to the application.
 include(flutter/generated_plugins.cmake)

+include(./rust.cmake)

 # === Installation ===
 # Support files are copied into place next to the executable, so that it can
</code></pre>
<h2 id="linux"><a class="header" href="#linux">Linux</a></h2>
<p>åœ¨ Linux ä¸Šï¼Œä½ éœ€è¦å°† CMake çš„æœ€ä½ç‰ˆæœ¬å‡åˆ° 3.12ï¼Œè¿™æ˜¯
<a href="https://github.com/corrosion-rs/corrosion">Corrosion</a> çš„è¦æ±‚ï¼Œ<code>rust.cmake</code> ä¾èµ–
Corrosionã€‚è¯·ä¿®æ”¹ <code>linux/CMakeLists.txt</code> çš„è¿™ä¸€è¡Œï¼š</p>
<pre><code class="language-diff">-cmake_minimum_required(VERSION 3.10)
+cmake_minimum_required(VERSION 3.12)
</code></pre>
<p>å¯é€‰ï¼šä½ å¯ä»¥å°† Corrosion å®‰è£…åˆ°ç³»ç»Ÿä¸Šã€‚è¯·æŸ¥çœ‹
<a href="integrate/../template/setup_desktop.html">Linux troubleshooting notes</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä¸-web-é›†æˆ"><a class="header" href="#ä¸-web-é›†æˆ">ä¸ Web é›†æˆ</a></h1>
<p>æˆªè‡³å‘ç¨¿æ—¶ï¼ŒWeb
æ”¯æŒæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¹¶åœ¨<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/315">fzyzcjy/flutter_rust_bridge#315</a>æŒç»­è·Ÿè¸ªã€‚
è¯·ç•™ä¸‹è¯„è®ºå’Œå»ºè®®ï¼Œè®©æˆ‘ä»¬äº†è§£æ‚¨å¯¹è¿™ä¸€åŠŸèƒ½çš„éœ€æ±‚ï¼</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä½¿ç”¨åŠ¨æ€è¿æ¥åº“"><a class="header" href="#ä½¿ç”¨åŠ¨æ€è¿æ¥åº“">ä½¿ç”¨åŠ¨æ€è¿æ¥åº“</a></h1>
<p>å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œè¿è¡Œ <code>flutter run</code> å°±ä¼šè‡ªåŠ¨æ„å»ºä½ çš„ Rust åº“ï¼ŒFlutter äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å°†äºŒè€…è¿æ¥èµ·æ¥ã€‚ç°åœ¨å”¯ä¸€è¦åšçš„äº‹æƒ…å°±æ˜¯ä½¿ç”¨å®ƒï¼</p>
<p>æŠŠ
<a href="https://raw.githubusercontent.com/Desdaemon/flutter_rust_bridge_template/main/lib/ffi.dart">è¿™ä¸ªæ–‡ä»¶</a>
ä¸‹è½½åˆ° <code>lib/ffi.dart</code>,æ¥ç€ä¿®æ”¹ä¸‹é¢å‡ è¡Œï¼š</p>
<pre><code class="language-diff"> // Re-export the bridge so it is only necessary to import this file.
 export 'bridge_generated.dart';
 import 'dart:io' as io;

-const _base = 'native';
+const _base = '$crate';

 // On MacOS, the dynamic library is not bundled with the binary,
 // but rather directly **linked** against the binary.
 final _dylib = io.Platform.isWindows ? '$_base.dll' : 'lib$_base.so';
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ”¶å°¾å·¥ä½œ"><a class="header" href="#æ”¶å°¾å·¥ä½œ">æ”¶å°¾å·¥ä½œ</a></h1>
<p>æ­å–œï¼æ‚¨å·²ç»æˆåŠŸåœ°å°† Rust ç»„ä»¶é€šè¿‡ <code>flutter_rust_bridge</code> æ·»åŠ åˆ°æ‚¨çš„ Flutter ç¨‹åºä¸­ï¼Œå¹¶é…ç½®äº†
<code>flutter run</code> æ¥æ„å»ºæ‚¨çš„ Rust åº“å¹¶å°†å…¶é“¾æ¥åˆ°ç¨‹åºä¸­ã€‚</p>
<p>ä½œä¸ºæé†’ï¼Œæ¯æ¬¡ Rust ä»£ç æ”¹å˜æ—¶ï¼Œä»¥åŠåœ¨ä½ è¿è¡Œ<code>flutter run</code>ä¹‹å‰ï¼Œä½ éƒ½éœ€è¦è¿è¡Œè¿™äº›å‘½ä»¤ã€‚</p>
<pre><code class="language-bash">flutter_rust_bridge_codegen \
    -r $crate/src/api.rs \
    -d lib/bridge_generated.dart \
    -c ios/Runner/bridge_generated.h \
    -c macos/Runner/bridge_generated.h   # if building for MacOS
# if using Dart codegen
flutter pub run build_runner build
</code></pre>
<h2 id="é‡å‘½å-rust-bridge-æ¨¡å—"><a class="header" href="#é‡å‘½å-rust-bridge-æ¨¡å—">é‡å‘½å Rust bridge æ¨¡å—</a></h2>
<p>å¦‚æœä½ æƒ³ç”¨ <code>flutter_rust_bridge_codegen</code> çš„ <code>--rust-output</code> å‚æ•°ï¼Œä¸è¦å¿˜è®°æ›´æ–°
<code>$crate/src/lib.rs</code> é‡Œå¼•ç”¨çš„æ¨¡å—å</p>
<pre><code class="language-bash">flutter_rust_bridge_codegen \
    ..
    --rust-output $crate/src/my_bridge.rs
</code></pre>
<p>then you need to modify this in <code>lib.rs</code>:</p>
<pre><code class="language-diff">-mod bridge_generated;
+mod my_bridge;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ€»è§ˆ"><a class="header" href="#æ€»è§ˆ">æ€»è§ˆ</a></h1>
<h2 id="prelude"><a class="header" href="#prelude">Prelude</a></h2>
<p>é¦–å…ˆï¼Œæ¬¢è¿å¹¶æ„Ÿè°¢æ‚¨åšå‡ºçš„è´¡çŒ®ï¼</p>
<p>å¦‚æœä½ æƒ³æˆä¸ºä¸€ä¸ªè´¡çŒ®è€…ï¼Œè¯·æäº¤ä¸€ä¸ª
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/pulls">Pull Request</a>ã€‚å¦‚æœä½ éœ€è¦ä¸€äº›æ”¹è¿›çš„ç‚¹å­ï¼Œå»çœ‹ä¸€ä¸‹ä»“åº“çš„
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues">Issues section</a></p>
<p>éœ€è¦ä¸€ä¸ª PR æ¨¡æ¿ï¼Ÿè¯·çœ‹ä¸€ä¸‹
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/.github/PULL_REQUEST_TEMPLATE.md">PR template</a>.</p>
<h2 id="æ€»ä½“è®¾è®¡"><a class="header" href="#æ€»ä½“è®¾è®¡">æ€»ä½“è®¾è®¡</a></h2>
<p>å¦‚æœä½ æƒ³ä»é«˜å±‚äº†è§£è¿™ä¸ªåº“çš„å®ç°åŸç†ï¼Œè¿™é‡Œæ˜¯æ•´ä½“è®¾è®¡ï¼š<a href="contributing/design.html">link</a>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è®¾è®¡æ€»è§ˆ"><a class="header" href="#è®¾è®¡æ€»è§ˆ">è®¾è®¡æ€»è§ˆ</a></h1>
<blockquote>
<p>è¿™ç¯‡æ–‡æ¡£æ­£åœ¨ç¼–å†™ä¸­ã€‚Tracking issue:
https://github.com/fzyzcjy/flutter_rust_bridge/issues/593</p>
</blockquote>
<h2 id="æ–‡ä»¶ç»“æ„"><a class="header" href="#æ–‡ä»¶ç»“æ„">æ–‡ä»¶ç»“æ„</a></h2>
<ul>
<li><code>frb_codegen</code>: ä»£ç ç”Ÿæˆå™¨ã€‚å®ƒæ¥æ”¶ <code>api.rs</code> ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¾“å‡º Rust and Dart ä»£ç æ–‡ä»¶ã€‚</li>
<li><code>frb_example</code>: ä¾‹å­ã€‚
<ul>
<li><code>pure_dart</code>: ä¸åªæ˜¯ä¸€ä¸ªä¾‹å­ï¼Œæ›´é‡è¦çš„æ˜¯ä½œä¸ºç«¯åˆ°ç«¯çš„æµ‹è¯•ã€‚</li>
<li><code>with_flutter</code>: é›†æˆåˆ° Flutter çš„ä¾‹å­ã€‚</li>
<li><code>pure_dart_multi</code>: å±•ç¤ºå¤šæ–‡ä»¶çš„ä½¿ç”¨ã€‚</li>
</ul>
</li>
<li><code>frb_dart</code>: å¯¹ Dart åº“çš„æ”¯æŒ - éœ€è¦ç”±ç”¨æˆ·å¼•å…¥ã€‚</li>
<li><code>frb_rust</code>: å¯¹ Rust åº“çš„æ”¯æŒ - éœ€è¦ç”±ç”¨æˆ·å¼•å…¥ã€‚</li>
<li><code>frb_macros</code>: <code>frb_rust</code> ç‹¬ç«‹çš„ä¸€éƒ¨åˆ†ã€‚<small> ç”±äº proc macro çš„é™åˆ¶ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„
crateã€‚</small></li>
<li><code>book</code>: æ–‡æ¡£ã€‚</li>
<li><code>.github</code>: GitHub ç›¸å…³ã€‚
<ul>
<li><code>workflows/ci.yaml</code>: CI å·¥ä½œæµçš„å®šä¹‰ã€‚</li>
</ul>
</li>
</ul>
<h2 id="ä»£ç ç”Ÿæˆç»“æ„"><a class="header" href="#ä»£ç ç”Ÿæˆç»“æ„">ä»£ç ç”Ÿæˆç»“æ„</a></h2>
<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<pre><code>----------    src/parser    ----------    src/generator     ---------------
| api.rs | ---------------&gt; | src/ir | -------------------&gt; | Rust &amp; Dart |
----------                  ----------                      ---------------
</code></pre>
<ul>
<li>è¾“å…¥ (å³å›¾ä¸­çš„ <code>api.rs</code>), æ˜¯ç”±ç”¨æˆ·æä¾›çš„æ‰‹å·¥ç¼–å†™çš„ Rust ä»£ç ã€‚</li>
<li>è§£æå™¨ (<code>src/parser</code>) å°†è¾“å…¥çš„ä»£ç  (å…¶å®æ˜¯ <a href="https://crates.io/crates/syn">syn</a> æ ‘) è½¬æ¢ä¸º IR.</li>
<li>IR (<code>src/ir</code>), æˆ–è€…è¯´ internal representation, æ˜¯ä¸€ç§ç»“æ„ï¼Œç”¨æ¥è¡¨ç¤ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„ä»£ç çš„ä¿¡æ¯ã€‚</li>
<li>ç”Ÿæˆå™¨ (<code>src/generator</code>) å°† IR è½¬æ¢ä¸ºæœ€ç»ˆçš„è¾“å‡ºã€‚æ›´å…·ä½“ä¸€ç‚¹å°±æ˜¯ <code>src/generator/dart</code> ç”Ÿæˆ Dart ä»£ç ï¼Œ
<code>src/generator/rust</code> ç”Ÿæˆ Rust ä»£ç ï¼Œ<code>src/generator/c</code> ç”Ÿæˆ (éƒ¨åˆ†) C ä»£ç ã€‚</li>
<li>æœ€ç»ˆçš„è¾“å‡º (å›¾ä¸­çš„ <code>Rust &amp; Dart</code>) è¢«å†™å…¥åˆ°å¯¹åº”çš„æ–‡ä»¶ã€‚</li>
</ul>
<h2 id="æ•°æ®æµ"><a class="header" href="#æ•°æ®æµ">æ•°æ®æµ</a></h2>
<blockquote>
<p>å»ºè®®è¯»è€…é…åˆç€ IDE çš„ä»£ç è·³è½¬åŠŸèƒ½ä¸€åŒæŸ¥çœ‹</p>
</blockquote>
<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å½“è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ—¶å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>
<p>å‡è®¾ç”¨æˆ·è°ƒç”¨äº†ä¸€ä¸ªï¼ˆç”Ÿæˆçš„ï¼‰åä¸º <code>func</code> çš„ Dart å‡½æ•° <code>func({required String str})</code>ã€‚ä¸‹é¢æ˜¯è¯¦ç»†çš„è°ƒç”¨è¿‡ç¨‹ï¼š</p>
<ol>
<li>ç”Ÿæˆçš„ Dart å‡½æ•°ï¼Œ<code>func({required String str})</code>, é¦–å…ˆä¼šå°†å‚æ•°ç±»å‹è¿›è¡Œè½¬æ¢ï¼Œå°† &quot;<em>Dart api data</em>&quot;
(å³ç”¨æˆ·æä¾›çš„æ•°æ®) è½¬æ¢ä¸º &quot;<em>Dart wire data</em>&quot; (å³çœŸæ­£åœ¨ Dart å’Œ Rust é—´ä¼ é€’çš„æ•°æ®)ã€‚å†å…·ä½“ä¸€ç‚¹ï¼Œå®ƒä¼šè°ƒç”¨
<code>_api2wire_String(str)</code> å¹¶å¾—åˆ°ä¸€ä¸ªæŒ‡é’ˆ <code>ffi.Pointer&lt;wire_uint_8_list&gt;</code> (å› ä¸º <code>String</code>
ç±»å‹åœ¨åº•å±‚ä½¿ç”¨ <code>pub struct wire_uint_8_list { ptr: *mut u8, len: i32 }</code>) è¡¨ç¤ºã€‚</li>
<li>æ¥ç€å¯ä»¥ç”¨æ‹¿åˆ°çš„åº•å±‚æ•°æ®ç»“æ„ <code>wire_uint_8_list</code> è°ƒç”¨ Dart ç‰ˆæœ¬çš„ <code>wire_func</code>ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨ä»£ç ç”Ÿæˆå™¨ç”Ÿæˆäº†
Rust çš„ <code>wire_func</code> å‡½æ•°ï¼Œå¹¶ä½¿ç”¨ <code>cbindgen</code> ç”Ÿæˆå¯¹åº”çš„ C å‡½æ•°ï¼Œä½¿ç”¨ <code>ffigen</code> å¾—åˆ°å¯¹åº”çš„ Dart
å‡½æ•°ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è°ƒç”¨ Dart ç‰ˆæœ¬çš„ <code>wire_func</code>ã€‚æ³¨æ„ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å’Œ C
è¯­è¨€å…¼å®¹çš„å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½ä¼ é€’ç±»ä¼¼äºæŒ‡é’ˆçš„ä½çº§æ•°æ®ç±»å‹ï¼Œè€Œä¸æ˜¯é«˜çº§çš„å®‰å…¨çš„æ•°æ®ç±»å‹ã€‚</li>
<li>å½“ Rust ç‰ˆçš„ <code>wire_func</code> è¢«è°ƒç”¨æ—¶ï¼Œä¹Ÿä¼šå¯¹å‚æ•°ç±»å‹è¿›è¡Œè½¬æ¢ã€‚å³ä½¿ç”¨ <code>.wire2api()</code> å°† &quot;<em>Rust wire data</em>&quot;
(<code>wire_uint_8_list</code>ï¼Œåœ¨ Dart å’Œ Rust é—´ä¼ é€’çš„æ•°æ®) è½¬æ¢ä¸º &quot;<em>Rust api data</em>&quot; (åœ¨è¿™é‡Œå°±æ˜¯
<code>String</code>, ç”¨æˆ·çœŸæ­£ä½¿ç”¨çš„æ•°æ®).</li>
<li>æºå¸¦ç€è½¬æ¢åçš„ &quot;<em>Rust api data</em>&quot; è°ƒç”¨ <code>FLUTTER_RUST_BRIDGE_HANDLER</code>ã€‚handler
æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œæ‰€ä»¥ç”¨æˆ·å¯ä»¥æä¾›ä»–ä»¬è‡ªå·±çš„å®ç°ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹æ± ç­‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ Handler ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå¹¶åœ¨é‡Œé¢è°ƒç”¨
<code>api.rs</code> ä¸­å®šä¹‰çš„ç”±ç”¨æˆ·ç¼–å†™çš„ Rust å‡½æ•°</li>
<li>è°ƒç”¨ç”¨æˆ·ç¼–å†™çš„ <code>fn func(str: String) -&gt; String { ... }</code>ï¼Œå¹¶å¾—åˆ°è¿”å›å€¼ã€‚</li>
<li>è¿”å›å€¼ç±»å‹æ˜¯ä¸€ä¸ª <code>String</code>ï¼Œå®ƒä¼šè¢«ä¼ é€’åˆ° Dart ä¾§ã€‚è¿™æ˜¯é€šè¿‡ Dart æä¾›çš„ API
å®ç°çš„ã€‚<a href="https://github.com/dart-lang/sdk/blob/fd0d3b254690007d0ebc84175f30fa7d7491ec3e/runtime/include/dart_native_api.h#L124"><code>Dart_PostCObject</code></a>ï¼Œè¿™ä¸ªé¡¹ç›®å…è®¸æˆ‘ä»¬æä¾›
C çš„ç»“æ„ä½“ï¼Œå¹¶è‡ªåŠ¨è½¬æ¢åˆ° Dart çš„æ•°æ®ã€‚æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª Rust å®‰å…¨çš„ wrapper <code>allo-isolate</code> å»é€šä¿¡ï¼Œå› ä¸ºå®ƒå…è®¸ Dart
ä»£ç å¯ä»¥æ˜¯å¼‚æ­¥çš„è€Œä¸æ˜¯åŒæ­¥ã€‚</li>
<li>ç°åœ¨è®©æˆ‘ä»¬å›åˆ° Dart ä¸€ä¾§ï¼Œä½ åº”è¯¥ä¼šæ¥æ”¶åˆ°ä¸€äº› Dart å¯¹è±¡ï¼ˆå…¶å®å°±æ˜¯ &quot;<em>Dart wire data</em>&quot;ï¼‰ã€‚æ¥ç€æˆ‘ä»¬ä¼šä½¿ç”¨ä¸€äº›ç±»ä¼¼äº
<code>_wire2api_SomeType</code> çš„å‡½æ•°å°†å®ƒä»¬è½¬æ¢ä¸ºæœ€ç»ˆçš„ &quot;<em>Dart api data</em>&quot;ã€‚æ³¨æ„ï¼Œè¿™é‡Œæåˆ°çš„ &quot;wire2api&quot; åªå®šä¹‰åœ¨
Dart ä¸€ä¾§ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å°† &quot;<em>Dart</em> wire data&quot; è½¬æ¢ä¸º &quot;<em>Dart</em> api data&quot;ï¼Œå’Œä¹‹å‰å®šä¹‰åœ¨ Rust
ä¸­çš„ä¸ä¸€æ ·ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œç”±äº <code>Dart_PostCObject</code> å¹¶æ²¡æœ‰æä¾›æ„å»ºä»»æ„çš„ç»“æ„ä½“ï¼ˆç±»ï¼‰çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¿…é¡»å°† Rust
ç»“æ„ä½“ä¸­çš„æ‰€æœ‰å­—æ®µä½œä¸ºä¸€ä¸ªåˆ—è¡¨ä¼ é€’ï¼Œå¹¶ä½¿ç”¨ <code>wire2api</code> è½¬æ¢ä¸ºå¯¹åº”çš„ Dart ç±»ã€‚</li>
<li>æœ€ç»ˆçš„ç»“æœä¼šä»¥ Dart å‡½æ•°çš„è¿”å›å€¼å‡ºç°ï¼Œå³ç”¨æˆ·åˆšå¼€å§‹è°ƒç”¨çš„ <code>func</code> å‡½æ•°ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œå‡½æ•°è°ƒç”¨çš„æ•´ä¸ªè¿‡ç¨‹å°±ç»“æŸäº†ï¼</li>
</ol>
<h2 id="å†…å­˜å®‰å…¨"><a class="header" href="#å†…å­˜å®‰å…¨">å†…å­˜å®‰å…¨</a></h2>
<p>å¦‚ä½•ä¿éšœå†…å­˜å®‰å…¨ï¼Ÿè¿™ä¸ªå…·ä½“éœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æƒ³çœ‹ä¸€ä¸ª <code>String</code> æ˜¯å¦‚ä½•ä» Dart ä¼ é€’ç»™ Rust çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯
Dart çš„ <code>_api2wire_String</code> å’Œ Rust çš„ <code>.wire2api()</code>ã€‚</p>
<p>å®é™…ä¸Š <code>String</code> æ˜¯é€šè¿‡å§”æ´¾ç»™ <code>Vec&lt;u8&gt;</code> ç”Ÿæˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ£€æŸ¥å’Œ String å’Œ <code>Vec&lt;u8&gt;</code> ç›¸å…³
çš„ä»£ç ã€‚ç»è¿‡ä¸€ç³»åˆ—è·³è½¬ï¼Œä½ ä¼šçœ‹åˆ°ä¸‹é¢çš„ä»£ç ï¼š</p>
<pre><code class="language-dart">ffi.Pointer&lt;wire_uint_8_list&gt; _api2wire_String(String raw) {
  return _api2wire_uint_8_list(utf8.encoder.convert(raw));
}

ffi.Pointer&lt;wire_uint_8_list&gt; _api2wire_uint_8_list(Uint8List raw) {
  final ans = inner.new_uint_8_list_0(raw.length);
  ans.ref.ptr.asTypedList(raw.length).setAll(0, raw);
  return ans;
}
</code></pre>
<p>ä»¥åŠ</p>
<pre><code class="language-rust noplayground">impl Wire2Api&lt;Vec&lt;u8&gt;&gt; for *mut wire_uint_8_list {
    fn wire2api(self) -&gt; Vec&lt;u8&gt; {
        unsafe {
            let wrap = support::box_from_leak_ptr(self);
            support::vec_from_leak_ptr(wrap.ptr, wrap.len)
        }
    }
}

impl Wire2Api&lt;String&gt; for *mut wire_uint_8_list {
    fn wire2api(self) -&gt; String {
        let vec: Vec&lt;u8&gt; = self.wire2api();
        String::from_utf8_lossy(&amp;vec).into_owned()
    }
}

pub struct wire_uint_8_list {
    ptr: *mut u8,
    len: i32,
}
</code></pre>
<p>æ¢å¥è¯è¯´ï¼ŒStringï¼ˆæˆ–è€… <code>Vec&lt;u8&gt;</code>ï¼‰è¢«è½¬æ¢ä¸ºäº†ä¸€ä¸ªåŸå§‹ç»“æ„ä½“ï¼Œå®ƒå¸¦æœ‰æŒ‡é’ˆå’Œé•¿åº¦å­—æ®µã€‚å¯¹å†…å­˜çš„æ“ä½œéå¸¸å°å¿ƒï¼Œå› æ­¤ä¸ä¼šé€ æˆæ³„æ¼æˆ–é‡å¤é‡Šæ”¾ã€‚</p>
<p>æˆ‘ä»¬åŒæ—¶è¿˜ä½¿ç”¨äº† Valgrind è¿›è¡Œæ£€æŸ¥ï¼Œæˆ‘æœ¬äººå·²ç»åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®ƒï¼Œå¹¶æ²¡æœ‰å‘ç°ä»»ä½•é—®é¢˜ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒå†…å­˜é—®é¢˜ã€‚</p>
<h2 id="æƒ³äº†è§£æ›´å¤šè¯·å‘Šè¯‰æˆ‘"><a class="header" href="#æƒ³äº†è§£æ›´å¤šè¯·å‘Šè¯‰æˆ‘">æƒ³äº†è§£æ›´å¤šï¼Ÿè¯·å‘Šè¯‰æˆ‘</a></h2>
<p>ä½ è¿˜æƒ³äº†è§£å“ªäº›æ–¹é¢ï¼Ÿè¯·åœ¨ Github ä¸Šåˆ›å»ºä¸€ä¸ª Issueï¼Œæˆ‘ä¼šå‘Šè¯‰ä½ æ›´å¤š :)</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é™„å½•"><a class="header" href="#é™„å½•">é™„å½•</a></h1>
<blockquote>
<p>æ³¨æ„ï¼šä¸€äº›æ–‡æ¡£å¯èƒ½è¿‡æ—¶äº†ã€‚è¯·åœ¨ ci.yaml, ä¸»æ–‡æ¡£ï¼Œjustfile ç­‰ç­‰æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬ï¼Œetc to see an up-to-date
version. æœ¬é™„å½•å°†è¿›è¡Œå¤§ä¿®ã€‚</p>
</blockquote>
<h2 id="å‘è¡Œæ–°ç‰ˆæœ¬"><a class="header" href="#å‘è¡Œæ–°ç‰ˆæœ¬">å‘è¡Œæ–°ç‰ˆæœ¬</a></h2>
<p>é€šå¸¸æ˜¯ç”±åº“çš„æ‹¥æœ‰è€…åšçš„ (@fzyzcjy),æ‰€ä»¥ä½ åŸºæœ¬ä¸éœ€è¦åšè¿™ä¸€æ­¥ã€‚å¦‚æœä½ éœ€è¦å‘å¸ƒä¸€ä¸ªæ–°ç‰ˆæœ¬ï¼Œè‡³å°‘éœ€è¦è¿›è¡Œä»¥ä¸‹æ­¥éª¤ã€‚Bump ä¸€äº›ç‰ˆæœ¬ï¼Œåœ¨
changelog ä¸­æ”¹å˜ç‰ˆæœ¬å·ï¼Œå¹¶ä½¿ç”¨ <code>cargo check</code>æ¥è‡ªåŠ¨æ›´æ–°å®ä¾‹çš„ä¾èµ–ç‰ˆæœ¬ã€‚</p>
<pre><code>just release
</code></pre>
<h2 id="è¿è¡Œä»£ç ç”Ÿæˆå™¨çš„ç®€å•ä»£ç "><a class="header" href="#è¿è¡Œä»£ç ç”Ÿæˆå™¨çš„ç®€å•ä»£ç ">è¿è¡Œä»£ç ç”Ÿæˆå™¨çš„ç®€å•ä»£ç </a></h2>
<p>åªéœ€è¦ä»
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/.github/workflows/codegen.yml">CI codegen.yml</a>
å¤åˆ¶å³å¯ã€‚</p>
<pre><code>(cd frb_codegen &amp;&amp; cargo run --package flutter_rust_bridge_codegen --bin flutter_rust_bridge_codegen -- --rust-input ../frb_example/pure_dart/rust/src/api.rs --dart-output ../frb_example/pure_dart/dart/lib/bridge_generated.dart --dart-format-line-length 120 &amp;&amp; cargo run --package flutter_rust_bridge_codegen --bin flutter_rust_bridge_codegen -- --rust-input ../frb_example/with_flutter/rust/src/api.rs --dart-output ../frb_example/with_flutter/lib/bridge_generated.dart --c-output ../frb_example/with_flutter/ios/Runner/bridge_generated.h --dart-format-line-length 120)
</code></pre>
<h2 id="æ ¼å¼åŒ–-å’Œ-lint"><a class="header" href="#æ ¼å¼åŒ–-å’Œ-lint">æ ¼å¼åŒ– å’Œ lint</a></h2>
<pre><code>(cd frb_codegen &amp;&amp; cargo fmt --all); (cd frb_rust &amp;&amp; cargo fmt --all); (cd frb_macros &amp;&amp; cargo fmt --all); (cd frb_example/pure_dart/rust &amp;&amp; cargo fmt --all); (cd frb_example/with_flutter/rust &amp;&amp; cargo fmt --all);
(cd frb_codegen &amp;&amp; cargo clippy); (cd frb_rust &amp;&amp; cargo clippy); (cd frb_macros &amp;&amp; cargo clippy); (cd frb_example/pure_dart/rust &amp;&amp; cargo clippy); (cd frb_example/with_flutter/rust &amp;&amp; cargo clippy);
(cd frb_dart &amp;&amp; dart format . --line-length 80); (cd frb_example/pure_dart/dart &amp;&amp; dart format . --line-length 120); (cd frb_example/with_flutter &amp;&amp; dart format . --line-length 120);
(cd frb_dart &amp;&amp; dart analyze --fatal-infos); (cd frb_example/pure_dart/dart &amp;&amp; dart analyze --fatal-infos); (cd frb_example/with_flutter &amp;&amp; dart analyze --fatal-infos);
</code></pre>
<h2 id="å‡çº§ä¾èµ–çš„ç‰ˆæœ¬"><a class="header" href="#å‡çº§ä¾èµ–çš„ç‰ˆæœ¬">å‡çº§ä¾èµ–çš„ç‰ˆæœ¬</a></h2>
<pre><code>flutter pub upgrade flutter_rust_bridge
cargo update -p flutter_rust_bridge
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ•™ç¨‹pure-dart"><a class="header" href="#æ•™ç¨‹pure-dart">æ•™ç¨‹ï¼šPure Dart</a></h1>
<p><strong>æ³¨æ„</strong>: å¦‚æœä½ æƒ³äº†è§£æ¯ä¸€æ¡å…·ä½“å‘½ä»¤ï¼Œ
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/.github/workflows/test.yaml">CI workflow</a>
ä¸­çš„ <code>valgrind_test</code> éƒ¨åˆ†ä¹Ÿæ˜¯æœ‰ç”¨çš„ã€‚</p>
<p>å’Œä¹‹å‰çš„æ•™ç¨‹ä¸ä¸€æ ·ï¼Œè¿™ä¸ªæ•™ç¨‹é‡Œ Rust åªå’Œ Dart æœ¬èº«é›†æˆï¼Œæ²¡æœ‰ Flutter.</p>
<h2 id="æ‹¿åˆ°ç¤ºä¾‹ä»£ç "><a class="header" href="#æ‹¿åˆ°ç¤ºä¾‹ä»£ç ">æ‹¿åˆ°ç¤ºä¾‹ä»£ç </a></h2>
<p>è¯· <a href="https://dart.dev/get-dart">ä¸‹è½½ Dart</a>,
<a href="https://www.rust-lang.org/learn/get-started">ä¸‹è½½ Rust</a>,å¹¶ç†Ÿæ‚‰ä¸€ä¸‹ã€‚æ¥ç€è¿è¡Œ
<code>git clone https://github.com/fzyzcjy/flutter_rust_bridge</code>, ä¾‹å­åœ¨
<code>frb_example/pure_dart</code>.</p>
<h2 id="å¯é€‰-æ‰‹åŠ¨è¿è¡Œä»£ç ç”Ÿæˆ"><a class="header" href="#å¯é€‰-æ‰‹åŠ¨è¿è¡Œä»£ç ç”Ÿæˆ">(å¯é€‰) æ‰‹åŠ¨è¿è¡Œä»£ç ç”Ÿæˆ</a></h2>
<p>æ³¨æ„ï¼šä»£ç ä¼šåœ¨è¿è¡Œå®Œ <code>cargo build</code> åï¼Œé€šè¿‡ <em>build.rs</em>
é‡Œçš„æ„å»ºè„šæœ¬è‡ªåŠ¨ç”Ÿæˆã€‚æ‰€ä»¥è¿™ä¸€æ­¥æ˜¯å¯é€‰çš„ã€‚å³ä½¿ä½ å†æ¬¡è¿è¡Œï¼Œä»£ç ä¹Ÿä¸ä¼šå‘ç”Ÿä»€ä¹ˆæ”¹å˜ã€‚</p>
<p>å®‰è£…ä»£ç ç”Ÿæˆå™¨ï¼š<code>cargo install flutter_rust_bridge_codegen</code>.</p>
<p>è¿è¡Œï¼š
<code>flutter_rust_bridge_codegen --rust-input frb_example/pure_dart/rust/src/api.rs --dart-output frb_example/pure_dart/dart/lib/bridge_generated.dart</code>
(ä½ å¯ä»¥å°†
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/.github/workflows/codegen.yml">CI workflow</a>
æœ€ä¸ºæŸ¥é˜…æ‰‹å†Œ.) (å¯¹ Windows ç”¨æˆ·ï¼Œä½ å¯èƒ½éœ€è¦åœ¨è·¯å¾„é‡Œç”¨ <code>\\</code> ä»£æ›¿ <code>/</code>.)</p>
<h2 id="run-dartrust-app"><a class="header" href="#run-dartrust-app">Run &quot;Dart+Rust&quot; app</a></h2>
<p>ä½ å¯ä»¥å°† <code>frb_example/pure_dart/dart/lib/main.dart</code> ä½œä¸ºä¸€ä¸ªæ™®é€šçš„ Dart ç¨‹åºè¿è¡Œï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ï¼Œä½ éœ€è¦æä¾›
Rust çš„åŠ¨æ€è¿æ¥åº“ (ç®€å•èµ·è§ï¼Œè¿™é‡Œæˆ‘åªæ¼”ç¤ºåŠ¨æ€é“¾æ¥åº“çš„æ–¹æ³•ï¼Œä½†ä½ å½“ç„¶å¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼‰è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ã€‚</p>
<p>åœ¨ <code>frb_example/pure_dart/rust</code> ç›®å½•ä¸‹è¿è¡Œ <code>cargo build</code> å°† Rust ä»£ç ç¼–è¯‘ä¸º <code>.so</code> æ–‡ä»¶ã€‚æ¥ç€æ‰§è¡Œ
<code>dart frb_example/pure_dart/dart/lib/main.dart frb_example/pure_dart/rust/target/debug/libflutter_rust_bridge_example.so</code>
å»è¿è¡Œ Dart ç¨‹åºã€‚</p>
<p>(å¦‚æœä½ çš„è¿è¡Œå‡ºç°é—®é¢˜ï¼Œè¯·çœ‹ &quot;Troubleshooting&quot; éƒ¨åˆ†) (å¦‚æœä½ çš„å¹³å°æ˜¯ MacOS, Rust åº”è¯¥ä¼šç”Ÿæˆ<code>.dylib</code>, è¯·æŠŠå‘½ä»¤é‡Œçš„
<code>...dylib</code> æ›¿æ¢ä¸º <code>...so</code>)</p>
<p>P.S. è¿™ä¸ªä¾‹å­é‡Œå¹¶æ²¡æœ‰ UI æˆ–å…¶ä»–åŠŸèƒ½ï¼Œä½ åªèƒ½çœ‹åˆ°ä¸€äº›æµ‹è¯•é€šè¿‡çš„ä¿¡æ¯ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å®‰å…¨é¡¾è™‘"><a class="header" href="#å®‰å…¨é¡¾è™‘">å®‰å…¨é¡¾è™‘</a></h1>
<p>è¯¥åº“ä½¿ç”¨ CI å·¥ä½œæµï¼Œå¹¶ä¼šåœ¨è®¾ç½®è¿‡ç¨‹ä¸­è‡ªåŠ¨è¿è¡Œ <a href="https://www.valgrind.org/">Valgrind</a> ï¼Œå½“ Dart ç¨‹åºä½¿ç”¨è¯¥åº“è°ƒç”¨
Rust ç¨‹åºæ—¶ï¼ŒValgrind èƒ½åŠæ—¶å‘ç°å†…å­˜å®‰å…¨é—®é¢˜
<sub>( æ³¨æ„ï¼šå³æ—¶ä½ åªè¿è¡Œä¸€ä¸ªç®€å•çš„ hello-world Dart ç¨‹åºï¼ŒValgrind ä¹Ÿä¼šæ£€æµ‹åˆ°å‡ ç™¾ä¸ªé”™è¯¯ã€‚è¯·æŸ¥çœ‹
<a href="https://github.com/dart-lang/sdk/issues/47346">this Dart lang issue</a>
äº†è§£æ›´å¤šã€‚å› æ­¤ï¼Œæˆ‘æ£€æŸ¥äº† Valgrind æŠ¥å‘Šçš„æ‰€æœ‰ &quot;definitely lost&quot;, å¹¶ä¸”æ‰‹åŠ¨åœ¨åº“é‡Œæœç´¢ -
å¦‚æœæŠ¥å‘Šçš„æ‰€æœ‰é”™è¯¯éƒ½å’Œè¯¥åº“æ— å…³ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯å®‰å…¨çš„)</sub></p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œä¸ Flutter çš„é›†æˆä¹Ÿæ˜¯é€šè¿‡ CI å®Œæˆã€‚ç¡®ä¿äº†ä½¿ç”¨è¯¥åº“çš„ Flutter åº”ç”¨ä¸ä¼šäº§ç”Ÿé—®é¢˜ã€‚</p>
<p>å¤§å¤šæ•°ä»£ç éƒ½æ˜¯ safe Rustã€‚ <code>unsafe</code> ä»£ç ä¸»è¦æ¥è‡ª <code>support::box_from_leak_ptr</code> å’Œ
<code>support::vec_from_leak_ptr</code>. ä»–ä»¬è¢«ç”¨äºå¤„ç†æŒ‡é’ˆå’Œæ•°ç»„ï¼Œæˆ‘ä¼šéµå¾ªé«˜ç¥¨æ•°çš„ç­”æ¡ˆå’Œå®˜æ–¹æ–‡æ¡£ç¼–å†™ç›¸å…³ä»£ç ã€‚</p>
<p>æˆ‘åœ¨æˆ‘çš„ä¸ªäºº Flutter é¡¹ç›® (<code>yplusplus</code>, or <code>why++</code>) é‡Œéå¸¸é¢‘ç¹çš„ä½¿ç”¨åˆ°äº†è¯¥åº“ã€‚é‚£äº› app
å·²ç»ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œå¹¶ä¸”è¿è¡Œéå¸¸ç¨³å®šï¼Œå¦‚æœæˆ‘è‡ªå·±è§‚å¯Ÿåˆ°äº†ä»»ä½•é—®é¢˜ï¼Œæˆ‘ä¼šä¿®å¤ç›¸å…³ bugã€‚</p>
<p>CI åŒæ—¶ä¼šè¿è¡Œ <code>run_codegen</code> å·¥ä½œæµï¼Œç¡®ä¿ç”Ÿæˆçš„ä»£ç å¯ä»¥é€šè¿‡ç¼–è¯‘ã€‚æœ€åï¼ŒCI è¿˜ä¼šè¿è¡Œä»£ç æ ¼å¼åŒ–å’Œ linter(<code>fmt</code>,
<code>clippy</code>, <code>dart analyze</code>, <code>dart format</code>), linter ä¹Ÿèƒ½æ•è·åˆ°ä¸€äº›å¸¸è§é”™è¯¯ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h1>
<h2 id="the-generated-store_dart_post_cobject-has-the-wrong-signature--stdargh-file-not-found-in-linux--stdboolh--"><a class="header" href="#the-generated-store_dart_post_cobject-has-the-wrong-signature--stdargh-file-not-found-in-linux--stdboolh--">The generated store_dart_post_cobject() has the wrong signature / <code>'stdarg.h' file not found</code> in Linux / <code>stdbool.h</code> / ...</a></h2>
<p>Try to run code generator with working directory at <code>/</code>, or set the environment
variable:</p>
<pre><code class="language-bash">export CPATH=&quot;$(clang -v 2&gt;&amp;1 | grep &quot;Selected GCC installation&quot; | rev | cut -d' ' -f1 | rev)/include&quot;
</code></pre>
<p>as described in <a href="https://github.com/dart-lang/ffigen/issues/257">ffigen #257</a>,
or add include path as is described in
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/108">#108</a>. This is a
problem with Rust's builtin <code>Command</code>. See also:
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/472">#472</a> &amp;
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/494">#494</a>.</p>
<h2 id="issue-with-store_dart_post_cobject"><a class="header" href="#issue-with-store_dart_post_cobject">Issue with <code>store_dart_post_cobject</code></a></h2>
<p>If calling rust function gives the error below, please consider running <strong>cargo
build</strong> again. This can happen when the generated rs file is not included when
building is being done.</p>
<pre><code class="language-sh">[ERROR:flutter/lib/ui/ui_dart_state.cc(209)] Unhandled Exception: Invalid argument(s): Failed to lookup symbol 'store_dart_post_cobject': target/debug/libadder.so: undefined symbol: store_dart_post_cobject
</code></pre>
<h2 id="error-running-cargo-ndk-ld-error-unable-to-find-library--lgcc"><a class="header" href="#error-running-cargo-ndk-ld-error-unable-to-find-library--lgcc">Error running <code>cargo ndk</code>: <code>ld: error: unable to find library -lgcc</code></a></h2>
<p>Downgrade Android NDK to version 22. This is an
<a href="https://github.com/bbqsrc/cargo-ndk/issues/22">ongoing issue</a> with <code>cargo-ndk</code>,
a library unrelated to flutter_rust_bridge but solely used to build the
examples, when using Android NDK version 23. (See
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/149">#149</a>)</p>
<h2 id="fail-to-run-flutter_rust_bridge_codegen-on-macos-please-supply-one-or-more-pathtollvm"><a class="header" href="#fail-to-run-flutter_rust_bridge_codegen-on-macos-please-supply-one-or-more-pathtollvm">Fail to run <code>flutter_rust_bridge_codegen</code> on MacOS, &quot;Please supply one or more path/to/llvm...&quot;</a></h2>
<p>If you are running macOS, you will need to specify a path to your llvm:</p>
<pre><code class="language-shell">flutter_rust_bridge_codegen --rust-input path/to/your/api.rs --dart-output path/to/file/being/bridge_generated.dart --llvm-path /usr/local/homebrew/opt/llvm/
</code></pre>
<p>You can install llvm using <code>brew install llvm</code> and it will be installed at
<code>/usr/local/homebrew/opt/llvm/</code> by default.</p>
<h2 id="freezed-file-is-sometimes-not-generated-when-it-should-be"><a class="header" href="#freezed-file-is-sometimes-not-generated-when-it-should-be">Freezed file is sometimes not generated when it should be</a></h2>
<p>If your <code>.freezed.dart</code> or <code>.g.dart</code> seems outdated, ensure you have run the
<code>build_runner</code>.</p>
<p>Related: https://github.com/fzyzcjy/flutter_rust_bridge/issues/330</p>
<h2 id="cant-create-typedef-from-non-function-type"><a class="header" href="#cant-create-typedef-from-non-function-type"><code>Can't create typedef from non-function type.</code></a></h2>
<p>Ensure min sdk version of Flutter <code>pubspec.yaml</code> is at least 2.13.0 to let
<code>ffigen</code> happy.</p>
<p>https://github.com/fzyzcjy/flutter_rust_bridge/issues/334</p>
<h2 id="generated-code-is-so-long"><a class="header" href="#generated-code-is-so-long">Generated code is so long</a></h2>
<p>Indeed all generated code are necessary (if you find something that can be
simplified, file an issue). Moreover, other code generation tools also generate
long code - for example, when using Google protobuf, a very popular
serialization library, I see &gt;10k lines of Java code generated for a quite
simple source proto file.</p>
<h2 id="ä¸ºä»€ä¹ˆéœ€è¦-dart-2140"><a class="header" href="#ä¸ºä»€ä¹ˆéœ€è¦-dart-2140">ä¸ºä»€ä¹ˆéœ€è¦ Dart <code>2.14.0</code></a></h2>
<p>è¿™ä¸ªåº“å¹¶ä¸éœ€è¦ Dart SDK <code>&gt;=2.14.0</code>, ä½†æ˜¯æœ€æ–°çš„ <code>ffigen</code> å·¥å…·éœ€è¦ã€‚æ‰€ä»¥æ‰ä¼šåœ¨ <code>pubspec.yaml</code> çš„
<code>environment</code> ä¸­é™åˆ¶ <code>sdk: &quot;&gt;=2.14.0 &lt;3.0.0&quot;</code>. å¦‚æœä½ éœ€è¦æ‘†è„±è¿™ä¸ªé™åˆ¶ï¼Œè¯·è€ƒè™‘ä½¿ç”¨æ›´è€ç‰ˆæœ¬çš„ <code>ffigen</code> å·¥å…·ã€‚</p>
<h2 id="å…¶å®ƒé—®é¢˜"><a class="header" href="#å…¶å®ƒé—®é¢˜">å…¶å®ƒé—®é¢˜ï¼Ÿ</a></h2>
<p>ä¸è¦çŠ¹è±«
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/new/choose">open an issue</a>!
æˆ‘é€šå¸¸ä¼šåœ¨å‡ åˆ†é’Ÿæˆ–è€…æ˜¯å‡ å°æ—¶å†…å›å¤ (å½“ç„¶é™¤äº†æˆ‘ç¡è§‰æ—¶ :D).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å‘½ä»¤è¡Œå‚æ•°"><a class="header" href="#å‘½ä»¤è¡Œå‚æ•°">å‘½ä»¤è¡Œå‚æ•°</a></h1>
<p>åŠ ä¸Š <code>--help</code> æŸ¥çœ‹å®Œæ•´æ–‡æ¡£ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå¿«ç…§ (å¯èƒ½å·²ç»è¿‡æœŸ):</p>
<pre><code class="language-shell">flutter_rust_bridge_codegen 1.20.1

USAGE:
    flutter_rust_bridge_codegen [FLAGS] [OPTIONS] --dart-output &lt;dart-output&gt; --rust-input &lt;rust-input&gt;

FLAGS:
        --skip-add-mod-to-lib    Skip automatically adding `mod bridge_generated;` to `lib.rs`
        --no-build-runner        Skip running build_runner even when codegen-capable code is detected
    -v, --verbose                Show debug messages
    -h, --help                   Prints help information
    -V, --version                Prints version information

OPTIONS:
    -r, --rust-input &lt;rust-input&gt;                              Path of input Rust code
    -d, --dart-output &lt;dart-output&gt;                            Path of output generated Dart code
        --dart-decl-output &lt;dart-decl-output&gt;
            If provided, generated Dart declaration code to this separate file

    -c, --c-output &lt;c-output&gt;...                               Path of output generated C header
        --rust-crate-dir &lt;rust-crate-dir&gt;                      Crate directory for your Rust project
        --rust-output &lt;rust-output&gt;                            Path of output generated Rust code
        --class-name &lt;class-name&gt;                              Generated class name
        --dart-format-line-length &lt;dart-format-line-length&gt;    Line length for dart formatting
        --llvm-path &lt;llvm-path&gt;...                             Path to the installed LLVM
        --llvm-compiler-opts &lt;llvm-compiler-opts&gt;              LLVM compiler opts
        --dart-root &lt;dart-root&gt;
            Path to root of Dart project, otherwise inferred from --dart-output
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä»-0-è®¾ç½®-flutterdartrust-ç¯å¢ƒ"><a class="header" href="#ä»-0-è®¾ç½®-flutterdartrust-ç¯å¢ƒ">ä» 0 è®¾ç½® Flutter/Dart+Rust ç¯å¢ƒ</a></h1>
<blockquote>
<p>This documentation is archived, though technically still correct. Have a look
at <a href="integrate.html">integrating with existing projects</a> chapters for a more
detailed demonstration.</p>
</blockquote>
<p>I suggest that you can start with the
<a href="https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/frb_example/with_flutter">Flutter example</a>
first, and modify it to satisfy your needs. It can serve as a template for new
projects. It is run against CI so we are sure it works.</p>
<p>Indeed, this library is nothing but a code generator that helps your
Flutter/Dart functions call Rust functions. Therefore, &quot;how to create a Flutter
app that can run Rust code&quot; is actually out of the scope of this library, and
there are already several tutorials on the Internet.</p>
<p>However, I can sketch the outline of what to do if you want to set up a new
Flutter+Rust project as follows.</p>
<h2 id="step-1"><a class="header" href="#step-1">Step 1</a></h2>
<p>Create a new Flutter project (or use an existing one). The Dart SDK should be
<code>&gt;=2.14.0</code> if you want to use the latest <code>ffigen</code> tool.</p>
<h2 id="step-2"><a class="header" href="#step-2">Step 2</a></h2>
<p>Create a new Rust project, say, at directory <code>rust</code> under the Flutter project.</p>
<h2 id="step-3"><a class="header" href="#step-3">Step 3</a></h2>
<p>Edit <code>Cargo.toml</code> and add:</p>
<pre><code class="language-diff">[lib]
name = &quot;flutter_rust_bridge_example&quot; # whatever you like
# notice this type. `cdylib` for android, and `staticlib` for iOS. I write down a script to change it before build.
+ crate-type = [&quot;cdylib&quot;]
</code></pre>
<h2 id="step-4"><a class="header" href="#step-4">Step 4</a></h2>
<p>Follow the standard steps of &quot;how iOS uses static libraries&quot;.</p>
<ol>
<li>In XCode, edit <code>Strip Style</code> in <code>Build Settings</code> to <code>Debugging Symbols</code>.</li>
<li>Add your <code>lib{crate}.a</code> to <code>Link Binary With Libraries</code> in <code>Build Phases</code>.</li>
<li>Add <code>binding.h</code> to <code>Copy Bundle Resources</code>.</li>
<li>Add <code>#import &quot;binding.h&quot;</code> to <code>Runner-Bridging-Header</code>.</li>
<li>Last but not least, add a never-to-be-executed dummy function in Swift that
calls any of the generated C bindings. This lib has already generated a dummy
method for you, so you simply need to add
<code>print(&quot;dummy_value=\(dummy_method_to_enforce_bundling())&quot;);</code> to swift file's
<code>override func application(...) {}</code>, and this will prevent symbol stripping -
especially in the release build for iOS (i.e. when building ipa file or
releasing to App Store). Notice that, we have to use that
<code>dummy_method_to_enforce_bundling()</code>, otherwise the symbols will not maintain
in the release build, and Flutter will complain it cannot find the symbols.</li>
</ol>
<h2 id="step-5"><a class="header" href="#step-5">Step 5</a></h2>
<p>Lastly, in order to build the Rust library automatically when you are building
Flutter, follow <a href="https://stackoverflow.com/q/69515032/4619958">this tutorial</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ–‡ç« "><a class="header" href="#æ–‡ç« ">æ–‡ç« </a></h1>
<p>è¿™ä¸€ç« åŒ…å«äº†ä¸€äº›å’Œ <code>flutter_rust_bridge</code> ç›¸å…³çš„æ–‡ç« ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-å¼‚æ­¥"><a class="header" href="#rust-å¼‚æ­¥">Rust å¼‚æ­¥</a></h1>
<blockquote>
<p>ä½œè€…ï¼š@AlienKevin</p>
</blockquote>
<p>This library does not yet support returning a Future type from Rust and this has
to do with the difficulty of uniting the various approaches to async in Rust.
The
<a href="https://rust-lang.github.io/async-book/01_getting_started/03_state_of_async_rust.html#language-and-library-support">Rust Book</a>
summarized the current state of async support succinctly:</p>
<blockquote>
<p>The most fundamental traits, types and functions, such as the Future trait are
provided by the standard library. The async/await syntax is supported directly
by the Rust compiler.</p>
</blockquote>
<blockquote>
<p>Many utility types, macros and functions are provided by the futures crate.
They can be used in any async Rust application.</p>
</blockquote>
<blockquote>
<p>Execution of async code, IO and task spawning are provided by &quot;async
runtimes&quot;, such as Tokio and async-std. Most async applications, and some
async crates, depend on a specific runtime.</p>
</blockquote>
<p>While the futures crate provides an executor called
<code>futures::executor::block_on</code>, libraries that use Tokio runtime cannot use this
executor. According to
<a href="https://runrust.miraheze.org/wiki/Async_crate_comparison">Rust-lang community wiki</a>,
crates like Tokio that provide both a runtime and IO abstractions often have
their IO depend on the runtime. This can make it difficult to write
runtime-agnostic code. First, we demonstrate a common use case of async
programming in Rust by attempting to fetch the content of a file from the
internet using the popular HTTP Client
<a href="https://docs.rs/reqwest/0.11.6/reqwest/">Reqwest</a>:</p>
<pre><code class="language-rust ignore">use anyhow;

async fn get() -&gt; anyhow::Result&lt;String&gt; {
    let url = &quot;https://link/to/file/download&quot;;
    let data = reqwest::get(url).await?.text().await?;
    Ok(data)
}
</code></pre>
<p>When you try to generate bindings for the <code>get</code> function, the generated code
will contain errors because this library does not support returning Future from
Rust.</p>
<h2 id="mismatched-runtime"><a class="header" href="#mismatched-runtime">Mismatched runtime</a></h2>
<p>The next logic thing to try would be to convert the asynchronous code to
synchronous by directly blocking the current thread and execute the code. For
our first attempt, we wrap <code>futures::executor::block_on</code> around an async block
containing reqwest calls.</p>
<pre><code class="language-rust ignore">use anyhow;
use futures::executor::block_on;

fn get() -&gt; anyhow::Result&lt;String&gt; {
    block_on(async {
        let url = &quot;https://link/to/file/download&quot;;
        let data = reqwest::get(url).await?.text().await?;
        Ok(data)
    })
}
</code></pre>
<p>Since Reqwest uses the Tokio runtime instead of the futures runtime, our code
panicked with the error &quot;there is no reactor running, must be called from the
context of a Tokio 1.x runtime&quot;. To fix this error, we have two ways to execute
async codes using the Tokio runtime. Approach 1 is the simplest and uses the
convenient <a href="https://docs.rs/tokio/1.14.0/tokio/attr.main.html"><code>tokio::main</code></a>
macro to turn an async function to a synchronous one. Approach 2 requires you to
explicitly create a new Tokio runtime and use its block_on function to run the
future to completion.</p>
<h2 id="approach-1-macro"><a class="header" href="#approach-1-macro">Approach 1 (macro)</a></h2>
<pre><code class="language-rust ignore">use anyhow;

#[tokio::main(flavor = &quot;current_thread&quot;)]
async fn get() -&gt; anyhow::Result&lt;String&gt; {
    let url = &quot;https://link/to/file/download&quot;;
    let data = reqwest::get(url).await?.text().await?;
    Ok(data)
}
</code></pre>
<p>It has the following dependencies:</p>
<pre><code class="language-toml">[dependencies]
futures = &quot;0.3&quot;
reqwest = &quot;0.11.6&quot;
tokio = { version = &quot;1.14.0&quot;, features = [&quot;rt&quot;, &quot;macros&quot;] }
anyhow = { version = &quot;1.0.49&quot; }
</code></pre>
<h2 id="approach-2-runtime"><a class="header" href="#approach-2-runtime">Approach 2 (runtime)</a></h2>
<pre><code class="language-rust ignore">use anyhow;
use tokio::runtime::Runtime;

fn get() -&gt; anyhow::Result&lt;String&gt; {
    let rt = Runtime::new().unwrap();
    rt.block_on(async {
        let url = &quot;https://link/to/file/download&quot;;
        let data = reqwest::get(url).await?.text().await?;
        Ok(data)
    })
}
</code></pre>
<p>It has the following dependencies:</p>
<pre><code class="language-toml">[dependencies]
futures = &quot;0.3&quot;
reqwest = &quot;0.11.6&quot;
tokio = { version = &quot;1.14.0&quot;, features = [&quot;rt-multi-thread&quot;] }
anyhow = { version = &quot;1.0.49&quot; }
</code></pre>
<h2 id="plain-futures"><a class="header" href="#plain-futures">Plain futures</a></h2>
<p>If you are using the plain futures crate without runtimes like Tokio, you should
be safe to wrap the asynchronous code in an async block and use the
<a href="https://docs.rs/futures/0.3.18/futures/executor/fn.block_on.html"><code>futures::executor::block_on</code></a>
to run the future to completion:</p>
<pre><code class="language-rust ignore">use futures::executor::block_on;

async fn hello_world() -&gt; String {
    &quot;hello, world!&quot;.to_string()
}

fn get() -&gt; String {
    block_on(async {
        hello_world().await
    })
}

fn main() {
    println!(&quot;{}&quot;, get()); // prints &quot;hello, world!&quot;
}
</code></pre>
<h2 id="avoid-async"><a class="header" href="#avoid-async">Avoid async</a></h2>
<p>Lastly, you can avoid async code all together by using synchronously/blocking
version of the functions if they are available. In Reqwest, there's a module
called <code>reqwest::blocking</code> designed specifically for this purpose. So you can
achieve the same thing above without using async.</p>
<pre><code class="language-rust ignore">use anyhow;
use reqwest;

fn get() -&gt; anyhow::Result&lt;String&gt; {
    let url = &quot;https://link/to/file/download&quot;;
    let data = reqwest::blocking::get(url)?.text()?;
    Ok(data)
}
</code></pre>
<p>It has the following dependencies:</p>
<pre><code class="language-toml">[dependencies]
futures = &quot;0.3&quot;
reqwest = { version = &quot;0.11.6&quot;, features = [&quot;blocking&quot;] }
anyhow = { version = &quot;1.0.49&quot; }
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="generating-multiple-files"><a class="header" href="#generating-multiple-files">Generating multiple files</a></h1>
<blockquote>
<p>Author: @dbsxdbsx</p>
</blockquote>
<p>This article describes some thoughts and implementations about the feature of generating multiple files.</p>
<p>Before, like the <a href="https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/frb_example/pure_dart/rust/src/api.rs">pure_dart's api.rs</a>, all APIs are exposed together in a single file(block). This is not bad when the whole project is simple. But it would become quite hard to maintain or develop, when the project becomes more and more complex, especially when it is a team project. Therefore, it is time to reconstruct code --- classify the exposed Api into proper blocks(files).</p>
<p>(Before going on reading, make sure that you are quite familiar with how to use <a href="https://github.com/Desdaemon/flutter_rust_bridge_template">template</a> to generate code with flutter_rust_bridge. If not, take a look at the former chapters or <a href="https://github.com/fzyzcjy/flutter_rust_bridge/tree/master/frb_example/pure_dart">the basic example</a> again, please.)</p>
<h2 id="try-to-classify-api-into-different-blocksfiles"><a class="header" href="#try-to-classify-api-into-different-blocksfiles">Try to classify Api into different blocks(files)</a></h2>
<p>Suppose, you only have two Api in <code>api.rs</code> originally, like this:</p>
<pre><code class="language-rust noplayground">#![allow(unused_variables)]

pub fn simple_add(a: i32, b: i32) -&gt; i32 {
    a + b
}

pub fn simple_minus(a: i32, b: i32) -&gt; i32 {
    a - b
}
</code></pre>
<p>Now you want to classify these 2 Api into 2 blocks for some reason-- say, you put the <code>simple_add</code> Api into file <code>api_1.rs</code> and the other into <code>api_2.rs</code>. And then make a little modification in <code>lib.rs</code>:</p>
<pre><code class="language-rust noplayground">mod api_1;
mod api_2;
</code></pre>
<p>Ok, now the question is how to deal with them with flutter_rust_bridge? From the <a href="https://github.com/Desdaemon/flutter_rust_bridge_template/blob/main/justfile#L11">template justfile</a>, we know code from a single API file called <code>api_rs</code> can be generated with a command like this:</p>
<pre><code>gen:
    export REPO_DIR=&quot;$PWD&quot;; cd /; flutter_rust_bridge_codegen {{llvm_path}} \
        --rust-input &quot;$REPO_DIR/native/src/api.rs&quot; \
        --dart-output &quot;$REPO_DIR/lib/bridge_generated.dart&quot; \
...
</code></pre>
<p>(For simplicity, only two necessary flags <code>rust-input</code> and <code>dart-output</code> here.)</p>
<p>Then, to generate code within 2 blocks(files), you may come out with an approach like this:</p>
<pre><code>gen:
    export REPO_DIR=&quot;$PWD&quot;; cd /; flutter_rust_bridge_codegen {{llvm_path}} \
        --rust-input &quot;$REPO_DIR/native/src/api_1.rs&quot; \
        --dart-output &quot;$REPO_DIR/lib/bridge_generated_api_1.dart&quot; \

    export REPO_DIR=&quot;$PWD&quot;; cd /; flutter_rust_bridge_codegen {{llvm_path}} \
        --rust-input &quot;$REPO_DIR/native/src/api_2.rs&quot; \
        --dart-output &quot;$REPO_DIR/lib/bridge_generated_api_2.dart&quot; \
...
</code></pre>
<p>But here comes a problem, how to use them in dart? Like <code>await API.simpleAdd(1,2)</code> or
<code>await API.simpleMinus(1,2)</code> as before? The point here is, to thoroughly decouple Api from different blocks (which is the main reason for using multiple blocks of API), <strong>flag <code>class-name</code> is needed</strong>. So the command should be modified like this:</p>
<pre><code>gen:
    export REPO_DIR=&quot;$PWD&quot;; cd /; flutter_rust_bridge_codegen {{llvm_path}} \
        --rust-input &quot;$REPO_DIR/native/src/api_1.rs&quot; \
        --dart-output &quot;$REPO_DIR/lib/bridge_generated_api_1.dart&quot; \
        --class-name ApiClass1

    export REPO_DIR=&quot;$PWD&quot;; cd /; flutter_rust_bridge_codegen {{llvm_path}} \
        --rust-input &quot;$REPO_DIR/native/src/api_2.rs&quot; \
        --dart-output &quot;$REPO_DIR/lib/bridge_generated_api_2.dart&quot; \
        --class-name ApiClass2
...
</code></pre>
<p>(The class name <code>ApiClass1</code> and <code>ApiClass2</code> are chosen arbitrarily here.)</p>
<p>So now it seems to be perfect to generate code and using Api in Dart like <code>ApiClass1.simpleAdd(1,2)</code> or <code>ApiClass2.simpleMinus(1,2)</code>.</p>
<p>But actually, the above command is still not enough to generate code correctly. Because multiple blocks need to be translated respectively through FFI. So on the rust side, instead of generating code to a single file <a href="https://github.com/Desdaemon/flutter_rust_bridge_template/blob/main/native/src/bridge_generated.rs"><code>bridge_generated.rs</code></a>, now there are 2 files needed. But, what are the names of these 2 auto-generated rust files?
Here, for less misunderstanding, flutter_rust_bridge decides to ask for another compulsory flag <code>rust-output</code>. So the command should be modified like this:</p>
<pre><code>gen:
    export REPO_DIR=&quot;$PWD&quot;; cd /; flutter_rust_bridge_codegen {{llvm_path}} \
        --rust-input &quot;$REPO_DIR/native/src/api_1.rs&quot; \
        --dart-output &quot;$REPO_DIR/lib/bridge_generated_api_1.dart&quot; \
        --class-name ApiClass1 \
        --rust-output generated_api_1

    export REPO_DIR=&quot;$PWD&quot;; cd /; flutter_rust_bridge_codegen {{llvm_path}} \
        --rust-input &quot;$REPO_DIR/native/src/api_2.rs&quot; \
        --dart-output &quot;$REPO_DIR/lib/bridge_generated_api_2.dart&quot; \
        --class-name ApiClass2 \
        --rust-output generated_api_2
...
</code></pre>
<p>(Still, the rust output name <code>generated_api_1</code> and <code>generated_api_2</code> are chosen arbitrarily here.)</p>
<p>That is, flutter_rust_bridge asks you to manually define the generated rust file names, feel free to choose any name you like.</p>
<h2 id="some-issues-with-separate-commands"><a class="header" href="#some-issues-with-separate-commands">Some issues with separate commands</a></h2>
<p>Based on the last commands we come up with, everything seems to be fine --- the code generated, you can use them in Dart, and the whole project is compilable. And you would also notice some changes in <code>lib.rs</code>:</p>
<pre><code class="language-rust noplayground">mod api_1;
mod api_2;
mod generated_api_1; /* AUTO INJECTED BY flutter_rust_bridge. This line may not be accurate, and you can change it according to your needs. */
mod generated_api_2; /* AUTO INJECTED BY flutter_rust_bridge. This line may not be accurate, and you can change it according to your needs. */
</code></pre>
<p>But actually, it is not good enough.</p>
<h3 id="issue-from-explicit-api-conflict"><a class="header" href="#issue-from-explicit-api-conflict">issue from explicit Api conflict</a></h3>
<p>Let's say one day, you decide to add another API, say <code>simpleDivide</code>. But when you compile the whole project, the Dart compiler just complains &quot;The symbol <code>simpleDivide</code> has already been defined ...&quot;. Then you check whether this <code>simpleDivide</code> is defined duplicated. Finally, you find that it's already defined in another block. This situation occurs quite a lot, when the other block is in the charge of someone else, especially in a big project. It is easy to see that the whole routine is a little inefficient since you don't realize the Api conflict until doing compiling when you've probably coded a lot with this &quot;new defined&quot; Api --- and the more time compiling takes, the more inefficient.</p>
<h3 id="issue-from-implicit-api-conflict"><a class="header" href="#issue-from-implicit-api-conflict">issue from implicit Api conflict</a></h3>
<p>And what makes the Api conflict issue more catastrophic? Say you define another Api with parameter <code>String</code> in <code>api_1.rs</code>:</p>
<pre><code class="language-rust noplayground">pub fn test_string_1(s1: String) {
    println!(&quot;test implicit parameter conflicts {}&quot;, s1);
}
</code></pre>
<p>And then you put another Api with parameter <code>String</code> in <code>api_2.rs</code>:</p>
<pre><code class="language-rust noplayground">pub fn test_string_2(s2: String) {
    println!(&quot;test implicit parameter conflicts {}&quot;, s2);
}
</code></pre>
<p>These 2 Apis don't violate the uniqueness required by FFI. They should be compilable with no error. But the truth is no! Why? Because for the <code>String</code> parameter, flutter_rust_bridge would automatically generate API like this:</p>
<pre><code class="language-rust noplayground">#[no_mangle]
pub extern &quot;C&quot; fn new_uint_8_list(len: i32) -&gt; *mut wire_uint_8_list
</code></pre>
<p>which is used to let rust code easily cooperate with Dart through FFI. So if there are 2 APIs both taking <code>String</code> as parameters over blocks, you should notice a similar panic like &quot;the symbol <code>new_uint_8_list</code> is already defined ...&quot; during compiling(<a href="https://github.com/fzyzcjy/flutter_rust_bridge/issues/511">issue #511</a>).</p>
<p>(Actually, since version <a href="https://github.com/fzyzcjy/flutter_rust_bridge/releases/tag/v1.37.0">1.37</a>, even with the separated commands with no Api defined, the whole project is still not compilable with error &quot;symbol <code>free_WireSyncReturnStruct</code> is already defined... &quot;, the symbol <code>free_WireSyncReturnStruct</code> is another implicitly Api generated by flutter_rust_bridge.)</p>
<p>So these kinds of explicit/implicit Api conflicts are annoying and frustrating. How to resolve it?</p>
<p>Theoretically, the conflict can be detected earlier during generating code, when flutter_rust_bridge knows every detail about API. But the key is that <strong>flutter_rust_bridge has to know all Api over all blocks before generating code</strong>. That is, with the separated command stated above, flutter_rust_bridge can't do the check for you in practice. Therefore, it is necessary to unite the separated commands into ONE command.</p>
<h2 id="correct-command-for-generating-code-with-multiple-blocks"><a class="header" href="#correct-command-for-generating-code-with-multiple-blocks">correct command for generating code with multiple blocks</a></h2>
<p>Now comes the joined command to resolve the above issue:</p>
<pre><code>gen:
    export REPO_DIR=&quot;$PWD&quot;; cd /; flutter_rust_bridge_codegen {{llvm_path}} \
        --rust-input &quot;$REPO_DIR/native/src/api_1.rs&quot; &quot;$REPO_DIR/native/src/api_2.rs&quot; \
        --dart-output &quot;$REPO_DIR/lib/bridge_generated_api_1.dart&quot; &quot;$REPO_DIR/lib/bridge_generated_api_2.dart&quot; \
        --class-name ApiClass1 ApiClass2 \
        --rust-output generated_api_1 generated_api_2
...
</code></pre>
<p>Here, with just 1 command, flutter_rust_bridge would smartly check if there are conflicts over all Api over all blocks, be it defined explicitly or implicitly.</p>
<p>That is, for the explicitly defined APIs like <code>simple_add</code> and <code>simple_minus</code>, if there are duplicated ones, flutter_rust_bridge would throw a panic like &quot;thread 'main' panicked at 'symbol [simple_add] has already been defined'...&quot;, and you are responsible to fix it. And for the implicitly defined API like <code>new_uint_8_list</code>, since it is essential, flutter_rust_bridge would try to work around it by adding suffix starting from 0, like <code>new_uint_8_list_0</code> and <code>new_uint_8_list_1</code>.</p>
<p>To sum up, <strong>there are 4 compulsory flags when you deal with multiple blocks.</strong> They are <code>rust-input</code>, <code>dart-output</code>, <code>class-name</code> and <code>rust-output</code>. Also, the number of fields following each flag should be consistent. You can try to <code>cargo build</code> with fewer flags or inconsistent fields to see what kind of panic would be popped up with the <a href="https://github.com/fzyzcjy/flutter_rust_bridge/tree/master/frb_example/pure_dart_multi/rust/build.rs">pure_dart_multi</a> example when doing generation.</p>
<h2 id="bizarre-weird-but-compilable-command-with-the-disorder"><a class="header" href="#bizarre-weird-but-compilable-command-with-the-disorder">bizarre, weird but compilable command with the disorder</a></h2>
<p><strong>Flutter_rust_bridge doesn't do semantic correction over all flags.</strong> So, it is syntactically correct with the following generation command:</p>
<pre><code>gen:
    export REPO_DIR=&quot;$PWD&quot;; cd /; flutter_rust_bridge_codegen {{llvm_path}} \
        --rust-input &quot;$REPO_DIR/native/src/api_orange.rs&quot; &quot;$REPO_DIR/native/src/api_apple.rs&quot; \
        --dart-output &quot;$REPO_DIR/lib/gen_api_apple.dart&quot; &quot;$REPO_DIR/lib/gen_api_orange.dart&quot; \
        --class-name ApiClassOrange ApiClassApple \
        --rust-output generated_api_apple generated_api_orange
</code></pre>
<p>NOTE: the suffix <code>apple</code> and <code>orange</code> are quite disordered for each flag here on purpose. It is compilable and usable. But as you should know, it is not a good practice, semantically. It is all up to you to decide the field names for each flag, so be beware of it!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
